<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[Hexo]]></title>
  
  <link href="/atom.xml" rel="self"/>
  <link href="http://imlzq.com/"/>
  <updated>2018-02-11T08:42:33.534Z</updated>
  <id>http://imlzq.com/</id>
  
  <author>
    <name><![CDATA[John Doe]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/08/04/Volley/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/08/04/Volley/index/</id>
    <published>2018-02-11T08:42:33.534Z</published>
    <updated>2018-02-11T08:42:33.534Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Volley总结 | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="自从15年8月使用Volley以来，感触很多，源码也过了几次，第一篇博客三级缓存 Volley /Lrucache/DiskLrucache + AndroidStudio导出jar包 + upload to github就是使用Volley结合LruCache和DiskLruCache构建的三级缓存。其实关于Volley底层的实现在以前的博客中或多或少都有提及，例如缓存，队列等等，这篇博客就对它">
<meta property="og:type" content="article">
<meta property="og:title" content="Volley总结">
<meta property="og:url" content="http://imlzq.com/2016/08/04/Volley/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="自从15年8月使用Volley以来，感触很多，源码也过了几次，第一篇博客三级缓存 Volley /Lrucache/DiskLrucache + AndroidStudio导出jar包 + upload to github就是使用Volley结合LruCache和DiskLruCache构建的三级缓存。其实关于Volley底层的实现在以前的博客中或多或少都有提及，例如缓存，队列等等，这篇博客就对它">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/699911-4f50fb7c44adb5ae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2016-08-04T16:55:14.505Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Volley总结">
<meta name="twitter:description" content="自从15年8月使用Volley以来，感触很多，源码也过了几次，第一篇博客三级缓存 Volley /Lrucache/DiskLrucache + AndroidStudio导出jar包 + upload to github就是使用Volley结合LruCache和DiskLruCache构建的三级缓存。其实关于Volley底层的实现在以前的博客中或多或少都有提及，例如缓存，队列等等，这篇博客就对它">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/699911-4f50fb7c44adb5ae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
	
  

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">CytQ</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Catch your time</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 14px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Chinese/" style="font-size: 18px;">Chinese</a> <a href="/tags/Design-Pattern/" style="font-size: 16px;">Design Pattern</a> <a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/Others/" style="font-size: 10px;">Others</a> <a href="/tags/Preface/" style="font-size: 10px;">Preface</a> <a href="/tags/Python/" style="font-size: 16px;">Python</a> <a href="/tags/Rxjava/" style="font-size: 14px;">Rxjava</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Study-Note/" style="font-size: 16px;">Study Note</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">CytQ</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">CytQ</h1>
			</hgroup>
			
			<p class="header-subtitle">Catch your time</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-Volley" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/04/Volley/" class="article-date">
  	<time datetime="2016-08-04T08:29:28.000Z" itemprop="datePublished">2016-08-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Volley总结
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Chinese/">Chinese</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>自从15年8月使用Volley以来，感触很多，源码也过了几次，第一篇博客<strong><a href="http://imlzq.com/2015/11/23/Volley-Lrucache-DiskLrucache/">三级缓存 Volley /Lrucache/DiskLrucache + AndroidStudio导出jar包 + upload to github</a></strong>就是使用Volley结合LruCache和DiskLruCache构建的三级缓存。其实关于Volley底层的实现在以前的博客中或多或少都有提及，例如缓存，队列等等，这篇博客就对它进行全方面的总结</p>
<a id="more"></a>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>首先，我们从缓存开始入手，毕竟这个算它的一个特点，也是一个优势。<br>我的第一篇博客实现三级缓存就利用的Volley的网络层缓存，LruCache的内存缓存和DiskLruCache的磁盘缓存。</p>
<p>Volley是实现了网络层缓存和内存缓存的。</p>
<h2 id="网络请求的发起流程"><a href="#网络请求的发起流程" class="headerlink" title="网络请求的发起流程"></a>网络请求的发起流程</h2><ol>
<li>检测是否开启缓存，如果开启，跳入２；不需要，加入网络队列中</li>
<li>判断是否存在该网络请求的缓存，如果存在且未过期，则直接返回该缓存结果。如果不存在，则将它加入网络队列并进入流程３<strong>【注释一】</strong></li>
<li>判断现有的网络队列中是否已经存在相同的网络请求，如果存在，则将该请求加入等待队列中，等待上一个相同请求的返回结果，也就是常说的请求合并</li>
<li>返回结果并处理</li>
</ol>
<p><img src="http://upload-images.jianshu.io/upload_images/699911-4f50fb7c44adb5ae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="volley"></p>
<p><strong>过期</strong><br>在上面的流程２也就是注释一的位置，Volley对于每一个缓存需要判断它们是否过期，而关于这个过期，则分为Softttl和ttl。</p>
<p>TTL的意思就是该缓存已经无效，必须重新从网络中获取。最终返回给调用者的是最新的那一次请求结果</p>
<p>而SoftTTL则会返回两次数据，第一次数据是本次的缓存数据，在返回该数据时也会将该网络请求加入到网络队列中，在请求数据返回后再次返给调用者。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> </span>&#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">byte</span>[] data;</span><br><span class="line">       <span class="keyword">public</span> String etag;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">long</span> serverDate;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">long</span> lastModified;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">long</span> ttl;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">long</span> softTtl;</span><br><span class="line">       <span class="keyword">public</span> Map&lt;String, String&gt; responseHeaders = Collections.emptyMap();</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">Entry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">this</span>.ttl &lt; System.currentTimeMillis();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">refreshNeeded</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">this</span>.softTtl &lt; System.currentTimeMillis();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>为什么要这么设计呢？</strong><br>个人思考：我觉得这个是对缓存的一个人性化设计。因为对于一个缓存来讲可能存在两种情况，第一种情况就是该缓存已经过期很久很久，完全不可用，所以就抛弃掉并重新获取。而软缓存就是那些过期不是特别久，也就是说在一定程度上可能还有些作用的缓存。例如现在有一个界面，刷新时可以让用户看到不久之前的信息，刷新结束后再将最新的数据呈现给用户。</p>
<h2 id="线程管理"><a href="#线程管理" class="headerlink" title="线程管理"></a>线程管理</h2><p>NetWorkDispatcher类负责从网络工作队列中取出一个请求并执行。默认情况下存在４个工作线程为他服务<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_NETWORK_THREAD_POOL_SIZE = <span class="number">4</span>;</span><br></pre></td></tr></table></figure></p>
<p>而上面从定义的名字来说，是NetWork thread pool,但是实际上它并不是使用传统的线程池来管理的，而是使用一个NetWorkDispather数组来进行管理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> NetworkDispatcher[] mDispatchers;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stop();</span><br><span class="line">        <span class="keyword">this</span>.mCacheDispatcher = <span class="keyword">new</span> CacheDispatcher(<span class="keyword">this</span>.mCacheQueue, <span class="keyword">this</span>.mNetworkQueue, <span class="keyword">this</span>.mCache, <span class="keyword">this</span>.mDelivery);</span><br><span class="line">        <span class="keyword">this</span>.mCacheDispatcher.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.mDispatchers.length; ++i) &#123;</span><br><span class="line">            NetworkDispatcher networkDispatcher = <span class="keyword">new</span> NetworkDispatcher(<span class="keyword">this</span>.mNetworkQueue, <span class="keyword">this</span>.mNetwork, <span class="keyword">this</span>.mCache, <span class="keyword">this</span>.mDelivery);</span><br><span class="line">            <span class="keyword">this</span>.mDispatchers[i] = networkDispatcher;</span><br><span class="line">            networkDispatcher.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>但是在这里就不难发现其实是存在一个问题的，因为如果工作线程发生异常退出，那么就无法生成一个新的工作线程来弥补之前这个空缺，因此这里极有可能会出现问题。当前总结的Volley版本是1.0.11，也就是第一篇博客中使用到的Volley版本，不知道现在是否已经优化</p>
<h2 id="线程优先级"><a href="#线程优先级" class="headerlink" title="线程优先级"></a>线程优先级</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Request&lt;T&gt; other)</span> </span>&#123;</span><br><span class="line">        Request.Priority left = <span class="keyword">this</span>.getPriority();</span><br><span class="line">        Request.Priority right = other.getPriority();</span><br><span class="line">        <span class="keyword">return</span> left == right?<span class="keyword">this</span>.mSequence.intValue() - other.mSequence.intValue():right.ordinal() - left.ordinal();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里的话主要就是根据每个请求的sequence来确定的，而sequence是在add的时候由进行获取，同时自增，也就是说它是由一个计数器进行管理的。也就可以保证每一次取任务取的都是队列头部的任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Request&lt;T&gt; <span class="title">add</span><span class="params">(Request&lt;T&gt; request)</span> </span>&#123;</span><br><span class="line">        request.setRequestQueue(<span class="keyword">this</span>);</span><br><span class="line">        Set var2 = <span class="keyword">this</span>.mCurrentRequests;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>.mCurrentRequests) &#123;</span><br><span class="line">            <span class="keyword">this</span>.mCurrentRequests.add(request);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        request.setSequence(<span class="keyword">this</span>.getSequenceNumber());</span><br><span class="line">        request.addMarker(<span class="string">"add-to-queue"</span>);</span><br><span class="line">        <span class="keyword">if</span>(!request.shouldCache()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.mNetworkQueue.add(request);</span><br><span class="line">            <span class="keyword">return</span> request;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Map var7 = <span class="keyword">this</span>.mWaitingRequests;</span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="keyword">this</span>.mWaitingRequests) &#123;</span><br><span class="line">                String cacheKey = request.getCacheKey();</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>.mWaitingRequests.containsKey(cacheKey)) &#123;</span><br><span class="line">                    Object stagedRequests = (Queue)<span class="keyword">this</span>.mWaitingRequests.get(cacheKey);</span><br><span class="line">                    <span class="keyword">if</span>(stagedRequests == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        stagedRequests = <span class="keyword">new</span> LinkedList();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ((Queue)stagedRequests).add(request);</span><br><span class="line">                    <span class="keyword">this</span>.mWaitingRequests.put(cacheKey, stagedRequests);</span><br><span class="line">                    <span class="keyword">if</span>(VolleyLog.DEBUG) &#123;</span><br><span class="line">                        VolleyLog.v(<span class="string">"Request for cacheKey=%s is in flight, putting on hold."</span>, <span class="keyword">new</span> Object[]&#123;cacheKey&#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.mWaitingRequests.put(cacheKey, (Object)<span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">this</span>.mCacheQueue.add(request);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> request;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSequenceNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.mSequenceGenerator.incrementAndGet();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里需要注意一下，优先级高只是说明它先发出，并不能够确保它一定先返回</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Volley适合的请求为“短，小，快”，也就是说它并不适合大文件的下载操作，这是因为它存在一个内存缓存，100M的文件直接给你缓存到内存中，这样的体验就不是特别好。而如果单纯的把缓存关闭掉的话，就不如使用Retrofit + OKHttp了<br>上面还有一些超时重发请求，反序列化操作未总结，因为觉得这个不算什么吧，因此就此略过，而他们的使用其实也是可以自己再二次封装一下的，这样就可以让原来已经很简洁的代码变得更简洁</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/08/06/principle-gson/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          GSon原理解析
        
      </div>
    </a>
  
  
    <a href="/2016/07/30/HotFix/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">热点修复</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="Volley" data-title="Volley总结" data-url="http://imlzq.com/2016/08/04/Volley/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 CytQ
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Volley总结 | Hello ]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/08/06/principle-gson/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/08/06/principle-gson/index/</id>
    <published>2018-02-11T08:42:33.534Z</published>
    <updated>2018-02-11T08:42:33.534Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>GSon原理解析 | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="以前写了一篇关于如何使用GSon的文章: Json数据的解析_Gson
这里就对Gson的内部实现原理进行一个总结">
<meta property="og:type" content="article">
<meta property="og:title" content="GSon原理解析">
<meta property="og:url" content="http://imlzq.com/2016/08/06/principle-gson/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="以前写了一篇关于如何使用GSon的文章: Json数据的解析_Gson
这里就对Gson的内部实现原理进行一个总结">
<meta property="og:updated_time" content="2016-08-06T14:59:52.709Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GSon原理解析">
<meta name="twitter:description" content="以前写了一篇关于如何使用GSon的文章: Json数据的解析_Gson
这里就对Gson的内部实现原理进行一个总结">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
	
  

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">CytQ</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Catch your time</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 14px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Chinese/" style="font-size: 18px;">Chinese</a> <a href="/tags/Design-Pattern/" style="font-size: 16px;">Design Pattern</a> <a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/Others/" style="font-size: 10px;">Others</a> <a href="/tags/Preface/" style="font-size: 10px;">Preface</a> <a href="/tags/Python/" style="font-size: 16px;">Python</a> <a href="/tags/Rxjava/" style="font-size: 14px;">Rxjava</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Study-Note/" style="font-size: 16px;">Study Note</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">CytQ</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">CytQ</h1>
			</hgroup>
			
			<p class="header-subtitle">Catch your time</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-principle-gson" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/06/principle-gson/" class="article-date">
  	<time datetime="2016-08-06T14:19:56.000Z" itemprop="datePublished">2016-08-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      GSon原理解析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Chinese/">Chinese</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>以前写了一篇关于如何使用GSon的文章: <a href="http://imlzq.com/2015/12/07/gson/">Json数据的解析_Gson</a></p>
<p>这里就对Gson的内部实现原理进行一个总结</p>
<a id="more"></a>
<h2 id="创建方法"><a href="#创建方法" class="headerlink" title="创建方法"></a>创建方法</h2><p>Gson可以由两种方式创建，一种是通过Gson.Builder()的方式，另一种则是通过new Gson()来创建。</p>
<p>那这两种创建方式有什么不同呢？</p>
<p>第一种Gson.Builder()的方法没有使用反射，而new Gson()是使用了反射的。</p>
<p>在Gson内部存在着TypeAdapter，也就是根据不同的类型来适配，党我们使用Gson.Builder()创建时，使用的是自定义的TypeAdapter而不是默认的TypeAdapter，因此也就出现了一个为反射，一个不是反射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">Gson(Excluder excluder, FieldNamingStrategy fieldNamingPolicy, Map&lt;Type, InstanceCreator&lt;?&gt;&gt; instanceCreators, <span class="keyword">boolean</span> serializeNulls, <span class="keyword">boolean</span> complexMapKeySerialization, <span class="keyword">boolean</span> generateNonExecutableGson, <span class="keyword">boolean</span> htmlSafe, <span class="keyword">boolean</span> prettyPrinting, <span class="keyword">boolean</span> serializeSpecialFloatingPointValues, LongSerializationPolicy longSerializationPolicy, List&lt;TypeAdapterFactory&gt; typeAdapterFactories) &#123;</span><br><span class="line">        <span class="keyword">this</span>.calls = <span class="keyword">new</span> ThreadLocal();</span><br><span class="line">        <span class="keyword">this</span>.typeTokenCache = Collections.synchronizedMap(<span class="keyword">new</span> HashMap());</span><br><span class="line">        <span class="keyword">this</span>.deserializationContext = <span class="keyword">new</span> JsonDeserializationContext() &#123;</span><br><span class="line">            <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">deserialize</span><span class="params">(JsonElement json, Type typeOfT)</span> <span class="keyword">throws</span> JsonParseException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Gson.<span class="keyword">this</span>.fromJson(json, typeOfT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">this</span>.serializationContext = <span class="keyword">new</span> JsonSerializationContext() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> JsonElement <span class="title">serialize</span><span class="params">(Object src)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Gson.<span class="keyword">this</span>.toJsonTree(src);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> JsonElement <span class="title">serialize</span><span class="params">(Object src, Type typeOfSrc)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Gson.<span class="keyword">this</span>.toJsonTree(src, typeOfSrc);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">this</span>.constructorConstructor = <span class="keyword">new</span> ConstructorConstructor(instanceCreators);</span><br><span class="line">        <span class="keyword">this</span>.serializeNulls = serializeNulls;</span><br><span class="line">        <span class="keyword">this</span>.generateNonExecutableJson = generateNonExecutableGson;</span><br><span class="line">        <span class="keyword">this</span>.htmlSafe = htmlSafe;</span><br><span class="line">        <span class="keyword">this</span>.prettyPrinting = prettyPrinting;</span><br><span class="line">        ArrayList factories = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        factories.add(TypeAdapters.JSON_ELEMENT_FACTORY);</span><br><span class="line">        factories.add(ObjectTypeAdapter.FACTORY);</span><br><span class="line">        factories.add(excluder);</span><br><span class="line">        factories.addAll(typeAdapterFactories);</span><br><span class="line">        factories.add(TypeAdapters.STRING_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.INTEGER_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.BOOLEAN_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.BYTE_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.SHORT_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.newFactory(Long.TYPE, Long.class, <span class="keyword">this</span>.longAdapter(longSerializationPolicy)));</span><br><span class="line">        factories.add(TypeAdapters.newFactory(Double.TYPE, Double.class, <span class="keyword">this</span>.doubleAdapter(serializeSpecialFloatingPointValues)));</span><br><span class="line">        factories.add(TypeAdapters.newFactory(Float.TYPE, Float.class, <span class="keyword">this</span>.floatAdapter(serializeSpecialFloatingPointValues)));</span><br><span class="line">        factories.add(TypeAdapters.NUMBER_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.CHARACTER_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.STRING_BUILDER_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.STRING_BUFFER_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.newFactory(BigDecimal.class, TypeAdapters.BIG_DECIMAL));</span><br><span class="line">        factories.add(TypeAdapters.newFactory(BigInteger.class, TypeAdapters.BIG_INTEGER));</span><br><span class="line">        factories.add(TypeAdapters.URL_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.URI_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.UUID_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.LOCALE_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.INET_ADDRESS_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.BIT_SET_FACTORY);</span><br><span class="line">        factories.add(DateTypeAdapter.FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.CALENDAR_FACTORY);</span><br><span class="line">        factories.add(TimeTypeAdapter.FACTORY);</span><br><span class="line">        factories.add(SqlDateTypeAdapter.FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.TIMESTAMP_FACTORY);</span><br><span class="line">        factories.add(ArrayTypeAdapter.FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.ENUM_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.CLASS_FACTORY);</span><br><span class="line">        factories.add(<span class="keyword">new</span> CollectionTypeAdapterFactory(<span class="keyword">this</span>.constructorConstructor));</span><br><span class="line">        factories.add(<span class="keyword">new</span> MapTypeAdapterFactory(<span class="keyword">this</span>.constructorConstructor, complexMapKeySerialization));</span><br><span class="line">        factories.add(<span class="keyword">new</span> ReflectiveTypeAdapterFactory(<span class="keyword">this</span>.constructorConstructor, fieldNamingPolicy, excluder));</span><br><span class="line">        <span class="keyword">this</span>.factories = Collections.unmodifiableList(factories);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>那Gson如何判断我们使用的是哪一种方法创建呢？其实就是通过factories这个对象 add Factory的顺序来控制的。每次获取Adapter的时候都需要遍历Factories，而我们自定义的TypeAdapter在add时是会默认添加到靠前的位置。所以这样就避免了Gson的反射解析</p>
<h2 id="如何实现解析"><a href="#如何实现解析" class="headerlink" title="如何实现解析"></a>如何实现解析</h2><p>Gson中存在一个JsonParser类，它的作用就是将json串解析成JsonElement对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JsonElement <span class="title">parse</span><span class="params">(String json)</span> <span class="keyword">throws</span> JsonSyntaxException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.parse((Reader)(<span class="keyword">new</span> StringReader(json)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonElement <span class="title">parse</span><span class="params">(Reader json)</span> <span class="keyword">throws</span> JsonIOException, JsonSyntaxException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JsonReader e = <span class="keyword">new</span> JsonReader(json);</span><br><span class="line">            JsonElement element = <span class="keyword">this</span>.parse(e);</span><br><span class="line">            <span class="keyword">if</span>(!element.isJsonNull() &amp;&amp; e.peek() != JsonToken.END_DOCUMENT) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JsonSyntaxException(<span class="string">"Did not consume the entire document."</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> element;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedJsonException var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonSyntaxException(var4);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonIOException(var5);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonSyntaxException(var6);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonElement <span class="title">parse</span><span class="params">(JsonReader json)</span> <span class="keyword">throws</span> JsonIOException, JsonSyntaxException </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> lenient = json.isLenient();</span><br><span class="line">        json.setLenient(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        JsonElement e;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            e = Streams.parse(json);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (StackOverflowError var8) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonParseException(<span class="string">"Failed parsing JSON source: "</span> + json + <span class="string">" to Json"</span>, var8);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OutOfMemoryError var9) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonParseException(<span class="string">"Failed parsing JSON source: "</span> + json + <span class="string">" to Json"</span>, var9);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            json.setLenient(lenient);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>注意上面的第三个方法，里面实际上返回的是Stream.parse(json)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JsonElement <span class="title">parse</span><span class="params">(JsonReader reader)</span> <span class="keyword">throws</span> JsonParseException </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isEmpty = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            reader.peek();</span><br><span class="line">            isEmpty = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> (JsonElement)TypeAdapters.JSON_ELEMENT.read(reader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (EOFException var3) &#123;</span><br><span class="line">            <span class="keyword">if</span>(isEmpty) &#123;</span><br><span class="line">                <span class="keyword">return</span> JsonNull.INSTANCE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JsonSyntaxException(var3);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedJsonException var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonSyntaxException(var4);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonIOException(var5);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonSyntaxException(var6);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里又返回了TypeAdapters.JSON_ELEMENT.read(reader)方法，那我们就来看看read方法又返回了什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JsonElement <span class="title">read</span><span class="params">(JsonReader in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(TypeAdapters.SyntheticClass_1.$SwitchMap$com$google$gson$stream$JsonToken[in.peek().ordinal()]) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    String number = in.nextString();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> JsonPrimitive(<span class="keyword">new</span> LazilyParsedNumber(number));</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> JsonPrimitive(Boolean.valueOf(in.nextBoolean()));</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> JsonPrimitive(in.nextString());</span><br><span class="line">                <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                    in.nextNull();</span><br><span class="line">                    <span class="keyword">return</span> JsonNull.INSTANCE;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                    JsonArray array = <span class="keyword">new</span> JsonArray();</span><br><span class="line">                    in.beginArray();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(in.hasNext()) &#123;</span><br><span class="line">                        array.add(<span class="keyword">this</span>.read(in));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    in.endArray();</span><br><span class="line">                    <span class="keyword">return</span> array;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                    JsonObject object = <span class="keyword">new</span> JsonObject();</span><br><span class="line">                    in.beginObject();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(in.hasNext()) &#123;</span><br><span class="line">                        object.add(in.nextName(), <span class="keyword">this</span>.read(in));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    in.endObject();</span><br><span class="line">                    <span class="keyword">return</span> object;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>从这上面的case我们不难看出，这里实际上就是根据不同的数据类型进行不同的数据解析。例如case 6,针对的是一个object类型，也就获取它的name和value放入object中，case 5则是针对的Array类型。</p>
<p>所以实际上就是解析Json，然后返回一个调用者想要的对象</p>
<h2 id="一句话总结"><a href="#一句话总结" class="headerlink" title="一句话总结"></a>一句话总结</h2><p>两种创建方式，区别在于一个是反射一个不是反射。如果想要避免使用反射，自定义TypeAdapter即可，factories会自动将其添加到list的前面，当使用时就会优先遍历到指定的adapter。<br>JsonParser对Json串进行解析处理，根据对应的数据类型最终返回给用户一个指定的对象。这也就是我们创建一个对象实体类的原因</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/08/04/Volley/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Volley总结</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="principle-gson" data-title="GSon原理解析" data-url="http://imlzq.com/2016/08/06/principle-gson/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 CytQ
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>GSon原理解析 | Hello ]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/07/29/classloaders/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/07/29/classloaders/index/</id>
    <published>2018-02-11T08:42:33.533Z</published>
    <updated>2018-02-11T08:42:33.533Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>关于Android和Java的ClassLoader相关知识盘点 | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="已经很久没有写博客，就再利用这段时间把该以前总结过的又再总结一次吧，好多东西光记在脑子里也不行。那首先就用Android的ClassLoader开个头，接着就再总结一下Volley, Retrofit, OKHttp, Rxjava, HashMap，Gson,Fresco，动态加载，热点修复以及算法吧。">
<meta property="og:type" content="article">
<meta property="og:title" content="关于Android和Java的ClassLoader相关知识盘点">
<meta property="og:url" content="http://imlzq.com/2016/07/29/classloaders/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="已经很久没有写博客，就再利用这段时间把该以前总结过的又再总结一次吧，好多东西光记在脑子里也不行。那首先就用Android的ClassLoader开个头，接着就再总结一下Volley, Retrofit, OKHttp, Rxjava, HashMap，Gson,Fresco，动态加载，热点修复以及算法吧。">
<meta property="og:updated_time" content="2016-08-06T07:23:20.164Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="关于Android和Java的ClassLoader相关知识盘点">
<meta name="twitter:description" content="已经很久没有写博客，就再利用这段时间把该以前总结过的又再总结一次吧，好多东西光记在脑子里也不行。那首先就用Android的ClassLoader开个头，接着就再总结一下Volley, Retrofit, OKHttp, Rxjava, HashMap，Gson,Fresco，动态加载，热点修复以及算法吧。">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
	
  

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">CytQ</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Catch your time</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 14px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Chinese/" style="font-size: 18px;">Chinese</a> <a href="/tags/Design-Pattern/" style="font-size: 16px;">Design Pattern</a> <a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/Others/" style="font-size: 10px;">Others</a> <a href="/tags/Preface/" style="font-size: 10px;">Preface</a> <a href="/tags/Python/" style="font-size: 16px;">Python</a> <a href="/tags/Rxjava/" style="font-size: 14px;">Rxjava</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Study-Note/" style="font-size: 16px;">Study Note</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">CytQ</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">CytQ</h1>
			</hgroup>
			
			<p class="header-subtitle">Catch your time</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-classloaders" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/29/classloaders/" class="article-date">
  	<time datetime="2016-07-29T15:33:56.000Z" itemprop="datePublished">2016-07-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      关于Android和Java的ClassLoader相关知识盘点
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Chinese/">Chinese</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>已经很久没有写博客，就再利用这段时间把该以前总结过的又再总结一次吧，好多东西光记在脑子里也不行。那首先就用Android的ClassLoader开个头，接着就再总结一下Volley, Retrofit, OKHttp, Rxjava, HashMap，Gson,Fresco，动态加载，热点修复以及算法吧。</p>
<a id="more"></a>
<h2 id="Java中的Classloader"><a href="#Java中的Classloader" class="headerlink" title="Java中的Classloader"></a>Java中的Classloader</h2><p><strong>分类</strong></p>
<ul>
<li>Classloader：这个类是一个抽象类，除了Bootstrap classloader之外所有的classloader都继承它</li>
<li>Bootstrap Classloader：这个加载器是由C++编写的，在Java虚拟机启动后初始化，主要负责加载核心类库。它并不是Classloader的子类，而是由JVM自己实现的一个加载器，嵌在JVM当中</li>
<li>Extension Classloader：它是由Bootstrap classloader加载而来，同时也是它的子类，由Java编写，主要负责加载扩展的Javaclass</li>
<li>System Classloader：它也是由java编写，主要负责加载应用程序自身的类</li>
</ul>
<p><strong>程序加载的流程</strong><br>当运行一个程序的时候，JVM启动，然后加载Bootstrap Classloader，该ClassLoader加载Java核心API，也就在这个时候加载了ExtClassloader和AppClassloader，之后就调用ExtClassloader去加载拓展API，最后AppClassloader加载CLASSPATH目录下定义的classes</p>
<h2 id="双亲委派模式"><a href="#双亲委派模式" class="headerlink" title="双亲委派模式"></a>双亲委派模式</h2><p>当我们需要使用到一个类时，就会加载该类（也就是动态加载）。<br>首先JVM就会使用当前线程的类加载向上递归，也就是找到它的父类，如果父类能够加载，那么就由父类来加载，依次递归，如果不能，就再下传给子类。</p>
<p><strong>为什么会存在双亲委派模式</strong><br>在Java中，我们判断两个类是不是同一个类，实际上就是判断他们两个是不是由同一个类加载器加载而来的。如果同一个类Ａ，被两个不同的加载器加载，那么就会生成两份A的字节码，而Java就会认为这两个A并不是同一个类。java判断两个类一样的条件：　classloader id + package id + class id。</p>
<p>因此，双亲委派模式的意义就出来了：为了防止内存中出现多份同样的字节码。类A和类B都想加载system类，如果没有双亲委派的话，那么它们分别使用自己的加载器去加载就会产生两份一模一样的字节码。而如果使用了双亲委派模式，首先就会尝试将System类交给Bootstrap类加载，A使用它加载完毕后，当B再来请求加载时，BootStrap就可以直接返回内存中已经加载了的System类了</p>
<p>P.S : 在开发中是否还遇到过这样的一种情况？类A想通过类型强转的方式转换为类B，但是编译报错，提示不能转换，这个其实也就是因为他们是由不同的类加载器加载而来，存在一个壁垒</p>
<h2 id="Android中的Classloader"><a href="#Android中的Classloader" class="headerlink" title="Android中的Classloader"></a>Android中的Classloader</h2><p>Android虚拟机dalvik，现在已经换成ART，也是一种虚拟机，类似于JVM，他们也都实现了双亲委派模式用来防止出现多份重复的字节码，同样由于Android自身的一些特性以及虚拟机的选择，它们是存在一些区别的</p>
<p>Android下面的字节码文件在编译完成后会再被打包成dex类的文件，同时经过dexopt的优化（优化Class文件中的各种函数表，变量表等等）形成odex文件，它本质也还是class文件，因此加载它的话肯定就需要特殊的类加载器来加载咯</p>
<p>首先，最开始也是我们的Classloader抽象类，它有一个子类叫做BaseDexClassloader，而这个类呢又是DexClassloader和PathClassloader的父类。当然同时也存在着SystemLoader, BootClassloader这些其他的加载器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseDexClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseDexClassLoader</span><span class="params">(String dexPath, File optimizedDirectory, String libraryPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> URL <span class="title">findResource</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Enumeration&lt;URL&gt; <span class="title">findResources</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findLibrary</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> Package <span class="title">getPackage</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The 'System' ClassLoader - the one that is responsible for loading</span><br><span class="line">     * classes from the classpath. It is not equal to the bootstrap class loader -</span><br><span class="line">     * that one handles the built-in classes.</span><br><span class="line">     *</span><br><span class="line">     * Because of a potential class initialization race between ClassLoader and</span><br><span class="line">     * java.lang.System, reproducible when using JDWP with "suspend=y", we defer</span><br><span class="line">     * creation of the system class loader until first use. We use a static</span><br><span class="line">     * inner class to get synchronization at init time without having to sync on</span><br><span class="line">     * every access.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@see</span> #getSystemClassLoader()</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemClassLoader</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> ClassLoader loader = ClassLoader.createSystemClassLoader();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>上面的这个是SystemClassloader，用来加载classpath中的类的。熟悉的延迟加载单例模式</p>
<h2 id="DexClassLoader"><a href="#DexClassLoader" class="headerlink" title="DexClassLoader"></a>DexClassLoader</h2><p>这个类是用来加载一些还没有被安装的字节码文件的。因此不管是动态加载还是热点修复，都是使用这个类加载器来加载从服务器获得的apk中的文件。关于动态加载和热点修复在以后的博客中会有介绍，其实本来好早之前就打算写一个动态加载的库的，github上我库都建好了，但是临时来了点事就没做了，找个时间补回来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DexClassLoader</span><span class="params">(String dexPath, String optimizedDirectory, String libraryPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>((String)<span class="keyword">null</span>, (File)<span class="keyword">null</span>, (String)<span class="keyword">null</span>, (ClassLoader)<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="PathClassloader"><a href="#PathClassloader" class="headerlink" title="PathClassloader"></a>PathClassloader</h2><p>这个类就是用来加载所有已经被安装被安装好了的字节码文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String dexPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>((String)<span class="keyword">null</span>, (File)<span class="keyword">null</span>, (String)<span class="keyword">null</span>, (ClassLoader)<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String dexPath, String libraryPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>((String)<span class="keyword">null</span>, (File)<span class="keyword">null</span>, (String)<span class="keyword">null</span>, (ClassLoader)<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/07/30/HotFix/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          热点修复
        
      </div>
    </a>
  
  
    <a href="/2016/07/19/博客迁移通知/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">博客迁移通知</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="classloaders" data-title="关于Android和Java的ClassLoader相关知识盘点" data-url="http://imlzq.com/2016/07/29/classloaders/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 CytQ
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>关于Android和Java的Cl]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/07/30/HotFix/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/07/30/HotFix/index/</id>
    <published>2018-02-11T08:42:33.533Z</published>
    <updated>2018-02-11T08:42:33.534Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>热点修复 | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Study, Note and Advance">
<meta property="og:type" content="article">
<meta property="og:title" content="热点修复">
<meta property="og:url" content="http://imlzq.com/2016/07/30/HotFix/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="Study, Note and Advance">
<meta property="og:updated_time" content="2016-07-29T17:19:40.853Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="热点修复">
<meta name="twitter:description" content="Study, Note and Advance">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
	
  

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">CytQ</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Catch your time</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 14px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Chinese/" style="font-size: 18px;">Chinese</a> <a href="/tags/Design-Pattern/" style="font-size: 16px;">Design Pattern</a> <a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/Others/" style="font-size: 10px;">Others</a> <a href="/tags/Preface/" style="font-size: 10px;">Preface</a> <a href="/tags/Python/" style="font-size: 16px;">Python</a> <a href="/tags/Rxjava/" style="font-size: 14px;">Rxjava</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Study-Note/" style="font-size: 16px;">Study Note</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">CytQ</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">CytQ</h1>
			</hgroup>
			
			<p class="header-subtitle">Catch your time</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-HotFix" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/30/HotFix/" class="article-date">
  	<time datetime="2016-07-29T17:18:59.000Z" itemprop="datePublished">2016-07-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      热点修复
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Chinese/">Chinese</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/07/19/博客迁移通知/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">博客迁移通知</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="HotFix" data-title="热点修复" data-url="http://imlzq.com/2016/07/30/HotFix/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 CytQ
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>热点修复 | Hello Mr.L]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/07/19/%E5%8D%9A%E5%AE%A2%E8%BF%81%E7%A7%BB%E9%80%9A%E7%9F%A5/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/07/19/博客迁移通知/index/</id>
    <published>2018-02-11T08:42:33.533Z</published>
    <updated>2018-02-11T08:42:33.533Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>博客迁移通知 | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="从去年11月份开始在CSDN上编写博客，到现在已经有8个多月了，中间停止过，也高产过。后来老是觉得自己管理自己的博客更方便，也更好。现正式进行博客迁移
原博客CSDN：http://blog.csdn.net/jonstank2013?viewmode=contents现博客：　imlzq.com">
<meta property="og:type" content="article">
<meta property="og:title" content="博客迁移通知">
<meta property="og:url" content="http://imlzq.com/2016/07/19/博客迁移通知/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="从去年11月份开始在CSDN上编写博客，到现在已经有8个多月了，中间停止过，也高产过。后来老是觉得自己管理自己的博客更方便，也更好。现正式进行博客迁移
原博客CSDN：http://blog.csdn.net/jonstank2013?viewmode=contents现博客：　imlzq.com">
<meta property="og:updated_time" content="2016-07-19T05:10:31.219Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="博客迁移通知">
<meta name="twitter:description" content="从去年11月份开始在CSDN上编写博客，到现在已经有8个多月了，中间停止过，也高产过。后来老是觉得自己管理自己的博客更方便，也更好。现正式进行博客迁移
原博客CSDN：http://blog.csdn.net/jonstank2013?viewmode=contents现博客：　imlzq.com">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
	
  

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">CytQ</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Catch your time</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 14px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Chinese/" style="font-size: 18px;">Chinese</a> <a href="/tags/Design-Pattern/" style="font-size: 16px;">Design Pattern</a> <a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/Others/" style="font-size: 10px;">Others</a> <a href="/tags/Preface/" style="font-size: 10px;">Preface</a> <a href="/tags/Python/" style="font-size: 16px;">Python</a> <a href="/tags/Rxjava/" style="font-size: 14px;">Rxjava</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Study-Note/" style="font-size: 16px;">Study Note</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">CytQ</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">CytQ</h1>
			</hgroup>
			
			<p class="header-subtitle">Catch your time</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-博客迁移通知" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/19/博客迁移通知/" class="article-date">
  	<time datetime="2016-07-19T04:37:32.000Z" itemprop="datePublished">2016-07-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      博客迁移通知
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Others/">Others</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>从去年11月份开始在CSDN上编写博客，到现在已经有8个多月了，中间停止过，也高产过。后来老是觉得自己管理自己的博客更方便，也更好。现正式进行博客迁移</p>
<p>原博客CSDN：<a href="http://blog.csdn.net/jonstank2013?viewmode=contents" target="_blank" rel="external">http://blog.csdn.net/jonstank2013?viewmode=contents</a><br>现博客：　imlzq.com</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/07/30/HotFix/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          热点修复
        
      </div>
    </a>
  
  
    <a href="/2016/06/08/BroadcastReceiver/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">BroadcastReceiver —— 广播全解析</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="博客迁移通知" data-title="博客迁移通知" data-url="http://imlzq.com/2016/07/19/博客迁移通知/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 CytQ
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>博客迁移通知 | Hello Mr]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/06/08/BroadcastReceiver/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/06/08/BroadcastReceiver/index/</id>
    <published>2018-02-11T08:42:33.532Z</published>
    <updated>2018-02-11T08:42:33.532Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>BroadcastReceiver —— 广播全解析 | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="广播是Android的四大组件之一，在Android的源码中也大量存在并使用了它，此外它也是一种常见的跨进程通信方式，由此可见它的重要性。
这里就对广播的底层实现进行一个解析
本文中间包含了广播的代码细节，可以直接查看最后的“一句话总结”">
<meta property="og:type" content="article">
<meta property="og:title" content="BroadcastReceiver —— 广播全解析">
<meta property="og:url" content="http://imlzq.com/2016/06/08/BroadcastReceiver/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="广播是Android的四大组件之一，在Android的源码中也大量存在并使用了它，此外它也是一种常见的跨进程通信方式，由此可见它的重要性。
这里就对广播的底层实现进行一个解析
本文中间包含了广播的代码细节，可以直接查看最后的“一句话总结”">
<meta property="og:updated_time" content="2016-08-08T08:31:09.808Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="BroadcastReceiver —— 广播全解析">
<meta name="twitter:description" content="广播是Android的四大组件之一，在Android的源码中也大量存在并使用了它，此外它也是一种常见的跨进程通信方式，由此可见它的重要性。
这里就对广播的底层实现进行一个解析
本文中间包含了广播的代码细节，可以直接查看最后的“一句话总结”">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
	
  

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">CytQ</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Catch your time</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 14px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Chinese/" style="font-size: 18px;">Chinese</a> <a href="/tags/Design-Pattern/" style="font-size: 16px;">Design Pattern</a> <a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/Others/" style="font-size: 10px;">Others</a> <a href="/tags/Preface/" style="font-size: 10px;">Preface</a> <a href="/tags/Python/" style="font-size: 16px;">Python</a> <a href="/tags/Rxjava/" style="font-size: 14px;">Rxjava</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Study-Note/" style="font-size: 16px;">Study Note</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">CytQ</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">CytQ</h1>
			</hgroup>
			
			<p class="header-subtitle">Catch your time</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-BroadcastReceiver" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/08/BroadcastReceiver/" class="article-date">
  	<time datetime="2016-06-08T07:02:48.000Z" itemprop="datePublished">2016-06-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      BroadcastReceiver —— 广播全解析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Chinese/">Chinese</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>广播是Android的四大组件之一，在Android的源码中也大量存在并使用了它，此外它也是一种常见的跨进程通信方式，由此可见它的重要性。</p>
<p>这里就对广播的底层实现进行一个解析</p>
<p><strong>本文中间包含了广播的代码细节，可以直接查看最后的“一句话总结”</strong></p>
<a id="more"></a>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><p>首先，广播可以分为动态和静态注册两种方式。</p>
<p>动态注册的含义也就是在代码中注册广播，程序关闭是无效，在同等优先级下它会比静态注册的广播先调用</p>
<p>静态注册是指在AndroidManifest文件中注册的广播，由于APK在安装时静态注册的广播的信息会被PMS扫描并被添加到系统的表中，因此它在程序关闭时依然有效，例如开机自启就是属于检测自启的动作，如果发生该广播，就会启动自身的APP</p>
<p>上面的两种分类属于大分类，又可以将他们细分为普通广播、粘性广播、有序广播等等。</p>
<p><strong>有序广播</strong><br>使用sendOrderedBroadcast发送广播，高优先级的会先收到广播，然后由它决定是否处理、下传或者是终止该广播的传递</p>
<p><strong>粘性广播</strong><br>使用sendStickyBroadcast发送广播。如果发送时当前系统中并没有对应的广播接收器，那么它仍然会驻留在系统中，一旦有对应的广播接收器注册，那么就立即发送给它。</p>
<p>而如果它发送了多条，多条都没人接收的话怎么办呢？系统就会保存最后一条广播，因为这样就可以避免粘性广播在系统中的冗余。使用removeStickyBroadcast可以移除该Intent。</p>
<p>其实广播本来就是为了解耦，而粘性广播则更加解耦，因为接收方甚至可以完全不存在，这肯定是它的一个优势</p>
<h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><p>onReceive是在主线程中被调用的，因此要注意不能在onReceive中出现耗时操作。如果一定要有，那么就最好开一个线程或者是交给service去处理</p>
<p>此外，只有当接受到了广播后，BroadcastReceiver这个类才会被实例化，不管它是动态还是静态注册的。<br>当内存不足时，receiver也会被系统回收掉，所以如果有长时间的任务，最好交给其他的来做，例如service</p>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><p><strong>动态注册</strong></p>
<ul>
<li>创建一个BroadcastReceiver</li>
<li>创建IntentFilter，并指定Action</li>
<li>registerReceiver(receivcer, intentFilter)</li>
<li>sendBroadcast(new Intent(“haha”));</li>
<li>unregisterReceiver(receiver);</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">BroadcastReceiver receiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">               Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"Receive"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line"></span><br><span class="line">       IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">       intentFilter.addAction(<span class="string">"haha"</span>);</span><br><span class="line"></span><br><span class="line">       registerReceiver(receiver, intentFilter);</span><br><span class="line"></span><br><span class="line">	sendBroadcast(<span class="keyword">new</span> Intent(<span class="string">"haha"</span>));</span><br><span class="line">	unregisterReceiver(receiver);</span><br></pre></td></tr></table></figure>
<p>这样也就完成了一个广播的动态注册，但是需要注册的一点，广播注册之后一定要记得取消，一般是在onDestory中取消，其他的根据实际情况取消也是可以的。</p>
<p><strong>静态注册</strong><br>直接在AndroidManifest文件中添加<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;receiver android:name=".MyReceiver"&gt;  </span><br><span class="line">        &lt;intent-filter&gt;  </span><br><span class="line">            &lt;action android:name="android.intent.action.MY_BROADCAST"/&gt;</span><br><span class="line">            &lt;category android:name="android.intent.category.DEFAULT" /&gt;</span><br><span class="line">        &lt;/intent-filter&gt;</span><br><span class="line">&lt;/receiver&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>我们从动态注册的广播入手</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registerReceiver(receiver, intentFilter);</span><br></pre></td></tr></table></figure>
<p>这一行代码就是注册广播，那它做了什么呢？点进去看<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(</span><br><span class="line">        BroadcastReceiver receiver, IntentFilter filter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mBase.registerReceiver(receiver, filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(</span><br><span class="line">        BroadcastReceiver receiver, IntentFilter filter,</span><br><span class="line">        String broadcastPermission, Handler scheduler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mBase.registerReceiver(receiver, filter, broadcastPermission,</span><br><span class="line">                scheduler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiverAsUser</span><span class="params">(</span><br><span class="line">        BroadcastReceiver receiver, UserHandle user, IntentFilter filter,</span><br><span class="line">        String broadcastPermission, Handler scheduler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mBase.registerReceiverAsUser(receiver, user, filter, broadcastPermission,</span><br><span class="line">                scheduler);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们就进入到了ContextWrapper文件中，而第三个方法我们暂时不用管他，因为它是被@hide标记了的，只关心前面两个方法。而前面的两个方法又分别调用了mBase也就是一个Context中对应的方法</p>
<p>对于ContextWarapper来说，它只是Context的一个代理类，也就是说它是为Context服务的，一些小工作也就是不是核心的东西Context都是交给它来做的。而一些核心工作最终又返还给Context来处理。这样就可以在一定程度上实现解耦以及工作职责的分离，Context完全不需要考虑那些它本来不需要也不想知道的事情。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Proxying implementation of Context that simply delegates all of its calls to</span><br><span class="line"> * another Context.  Can be subclassed to modify behavior without changing</span><br><span class="line"> * the original Context.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextWrapper</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br></pre></td></tr></table></figure>
<p>Context:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Intent <span class="title">registerReceiver</span><span class="params">(@Nullable BroadcastReceiver receiver,IntentFilter filter)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>我们的Context也是一个抽象类，它的具体实现是在ContextImpl中的。Context里面实际上就是一些资源的获取的工作，它还有几个子类就是Activity，Application和Service</p>
<p>ContextImpl:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(BroadcastReceiver receiver, IntentFilter filter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> registerReceiver(receiver, filter, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(BroadcastReceiver receiver, IntentFilter filter,</span><br><span class="line">        String broadcastPermission, Handler scheduler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> registerReceiverInternal(receiver, getUserId(),</span><br><span class="line">            filter, broadcastPermission, scheduler, getOuterContext());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiverAsUser</span><span class="params">(BroadcastReceiver receiver, UserHandle user,</span><br><span class="line">        IntentFilter filter, String broadcastPermission, Handler scheduler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> registerReceiverInternal(receiver, user.getIdentifier(),</span><br><span class="line">            filter, broadcastPermission, scheduler, getOuterContext());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Intent <span class="title">registerReceiverInternal</span><span class="params">(BroadcastReceiver receiver, <span class="keyword">int</span> userId,</span><br><span class="line">        IntentFilter filter, String broadcastPermission,</span><br><span class="line">        Handler scheduler, Context context)</span> </span>&#123;</span><br><span class="line">    IIntentReceiver rd = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (receiver != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span> &amp;&amp; context != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            rd = mPackageInfo.getReceiverDispatcher(</span><br><span class="line">                receiver, context, scheduler,</span><br><span class="line">                mMainThread.getInstrumentation(), <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            rd = <span class="keyword">new</span> LoadedApk.ReceiverDispatcher(</span><br><span class="line">                    receiver, context, scheduler, <span class="keyword">null</span>, <span class="keyword">true</span>).getIIntentReceiver();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ActivityManagerNative.getDefault().registerReceiver(</span><br><span class="line">                mMainThread.getApplicationThread(), mBasePackageName,</span><br><span class="line">                rd, filter, broadcastPermission, userId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>好了，这下就一目了然，我们只有两个参数的registerReceiver最终也是调用了四个参数的方法，而后面的两个参数broadcastPermission以及Handler直接被设置为空。</p>
<p>最终的一个工作都是交给registerReceiverInternal来做的。首当其冲的就是这个IIntentReceiver类，这个类是做什么的呢？它实际上就是一个binder实体，通过这个东西我们就可以实现跨进程的信息传递了.它是由ReceiveDispather来管理的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">rd = mPackageInfo.getReceiverDispatcher(</span><br><span class="line">                    receiver, context, scheduler,</span><br><span class="line">                    mMainThread.getInstrumentation(), <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> IIntentReceiver <span class="title">getReceiverDispatcher</span><span class="params">(BroadcastReceiver r,</span><br><span class="line">            Context context, Handler handler,</span><br><span class="line">            Instrumentation instrumentation, <span class="keyword">boolean</span> registered)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mReceivers) &#123;</span><br><span class="line">            LoadedApk.ReceiverDispatcher rd = <span class="keyword">null</span>;</span><br><span class="line">            ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt; map = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (registered) &#123;</span><br><span class="line">                map = mReceivers.get(context);</span><br><span class="line">                <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    rd = map.get(r);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (rd == <span class="keyword">null</span>) &#123;</span><br><span class="line">                rd = <span class="keyword">new</span> ReceiverDispatcher(r, context, handler,</span><br><span class="line">                        instrumentation, registered);</span><br><span class="line">                <span class="keyword">if</span> (registered) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        map = <span class="keyword">new</span> ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;();</span><br><span class="line">                        mReceivers.put(context, map);</span><br><span class="line">                    &#125;</span><br><span class="line">                    map.put(r, rd);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                rd.validate(context, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            rd.mForgotten = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> rd.getIIntentReceiver();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>最后，它返回了一个ActivityManagerNative.getDefault().registerReceiver()方法，继续跟进可以知道ActivityManagerNative.getDefault()实际上就是获取一个唯一的IActivityManager实例，它是一个单例模式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">     * Retrieve the system's default/global activity manager.</span><br><span class="line">     */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gDefault.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">                Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</span><br><span class="line">            &#125;</span><br><span class="line">            IActivityManager am = asInterface(b);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">                Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> am;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> T mInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> T <span class="title">create</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mInstance = create();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mInstance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么它返回的IActivityManager到底是谁呢？其实就是ActivityManagerService，简称AMS。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerService</span> <span class="keyword">extends</span> <span class="title">ActivityManagerNative</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title">Watchdog</span>.<span class="title">Monitor</span>, <span class="title">BatteryStatsImpl</span>.<span class="title">BatteryCallback</span> </span>&#123;</span><br></pre></td></tr></table></figure></p>
<p>在我的博客<strong><a href="http://imlzq.com/2016/04/12/%E6%9D%82%E8%B0%88%E2%80%94%E2%80%94Android%E4%BB%8E%E5%90%AF%E5%8A%A8%E5%88%B0%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA%8B%E6%83%85/">杂谈——Android从启动到程序运行发生的事情</a></strong>中详解介绍到了AMS的功能，它实际上就是一个管理器，管理着非常多的东西，在系统中的作用极大。所有的Activity操作都是由Activity向他发出一个申请，它进行处理（比如向Zygote发送命令创建一个新的ActivityThread）之后返给Activity，Activity再交给Instrumentation来继续完成（例如生命周期的操作），而我们的注册广播和解除注册广播也是交给它来完成的。</p>
<p>由于对应的代码有点长，这里就不贴出来了，只是总括一下它以及sendBrodcast和unregister里面完成的东西。</p>
<h2 id="一句话总结"><a href="#一句话总结" class="headerlink" title="一句话总结"></a>一句话总结</h2><p>当一个广播进行发送时，它会被发送到AMS中并由它完成广播的传递，而AMS利用Binder机制，也就是上面的IIntentReceiver将他们传递到各个应用进程，应用进程再调用recevier的onReceive()的方法，这也就完成了一次广播的传递。</p>
<p>而对于注册广播来说，存在一个LoadApk对象，这个对象里面会包含关于本APK动态注册的所有receiver的哈希表，每当我们注册一个receiver，那么他就会被添加进入这个LoadApk的哈希表中。同时在我们注册的时候会记录用户对哪些receiver感兴趣，同一个Receiver可以注册多个IntentFilter，同样的也会使用一个ReceiverList来存储所有的IntentFilter信息。</p>
<p>所以当一个消息发来的时候，AMS会合并静态注册的表以及动态注册的表，同等优先级下动态注册的receiver在靠前的位置。匹配IntentFilter并查找对应的receiver哈希表，找到该Receiver，并利用Binder机制进行分发。</p>
<p>最后再安利一个网址，<strong><a href="https://android.googlesource.com/?format=HTML" target="_blank" rel="external">https://android.googlesource.com/?format=HTML</a></strong>，有很多代码Google处于安全性并没有直接暴露给开发者，所以在AndroidStudio中并不能查看到，例如上面的IIntentReceiver，如要想要查看的话就需要科学上网到上面的这个网址</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/07/19/博客迁移通知/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          博客迁移通知
        
      </div>
    </a>
  
  
    <a href="/2016/06/07/EventsFromAndroidBootloadingToApplicationRun/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Events from Android Bootloading to application launch</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="BroadcastReceiver" data-title="BroadcastReceiver —— 广播全解析" data-url="http://imlzq.com/2016/06/08/BroadcastReceiver/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 CytQ
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>BroadcastReceiver]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/06/06/principle-gson/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/06/06/principle-gson/index/</id>
    <published>2018-02-11T08:42:33.531Z</published>
    <updated>2018-02-11T08:42:33.531Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>GSon原理解析 | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="以前写了一篇关于如何使用GSon的文章: Json数据的解析_Gson
这里就对Gson的内部实现原理进行一个总结">
<meta property="og:type" content="article">
<meta property="og:title" content="GSon原理解析">
<meta property="og:url" content="http://imlzq.com/2016/06/06/principle-gson/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="以前写了一篇关于如何使用GSon的文章: Json数据的解析_Gson
这里就对Gson的内部实现原理进行一个总结">
<meta property="og:updated_time" content="2016-08-08T08:32:49.142Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GSon原理解析">
<meta name="twitter:description" content="以前写了一篇关于如何使用GSon的文章: Json数据的解析_Gson
这里就对Gson的内部实现原理进行一个总结">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
	
  

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">CytQ</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Catch your time</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 14px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Chinese/" style="font-size: 18px;">Chinese</a> <a href="/tags/Design-Pattern/" style="font-size: 16px;">Design Pattern</a> <a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/Others/" style="font-size: 10px;">Others</a> <a href="/tags/Preface/" style="font-size: 10px;">Preface</a> <a href="/tags/Python/" style="font-size: 16px;">Python</a> <a href="/tags/Rxjava/" style="font-size: 14px;">Rxjava</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Study-Note/" style="font-size: 16px;">Study Note</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">CytQ</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">CytQ</h1>
			</hgroup>
			
			<p class="header-subtitle">Catch your time</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-principle-gson" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/06/principle-gson/" class="article-date">
  	<time datetime="2016-06-06T14:19:56.000Z" itemprop="datePublished">2016-06-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      GSon原理解析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Chinese/">Chinese</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>以前写了一篇关于如何使用GSon的文章: <a href="http://imlzq.com/2015/12/07/gson/">Json数据的解析_Gson</a></p>
<p>这里就对Gson的内部实现原理进行一个总结</p>
<a id="more"></a>
<h2 id="创建方法"><a href="#创建方法" class="headerlink" title="创建方法"></a>创建方法</h2><p>Gson可以由两种方式创建，一种是通过Gson.Builder()的方式，另一种则是通过new Gson()来创建。</p>
<p>那这两种创建方式有什么不同呢？</p>
<p>第一种Gson.Builder()的方法没有使用反射，而new Gson()是使用了反射的。</p>
<p>在Gson内部存在着TypeAdapter，也就是根据不同的类型来适配，党我们使用Gson.Builder()创建时，使用的是自定义的TypeAdapter而不是默认的TypeAdapter，因此也就出现了一个为反射，一个不是反射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">Gson(Excluder excluder, FieldNamingStrategy fieldNamingPolicy, Map&lt;Type, InstanceCreator&lt;?&gt;&gt; instanceCreators, <span class="keyword">boolean</span> serializeNulls, <span class="keyword">boolean</span> complexMapKeySerialization, <span class="keyword">boolean</span> generateNonExecutableGson, <span class="keyword">boolean</span> htmlSafe, <span class="keyword">boolean</span> prettyPrinting, <span class="keyword">boolean</span> serializeSpecialFloatingPointValues, LongSerializationPolicy longSerializationPolicy, List&lt;TypeAdapterFactory&gt; typeAdapterFactories) &#123;</span><br><span class="line">        <span class="keyword">this</span>.calls = <span class="keyword">new</span> ThreadLocal();</span><br><span class="line">        <span class="keyword">this</span>.typeTokenCache = Collections.synchronizedMap(<span class="keyword">new</span> HashMap());</span><br><span class="line">        <span class="keyword">this</span>.deserializationContext = <span class="keyword">new</span> JsonDeserializationContext() &#123;</span><br><span class="line">            <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">deserialize</span><span class="params">(JsonElement json, Type typeOfT)</span> <span class="keyword">throws</span> JsonParseException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Gson.<span class="keyword">this</span>.fromJson(json, typeOfT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">this</span>.serializationContext = <span class="keyword">new</span> JsonSerializationContext() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> JsonElement <span class="title">serialize</span><span class="params">(Object src)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Gson.<span class="keyword">this</span>.toJsonTree(src);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> JsonElement <span class="title">serialize</span><span class="params">(Object src, Type typeOfSrc)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Gson.<span class="keyword">this</span>.toJsonTree(src, typeOfSrc);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">this</span>.constructorConstructor = <span class="keyword">new</span> ConstructorConstructor(instanceCreators);</span><br><span class="line">        <span class="keyword">this</span>.serializeNulls = serializeNulls;</span><br><span class="line">        <span class="keyword">this</span>.generateNonExecutableJson = generateNonExecutableGson;</span><br><span class="line">        <span class="keyword">this</span>.htmlSafe = htmlSafe;</span><br><span class="line">        <span class="keyword">this</span>.prettyPrinting = prettyPrinting;</span><br><span class="line">        ArrayList factories = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        factories.add(TypeAdapters.JSON_ELEMENT_FACTORY);</span><br><span class="line">        factories.add(ObjectTypeAdapter.FACTORY);</span><br><span class="line">        factories.add(excluder);</span><br><span class="line">        factories.addAll(typeAdapterFactories);</span><br><span class="line">        factories.add(TypeAdapters.STRING_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.INTEGER_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.BOOLEAN_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.BYTE_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.SHORT_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.newFactory(Long.TYPE, Long.class, <span class="keyword">this</span>.longAdapter(longSerializationPolicy)));</span><br><span class="line">        factories.add(TypeAdapters.newFactory(Double.TYPE, Double.class, <span class="keyword">this</span>.doubleAdapter(serializeSpecialFloatingPointValues)));</span><br><span class="line">        factories.add(TypeAdapters.newFactory(Float.TYPE, Float.class, <span class="keyword">this</span>.floatAdapter(serializeSpecialFloatingPointValues)));</span><br><span class="line">        factories.add(TypeAdapters.NUMBER_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.CHARACTER_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.STRING_BUILDER_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.STRING_BUFFER_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.newFactory(BigDecimal.class, TypeAdapters.BIG_DECIMAL));</span><br><span class="line">        factories.add(TypeAdapters.newFactory(BigInteger.class, TypeAdapters.BIG_INTEGER));</span><br><span class="line">        factories.add(TypeAdapters.URL_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.URI_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.UUID_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.LOCALE_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.INET_ADDRESS_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.BIT_SET_FACTORY);</span><br><span class="line">        factories.add(DateTypeAdapter.FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.CALENDAR_FACTORY);</span><br><span class="line">        factories.add(TimeTypeAdapter.FACTORY);</span><br><span class="line">        factories.add(SqlDateTypeAdapter.FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.TIMESTAMP_FACTORY);</span><br><span class="line">        factories.add(ArrayTypeAdapter.FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.ENUM_FACTORY);</span><br><span class="line">        factories.add(TypeAdapters.CLASS_FACTORY);</span><br><span class="line">        factories.add(<span class="keyword">new</span> CollectionTypeAdapterFactory(<span class="keyword">this</span>.constructorConstructor));</span><br><span class="line">        factories.add(<span class="keyword">new</span> MapTypeAdapterFactory(<span class="keyword">this</span>.constructorConstructor, complexMapKeySerialization));</span><br><span class="line">        factories.add(<span class="keyword">new</span> ReflectiveTypeAdapterFactory(<span class="keyword">this</span>.constructorConstructor, fieldNamingPolicy, excluder));</span><br><span class="line">        <span class="keyword">this</span>.factories = Collections.unmodifiableList(factories);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>那Gson如何判断我们使用的是哪一种方法创建呢？其实就是通过factories这个对象 add Factory的顺序来控制的。每次获取Adapter的时候都需要遍历Factories，而我们自定义的TypeAdapter在add时是会默认添加到靠前的位置。所以这样就避免了Gson的反射解析</p>
<h2 id="如何实现解析"><a href="#如何实现解析" class="headerlink" title="如何实现解析"></a>如何实现解析</h2><p>Gson中存在一个JsonParser类，它的作用就是将json串解析成JsonElement对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JsonElement <span class="title">parse</span><span class="params">(String json)</span> <span class="keyword">throws</span> JsonSyntaxException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.parse((Reader)(<span class="keyword">new</span> StringReader(json)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonElement <span class="title">parse</span><span class="params">(Reader json)</span> <span class="keyword">throws</span> JsonIOException, JsonSyntaxException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JsonReader e = <span class="keyword">new</span> JsonReader(json);</span><br><span class="line">            JsonElement element = <span class="keyword">this</span>.parse(e);</span><br><span class="line">            <span class="keyword">if</span>(!element.isJsonNull() &amp;&amp; e.peek() != JsonToken.END_DOCUMENT) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JsonSyntaxException(<span class="string">"Did not consume the entire document."</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> element;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedJsonException var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonSyntaxException(var4);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonIOException(var5);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonSyntaxException(var6);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonElement <span class="title">parse</span><span class="params">(JsonReader json)</span> <span class="keyword">throws</span> JsonIOException, JsonSyntaxException </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> lenient = json.isLenient();</span><br><span class="line">        json.setLenient(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        JsonElement e;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            e = Streams.parse(json);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (StackOverflowError var8) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonParseException(<span class="string">"Failed parsing JSON source: "</span> + json + <span class="string">" to Json"</span>, var8);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OutOfMemoryError var9) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonParseException(<span class="string">"Failed parsing JSON source: "</span> + json + <span class="string">" to Json"</span>, var9);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            json.setLenient(lenient);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>注意上面的第三个方法，里面实际上返回的是Stream.parse(json)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JsonElement <span class="title">parse</span><span class="params">(JsonReader reader)</span> <span class="keyword">throws</span> JsonParseException </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isEmpty = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            reader.peek();</span><br><span class="line">            isEmpty = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> (JsonElement)TypeAdapters.JSON_ELEMENT.read(reader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (EOFException var3) &#123;</span><br><span class="line">            <span class="keyword">if</span>(isEmpty) &#123;</span><br><span class="line">                <span class="keyword">return</span> JsonNull.INSTANCE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JsonSyntaxException(var3);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedJsonException var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonSyntaxException(var4);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonIOException(var5);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JsonSyntaxException(var6);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里又返回了TypeAdapters.JSON_ELEMENT.read(reader)方法，那我们就来看看read方法又返回了什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JsonElement <span class="title">read</span><span class="params">(JsonReader in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(TypeAdapters.SyntheticClass_1.$SwitchMap$com$google$gson$stream$JsonToken[in.peek().ordinal()]) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    String number = in.nextString();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> JsonPrimitive(<span class="keyword">new</span> LazilyParsedNumber(number));</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> JsonPrimitive(Boolean.valueOf(in.nextBoolean()));</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> JsonPrimitive(in.nextString());</span><br><span class="line">                <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                    in.nextNull();</span><br><span class="line">                    <span class="keyword">return</span> JsonNull.INSTANCE;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                    JsonArray array = <span class="keyword">new</span> JsonArray();</span><br><span class="line">                    in.beginArray();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(in.hasNext()) &#123;</span><br><span class="line">                        array.add(<span class="keyword">this</span>.read(in));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    in.endArray();</span><br><span class="line">                    <span class="keyword">return</span> array;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                    JsonObject object = <span class="keyword">new</span> JsonObject();</span><br><span class="line">                    in.beginObject();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(in.hasNext()) &#123;</span><br><span class="line">                        object.add(in.nextName(), <span class="keyword">this</span>.read(in));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    in.endObject();</span><br><span class="line">                    <span class="keyword">return</span> object;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>从这上面的case我们不难看出，这里实际上就是根据不同的数据类型进行不同的数据解析。例如case 6,针对的是一个object类型，也就获取它的name和value放入object中，case 5则是针对的Array类型。</p>
<p>所以实际上就是解析Json，然后返回一个调用者想要的对象</p>
<h2 id="一句话总结"><a href="#一句话总结" class="headerlink" title="一句话总结"></a>一句话总结</h2><p>两种创建方式，区别在于一个是反射一个不是反射。如果想要避免使用反射，自定义TypeAdapter即可，factories会自动将其添加到list的前面，当使用时就会优先遍历到指定的adapter。<br>JsonParser对Json串进行解析处理，根据对应的数据类型最终返回给用户一个指定的对象。这也就是我们创建一个对象实体类的原因</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/06/07/EventsFromAndroidBootloadingToApplicationRun/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Events from Android Bootloading to application launch
        
      </div>
    </a>
  
  
    <a href="/2016/06/04/Volley/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Volley总结</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="principle-gson" data-title="GSon原理解析" data-url="http://imlzq.com/2016/06/06/principle-gson/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 CytQ
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>GSon原理解析 | Hello ]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/06/07/EventsFromAndroidBootloadingToApplicationRun/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/06/07/EventsFromAndroidBootloadingToApplicationRun/index/</id>
    <published>2018-02-11T08:42:33.531Z</published>
    <updated>2018-02-11T08:42:33.532Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Events from Android Bootloading to application launch | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Reproduced please specify address
address: imlzq.com
PrefaceThis blog is my first English blog and it’s  translating from one of my blogs because I think if I can write some English blogs, it will mak">
<meta property="og:type" content="article">
<meta property="og:title" content="Events from Android Bootloading to application launch">
<meta property="og:url" content="http://imlzq.com/2016/06/07/EventsFromAndroidBootloadingToApplicationRun/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="Reproduced please specify address
address: imlzq.com
PrefaceThis blog is my first English blog and it’s  translating from one of my blogs because I think if I can write some English blogs, it will mak">
<meta property="og:image" content="http://gityuan.com/images/boot/android-arch1.png">
<meta property="og:updated_time" content="2016-07-18T02:42:07.448Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Events from Android Bootloading to application launch">
<meta name="twitter:description" content="Reproduced please specify address
address: imlzq.com
PrefaceThis blog is my first English blog and it’s  translating from one of my blogs because I think if I can write some English blogs, it will mak">
<meta name="twitter:image" content="http://gityuan.com/images/boot/android-arch1.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
	
  

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">CytQ</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Catch your time</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 14px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Chinese/" style="font-size: 18px;">Chinese</a> <a href="/tags/Design-Pattern/" style="font-size: 16px;">Design Pattern</a> <a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/Others/" style="font-size: 10px;">Others</a> <a href="/tags/Preface/" style="font-size: 10px;">Preface</a> <a href="/tags/Python/" style="font-size: 16px;">Python</a> <a href="/tags/Rxjava/" style="font-size: 14px;">Rxjava</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Study-Note/" style="font-size: 16px;">Study Note</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">CytQ</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">CytQ</h1>
			</hgroup>
			
			<p class="header-subtitle">Catch your time</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-EventsFromAndroidBootloadingToApplicationRun" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/07/EventsFromAndroidBootloadingToApplicationRun/" class="article-date">
  	<time datetime="2016-06-07T09:24:27.000Z" itemprop="datePublished">2016-06-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Events from Android Bootloading to application launch
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/English/">English</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Reproduced please specify address</p>
<p>address: <a href="http://imlzq.com">imlzq.com</a></p>
<h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>This blog is my first English blog and it’s  translating from one of my blogs because I think if I can write some English blogs, it will make my English ability better. Native blog is <a href="http://imlzq.com">imlzq.com</a></p>
<p>This blog notes what things happened from the Android System starts to user clicks icon to launch the specify app. And it contains many relate points as well, like the JVM, the Context, handler looper message queue and so on.</p>
<p>But some details about the system is not in this blog because it’s useless for my current tech stage. Maybe I will study deeply in it later.</p>
<p><strong>It’s not finished yet. I will finish the translation at the next and fix some grammatical and language errors </strong></p>
<a id="more"></a>
<h2 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h2><p>We know that the Android is a OS based on the LinuxOS and it can separate into five layers. This is the framework picture. Just remember it because we will discuss many points with these frameworks, like the System Server</p>
<p><img src="http://gityuan.com/images/boot/android-arch1.png" alt="frameworklayerpic"></p>
<p>Five layers are application layer, application framework layer, libraries layer, Android Runtime layer and the Linux Kernel layer.</p>
<p>And the Linux system launch process is BootLoader -&gt; init kernel -&gt; ….. others</p>
<p>After the system initing the kernel, a very important process will be launched which is called init process.It’s the forefather for all processes. </p>
<p>In Linux, all processes are forked by init process directly or indirectly. But in Android, it has some changes that is init process will fork a Java process which is called Zygote to fork other java processes, like the system server. Because we know that init process is a C process and the Android is based on Java. So init process forks a java process to fork other java processes, I guess :) <strong> [BreakPoint1] </strong></p>
<p>I will talk some important objects and conceptions at this place. Then I’ll continue the break point 1</p>
<ul>
<li>ActivityManagerServices(AMS): It’s a server object and responsible for all activies’ lifecycle. <strong> ActivityThread will contact them with Binder and AMS contact Zygote with Socket (IPC will summed up later) </strong></li>
<li>ActivityThread: It’s the UI/Main process and the entrance of an application is in the ActivityThread.main(). The main function will be called when the application launched. It will init some objects and open a <strong> message loop queue (summed it up later) </strong>.After that, the program will enter a endless loop by calling Looper.loop. If there are any messages here, handle it. If no, just wait. It’s a typical EDT.</li>
<li>ApplicationThread: It implements the IBinder interface and it’s the interface between server and client <strong> Curious about the server and client in android? summed it up later </strong> And it’s the inner classes in ActivityThread so that it can bind ActivityThread with AMS.</li>
<li>Instrumentation: This object I think it’s a tool class of ActivityThread and all the lifecycle of activity will handled by it, like the onCreate(), onStart() and so on.</li>
</ul>
<p><strong> Server and Client in android </strong></p>
<p>Actually there are server and client in android as well. Server means all system servers that used by apps, like the AMS, PackageManagerService and so on. All apps can use these system servers. When one of apps want to make some operations, some specify system server will get the notification.</p>
<h2 id="Continue-BreakPoint1"><a href="#Continue-BreakPoint1" class="headerlink" title="Continue BreakPoint1"></a>Continue BreakPoint1</h2><p>Zygote will fork an important system server process while it’s in the initializtion. It’s important like the Zygote so please remember it. It belongs to the application framework layer and all servers in android will forked by it.</p>
<p>When the application start the system server process, the AMS will be inited and application will load the local system server libraries, create the system context, create ActivityThread and start other servers as well. After this, the Launcher application which is an system application will be launched to finish the loading of UI and show layouts.<br><strong> BreakPoint2 </strong></p>
<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><p>Context is an abstract class. This is its source code and get it from the android source code.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Interface to global information about an application environment.  This is</span><br><span class="line"> * an abstract class whose implementation is provided by</span><br><span class="line"> * the Android system.  It</span><br><span class="line"> * allows access to application-specific resources and classes, as well as</span><br><span class="line"> * up-calls for application-level operations such as launching activities,</span><br><span class="line"> * broadcasting and receiving intents, etc.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br></pre></td></tr></table></figure>
<p>From this code, we can know that context is a global information interface. We can get some application-specific resources and classes</p>
<p>My understanding is : Context has three implementation classes, such as Application, Activity, Service. And we can do permission things by context. Actually I think it’s just a run environment.</p>
<p><strong> Notice </strong></p>
<p>Many places in android are used context so that we must notice some problem about the memory leak caused by context.</p>
<p>E.g:<br> The context in the Toast.makeText function should be setted into application context. If not,we finish the activity when it’s showing the toast, it’ll cause the memory leak because the toast still has the reference of activity so that the activity won’t be recycled. That is memory leak.</p>
<h2 id="Summary-of-toast"><a href="#Summary-of-toast" class="headerlink" title="Summary of toast"></a>Summary of toast</h2><p>I summed the toast up above this sentence. Actually the toast is an interesting widget as well because the show function in it is not just show something simply.</p>
<p>Toast is a queue actually and the show function will add the new mission into the queue. If there are any messages in queue, the message will get out to use. The length of toast queue maybe is 40 (I didn’t found the source code about the length of queue and I think I don’t have any necessary to find it as well. So just search it online and the result is this. I’m not sure).</p>
<p>So we just need to notice the show function. The function will put the message into the queue rather than show the message.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">     * Show the view for the specified duration.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mNextView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"setView must have been called"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        INotificationManager service = getService();</span><br><span class="line">        String pkg = mContext.getOpPackageName();</span><br><span class="line">        TN tn = mTN;</span><br><span class="line">        tn.mNextView = mNextView;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            service.enqueueToast(pkg, tn, mDuration);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="comment">// Empty</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Memory-leak-in-handler"><a href="#Memory-leak-in-handler" class="headerlink" title="Memory leak in handler"></a>Memory leak in handler</h2><p>Do you find that if you create a non-static inner handler, the android studio will mark the code highlight.</p>
<p><strong> Why? </strong><br>Because it will product a memory leak.</p>
<p><strong> Why? </strong><br>Because every non-static inner class will hold a reference of outer class in java. If we finish the activity without unbind with this handler, it will product an memory leak.</p>
<p><strong> How to fix it? </strong><br>Use the static handler so that the handler becomes a static inner class. And use a weakrefence to hold the outer class object. If the outer class finish or destory, the GC will recycle the weakrefence.</p>
<h2 id="Garbage-collection"><a href="#Garbage-collection" class="headerlink" title="Garbage collection"></a>Garbage collection</h2><p>You can see it from my last blog but it’s in Chinese now. I didn’t translate it into English yet.<br>Address: <a href="http://blog.csdn.net/jonstank2013/article/details/50922958" target="_blank" rel="external">JVM原理及底层探索</a></p>
<h2 id="Four-kind-references"><a href="#Four-kind-references" class="headerlink" title="Four kind references"></a>Four kind references</h2><p>I will talk something about the reference because we tolk about the weak reference before.</p>
<ul>
<li>Strong reference: GC won’t recycle a strong reference object, even OOM. All new objects are strong reference.</li>
<li>Soft reference: GC will recycle them when the memory is not enough. It will exist in other situations.</li>
<li>Weak reference: It looks like the soft reference but weaker. GC will recycle them as long as find them.The life cycle is shorter than soft reference.But the time that GC finds the weak reference maybe is not in time. So maybe it can live for a while unitil GC finds it.</li>
<li>Phantom reference: It’s different from other references. The understanding of mine is if an object has a phantom reference, programmer can do some work before recycled because the phantom reference must work with a reference queue. The object which has a phantom reference will be putted into the reference queue before recycled when GC finds it. And if the programmer finds the queue has the phantom reference, it will know the reference object will be recycled soon so that we can do some pre-work.</li>
</ul>
<h2 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h2><p>ClassLoader can separate three kinds from the top to the bottom that are Bootstrap ClassLoader, Extension ClassLoader and Application ClassLoader.</p>
<p>We judge two classes are a same class or not by judging them are loaded by a same classloader or not.</p>
<p><strong> Parent assignment model </strong></p>
<p>This model means all class loader must own a parent class loader except the Bootstrap ClassLoader. When a class need to loaded, the parent classloader will try to load it first. If the parent can not load it, the sub classloader will try to load it.</p>
<p>Advantage: the memory won’t have many byte codes which are same in this way.</p>
<p>For example, Class A and Class B need to load system class.If not use the parent assignment model, class A will load it and class B will load it again so that there are two same system byte code in the memory. But if we use the model, classes will send the mission to their parent first and Bootstrap will try to load it. So the next time class B want to load  the system class, the bootstrap classloader will return the system which is in the memory rather than loading it again.</p>
<h2 id="Lazy-load-module-Singleton-module"><a href="#Lazy-load-module-Singleton-module" class="headerlink" title="Lazy load module : Singleton module"></a>Lazy load module : Singleton module</h2><p>The class will be loaded when it will be used for java and default it will synchronize at that time so we can use the lazy load module to do some interesting things, like the singleton module.</p>
<p>Please see my blog about the singleton module, it’s in Chinese. Address is : <a href="http://blog.csdn.net/jonstank2013/article/details/50903830" target="_blank" rel="external">设计模式_单例模式</a></p>
<p>Actually I think the best singleton module is the lazy loading module in android. Maybe the enumeration is better in java but in android, the system consume  is double of static. So I suggest you use the lazy loading module to build a singleton class.</p>
<p><strong> Point </strong><br>If you use the singleton module, you need to notice the effection of serialize and deserialize because they have the toppest permission in java. They can call all functions even if they’re in private. So you need to rewrite the readResolve function and make it return the same object as well.If not, it will exist two same objects after the deserialize by call the constructor functino again.</p>
<p>Just see it in my blog.</p>
<h2 id="Continue-BreakPoint2"><a href="#Continue-BreakPoint2" class="headerlink" title="Continue BreakPoint2"></a>Continue BreakPoint2</h2><p>I note too much other knowledge above. So let’s do our main work first.</p>
<p>In the breakpoint2, we already finished the launching of androidOS and its initialization.So we can talk some events which are from user clicks the app icon to App onCreate().</p>
<p>When we click the screen, the positive electrode will touch with negative electrode so it will create a voltage.Actually we don’t use the kind of screen as I said but I think the principle it is the same.When the voltage exists, the system can get the x,y coordinates by drivers.Of course it will D/A first. So the OS can judge the x,y is in an app icon or widgets range or not. If yes, call the specify listener to handle it. If no, do some other things.</p>
<p>If the os thinks user clicks an app, the Launcher application will launch it. <strong> [BreakPoint3] </strong></p>
<h2 id="Launcher"><a href="#Launcher" class="headerlink" title="Launcher"></a>Launcher</h2><h2 id="Not-finished-yet-The-next-time-I-will-finish-the-translation"><a href="#Not-finished-yet-The-next-time-I-will-finish-the-translation" class="headerlink" title="Not finished yet.The next time I will finish the translation"></a>Not finished yet.The next time I will finish the translation</h2>
      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/06/08/BroadcastReceiver/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          BroadcastReceiver —— 广播全解析
        
      </div>
    </a>
  
  
    <a href="/2016/06/06/principle-gson/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">GSon原理解析</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="EventsFromAndroidBootloadingToApplicationRun" data-title="Events from Android Bootloading to application launch" data-url="http://imlzq.com/2016/06/07/EventsFromAndroidBootloadingToApplicationRun/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 CytQ
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Events from Andro]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/05/29/classloaders/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/05/29/classloaders/index/</id>
    <published>2018-02-11T08:42:33.530Z</published>
    <updated>2018-02-11T08:42:33.530Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>关于Android和Java的ClassLoader相关知识盘点 | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="已经很久没有写博客，就再利用这段时间把该以前总结过的又再总结一次吧，好多东西光记在脑子里也不行。那首先就用Android的ClassLoader开个头，接着就再总结一下Volley, Retrofit, OKHttp, Rxjava, HashMap，Gson,Fresco，动态加载，热点修复以及算法吧。">
<meta property="og:type" content="article">
<meta property="og:title" content="关于Android和Java的ClassLoader相关知识盘点">
<meta property="og:url" content="http://imlzq.com/2016/05/29/classloaders/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="已经很久没有写博客，就再利用这段时间把该以前总结过的又再总结一次吧，好多东西光记在脑子里也不行。那首先就用Android的ClassLoader开个头，接着就再总结一下Volley, Retrofit, OKHttp, Rxjava, HashMap，Gson,Fresco，动态加载，热点修复以及算法吧。">
<meta property="og:updated_time" content="2016-08-08T08:33:58.795Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="关于Android和Java的ClassLoader相关知识盘点">
<meta name="twitter:description" content="已经很久没有写博客，就再利用这段时间把该以前总结过的又再总结一次吧，好多东西光记在脑子里也不行。那首先就用Android的ClassLoader开个头，接着就再总结一下Volley, Retrofit, OKHttp, Rxjava, HashMap，Gson,Fresco，动态加载，热点修复以及算法吧。">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
	
  

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">CytQ</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Catch your time</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 14px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Chinese/" style="font-size: 18px;">Chinese</a> <a href="/tags/Design-Pattern/" style="font-size: 16px;">Design Pattern</a> <a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/Others/" style="font-size: 10px;">Others</a> <a href="/tags/Preface/" style="font-size: 10px;">Preface</a> <a href="/tags/Python/" style="font-size: 16px;">Python</a> <a href="/tags/Rxjava/" style="font-size: 14px;">Rxjava</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Study-Note/" style="font-size: 16px;">Study Note</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">CytQ</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">CytQ</h1>
			</hgroup>
			
			<p class="header-subtitle">Catch your time</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-classloaders" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/29/classloaders/" class="article-date">
  	<time datetime="2016-05-29T15:33:56.000Z" itemprop="datePublished">2016-05-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      关于Android和Java的ClassLoader相关知识盘点
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Chinese/">Chinese</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>已经很久没有写博客，就再利用这段时间把该以前总结过的又再总结一次吧，好多东西光记在脑子里也不行。那首先就用Android的ClassLoader开个头，接着就再总结一下Volley, Retrofit, OKHttp, Rxjava, HashMap，Gson,Fresco，动态加载，热点修复以及算法吧。</p>
<a id="more"></a>
<h2 id="Java中的Classloader"><a href="#Java中的Classloader" class="headerlink" title="Java中的Classloader"></a>Java中的Classloader</h2><p><strong>分类</strong></p>
<ul>
<li>Classloader：这个类是一个抽象类，除了Bootstrap classloader之外所有的classloader都继承它</li>
<li>Bootstrap Classloader：这个加载器是由C++编写的，在Java虚拟机启动后初始化，主要负责加载核心类库。它并不是Classloader的子类，而是由JVM自己实现的一个加载器，嵌在JVM当中</li>
<li>Extension Classloader：它是由Bootstrap classloader加载而来，同时也是它的子类，由Java编写，主要负责加载扩展的Javaclass</li>
<li>System Classloader：它也是由java编写，主要负责加载应用程序自身的类</li>
</ul>
<p><strong>程序加载的流程</strong><br>当运行一个程序的时候，JVM启动，然后加载Bootstrap Classloader，该ClassLoader加载Java核心API，也就在这个时候加载了ExtClassloader和AppClassloader，之后就调用ExtClassloader去加载拓展API，最后AppClassloader加载CLASSPATH目录下定义的classes</p>
<h2 id="双亲委派模式"><a href="#双亲委派模式" class="headerlink" title="双亲委派模式"></a>双亲委派模式</h2><p>当我们需要使用到一个类时，就会加载该类（也就是动态加载）。<br>首先JVM就会使用当前线程的类加载向上递归，也就是找到它的父类，如果父类能够加载，那么就由父类来加载，依次递归，如果不能，就再下传给子类。</p>
<p><strong>为什么会存在双亲委派模式</strong><br>在Java中，我们判断两个类是不是同一个类，实际上就是判断他们两个是不是由同一个类加载器加载而来的。如果同一个类Ａ，被两个不同的加载器加载，那么就会生成两份A的字节码，而Java就会认为这两个A并不是同一个类。java判断两个类一样的条件：　classloader id + package id + class id。</p>
<p>因此，双亲委派模式的意义就出来了：为了防止内存中出现多份同样的字节码。类A和类B都想加载system类，如果没有双亲委派的话，那么它们分别使用自己的加载器去加载就会产生两份一模一样的字节码。而如果使用了双亲委派模式，首先就会尝试将System类交给Bootstrap类加载，A使用它加载完毕后，当B再来请求加载时，BootStrap就可以直接返回内存中已经加载了的System类了</p>
<p>P.S : 在开发中是否还遇到过这样的一种情况？类A想通过类型强转的方式转换为类B，但是编译报错，提示不能转换，这个其实也就是因为他们是由不同的类加载器加载而来，存在一个壁垒</p>
<h2 id="Android中的Classloader"><a href="#Android中的Classloader" class="headerlink" title="Android中的Classloader"></a>Android中的Classloader</h2><p>Android虚拟机dalvik，现在已经换成ART，也是一种虚拟机，类似于JVM，他们也都实现了双亲委派模式用来防止出现多份重复的字节码，同样由于Android自身的一些特性以及虚拟机的选择，它们是存在一些区别的</p>
<p>Android下面的字节码文件在编译完成后会再被打包成dex类的文件，同时经过dexopt的优化（优化Class文件中的各种函数表，变量表等等）形成odex文件，它本质也还是class文件，因此加载它的话肯定就需要特殊的类加载器来加载咯</p>
<p>首先，最开始也是我们的Classloader抽象类，它有一个子类叫做BaseDexClassloader，而这个类呢又是DexClassloader和PathClassloader的父类。当然同时也存在着SystemLoader, BootClassloader这些其他的加载器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseDexClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseDexClassLoader</span><span class="params">(String dexPath, File optimizedDirectory, String libraryPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> URL <span class="title">findResource</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Enumeration&lt;URL&gt; <span class="title">findResources</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findLibrary</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> Package <span class="title">getPackage</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The 'System' ClassLoader - the one that is responsible for loading</span><br><span class="line">     * classes from the classpath. It is not equal to the bootstrap class loader -</span><br><span class="line">     * that one handles the built-in classes.</span><br><span class="line">     *</span><br><span class="line">     * Because of a potential class initialization race between ClassLoader and</span><br><span class="line">     * java.lang.System, reproducible when using JDWP with "suspend=y", we defer</span><br><span class="line">     * creation of the system class loader until first use. We use a static</span><br><span class="line">     * inner class to get synchronization at init time without having to sync on</span><br><span class="line">     * every access.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@see</span> #getSystemClassLoader()</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemClassLoader</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> ClassLoader loader = ClassLoader.createSystemClassLoader();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>上面的这个是SystemClassloader，用来加载classpath中的类的。熟悉的延迟加载单例模式</p>
<h2 id="DexClassLoader"><a href="#DexClassLoader" class="headerlink" title="DexClassLoader"></a>DexClassLoader</h2><p>这个类是用来加载一些还没有被安装的字节码文件的。因此不管是动态加载还是热点修复，都是使用这个类加载器来加载从服务器获得的apk中的文件。关于动态加载和热点修复在以后的博客中会有介绍，其实本来好早之前就打算写一个动态加载的库的，github上我库都建好了，但是临时来了点事就没做了，找个时间补回来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DexClassLoader</span><span class="params">(String dexPath, String optimizedDirectory, String libraryPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>((String)<span class="keyword">null</span>, (File)<span class="keyword">null</span>, (String)<span class="keyword">null</span>, (ClassLoader)<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="PathClassloader"><a href="#PathClassloader" class="headerlink" title="PathClassloader"></a>PathClassloader</h2><p>这个类就是用来加载所有已经被安装被安装好了的字节码文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String dexPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>((String)<span class="keyword">null</span>, (File)<span class="keyword">null</span>, (String)<span class="keyword">null</span>, (ClassLoader)<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String dexPath, String libraryPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>((String)<span class="keyword">null</span>, (File)<span class="keyword">null</span>, (String)<span class="keyword">null</span>, (ClassLoader)<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/06/04/Volley/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Volley总结
        
      </div>
    </a>
  
  
    <a href="/2016/04/13/个人知识点总结——Java并发/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">个人知识点总结——Java并发</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="classloaders" data-title="关于Android和Java的ClassLoader相关知识盘点" data-url="http://imlzq.com/2016/05/29/classloaders/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 CytQ
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>关于Android和Java的Cl]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/06/04/Volley/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/06/04/Volley/index/</id>
    <published>2018-02-11T08:42:33.530Z</published>
    <updated>2018-02-11T08:42:33.531Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Volley总结 | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="自从15年8月使用Volley以来，感触很多，源码也过了几次，第一篇博客三级缓存 Volley /Lrucache/DiskLrucache + AndroidStudio导出jar包 + upload to github就是使用Volley结合LruCache和DiskLruCache构建的三级缓存。其实关于Volley底层的实现在以前的博客中或多或少都有提及，例如缓存，队列等等，这篇博客就对它">
<meta property="og:type" content="article">
<meta property="og:title" content="Volley总结">
<meta property="og:url" content="http://imlzq.com/2016/06/04/Volley/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="自从15年8月使用Volley以来，感触很多，源码也过了几次，第一篇博客三级缓存 Volley /Lrucache/DiskLrucache + AndroidStudio导出jar包 + upload to github就是使用Volley结合LruCache和DiskLruCache构建的三级缓存。其实关于Volley底层的实现在以前的博客中或多或少都有提及，例如缓存，队列等等，这篇博客就对它">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/699911-4f50fb7c44adb5ae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2016-08-08T08:33:24.475Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Volley总结">
<meta name="twitter:description" content="自从15年8月使用Volley以来，感触很多，源码也过了几次，第一篇博客三级缓存 Volley /Lrucache/DiskLrucache + AndroidStudio导出jar包 + upload to github就是使用Volley结合LruCache和DiskLruCache构建的三级缓存。其实关于Volley底层的实现在以前的博客中或多或少都有提及，例如缓存，队列等等，这篇博客就对它">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/699911-4f50fb7c44adb5ae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
	
  

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">CytQ</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Catch your time</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 14px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Chinese/" style="font-size: 18px;">Chinese</a> <a href="/tags/Design-Pattern/" style="font-size: 16px;">Design Pattern</a> <a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/Others/" style="font-size: 10px;">Others</a> <a href="/tags/Preface/" style="font-size: 10px;">Preface</a> <a href="/tags/Python/" style="font-size: 16px;">Python</a> <a href="/tags/Rxjava/" style="font-size: 14px;">Rxjava</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Study-Note/" style="font-size: 16px;">Study Note</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">CytQ</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">CytQ</h1>
			</hgroup>
			
			<p class="header-subtitle">Catch your time</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-Volley" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/04/Volley/" class="article-date">
  	<time datetime="2016-06-04T08:29:28.000Z" itemprop="datePublished">2016-06-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Volley总结
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Chinese/">Chinese</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>自从15年8月使用Volley以来，感触很多，源码也过了几次，第一篇博客<strong><a href="http://imlzq.com/2015/11/23/Volley-Lrucache-DiskLrucache/">三级缓存 Volley /Lrucache/DiskLrucache + AndroidStudio导出jar包 + upload to github</a></strong>就是使用Volley结合LruCache和DiskLruCache构建的三级缓存。其实关于Volley底层的实现在以前的博客中或多或少都有提及，例如缓存，队列等等，这篇博客就对它进行全方面的总结</p>
<a id="more"></a>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>首先，我们从缓存开始入手，毕竟这个算它的一个特点，也是一个优势。<br>我的第一篇博客实现三级缓存就利用的Volley的网络层缓存，LruCache的内存缓存和DiskLruCache的磁盘缓存。</p>
<p>Volley是实现了网络层缓存和内存缓存的。</p>
<h2 id="网络请求的发起流程"><a href="#网络请求的发起流程" class="headerlink" title="网络请求的发起流程"></a>网络请求的发起流程</h2><ol>
<li>检测是否开启缓存，如果开启，跳入２；不需要，加入网络队列中</li>
<li>判断是否存在该网络请求的缓存，如果存在且未过期，则直接返回该缓存结果。如果不存在，则将它加入网络队列并进入流程３<strong>【注释一】</strong></li>
<li>判断现有的网络队列中是否已经存在相同的网络请求，如果存在，则将该请求加入等待队列中，等待上一个相同请求的返回结果，也就是常说的请求合并</li>
<li>返回结果并处理</li>
</ol>
<p><img src="http://upload-images.jianshu.io/upload_images/699911-4f50fb7c44adb5ae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="volley"></p>
<p><strong>过期</strong><br>在上面的流程２也就是注释一的位置，Volley对于每一个缓存需要判断它们是否过期，而关于这个过期，则分为Softttl和ttl。</p>
<p>TTL的意思就是该缓存已经无效，必须重新从网络中获取。最终返回给调用者的是最新的那一次请求结果</p>
<p>而SoftTTL则会返回两次数据，第一次数据是本次的缓存数据，在返回该数据时也会将该网络请求加入到网络队列中，在请求数据返回后再次返给调用者。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> </span>&#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">byte</span>[] data;</span><br><span class="line">       <span class="keyword">public</span> String etag;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">long</span> serverDate;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">long</span> lastModified;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">long</span> ttl;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">long</span> softTtl;</span><br><span class="line">       <span class="keyword">public</span> Map&lt;String, String&gt; responseHeaders = Collections.emptyMap();</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">Entry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">this</span>.ttl &lt; System.currentTimeMillis();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">refreshNeeded</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">this</span>.softTtl &lt; System.currentTimeMillis();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>为什么要这么设计呢？</strong><br>个人思考：我觉得这个是对缓存的一个人性化设计。因为对于一个缓存来讲可能存在两种情况，第一种情况就是该缓存已经过期很久很久，完全不可用，所以就抛弃掉并重新获取。而软缓存就是那些过期不是特别久，也就是说在一定程度上可能还有些作用的缓存。例如现在有一个界面，刷新时可以让用户看到不久之前的信息，刷新结束后再将最新的数据呈现给用户。</p>
<h2 id="线程管理"><a href="#线程管理" class="headerlink" title="线程管理"></a>线程管理</h2><p>NetWorkDispatcher类负责从网络工作队列中取出一个请求并执行。默认情况下存在４个工作线程为他服务<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_NETWORK_THREAD_POOL_SIZE = <span class="number">4</span>;</span><br></pre></td></tr></table></figure></p>
<p>而上面从定义的名字来说，是NetWork thread pool,但是实际上它并不是使用传统的线程池来管理的，而是使用一个NetWorkDispather数组来进行管理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> NetworkDispatcher[] mDispatchers;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stop();</span><br><span class="line">        <span class="keyword">this</span>.mCacheDispatcher = <span class="keyword">new</span> CacheDispatcher(<span class="keyword">this</span>.mCacheQueue, <span class="keyword">this</span>.mNetworkQueue, <span class="keyword">this</span>.mCache, <span class="keyword">this</span>.mDelivery);</span><br><span class="line">        <span class="keyword">this</span>.mCacheDispatcher.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.mDispatchers.length; ++i) &#123;</span><br><span class="line">            NetworkDispatcher networkDispatcher = <span class="keyword">new</span> NetworkDispatcher(<span class="keyword">this</span>.mNetworkQueue, <span class="keyword">this</span>.mNetwork, <span class="keyword">this</span>.mCache, <span class="keyword">this</span>.mDelivery);</span><br><span class="line">            <span class="keyword">this</span>.mDispatchers[i] = networkDispatcher;</span><br><span class="line">            networkDispatcher.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>但是在这里就不难发现其实是存在一个问题的，因为如果工作线程发生异常退出，那么就无法生成一个新的工作线程来弥补之前这个空缺，因此这里极有可能会出现问题。当前总结的Volley版本是1.0.11，也就是第一篇博客中使用到的Volley版本，不知道现在是否已经优化</p>
<h2 id="线程优先级"><a href="#线程优先级" class="headerlink" title="线程优先级"></a>线程优先级</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Request&lt;T&gt; other)</span> </span>&#123;</span><br><span class="line">        Request.Priority left = <span class="keyword">this</span>.getPriority();</span><br><span class="line">        Request.Priority right = other.getPriority();</span><br><span class="line">        <span class="keyword">return</span> left == right?<span class="keyword">this</span>.mSequence.intValue() - other.mSequence.intValue():right.ordinal() - left.ordinal();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里的话主要就是根据每个请求的sequence来确定的，而sequence是在add的时候由进行获取，同时自增，也就是说它是由一个计数器进行管理的。也就可以保证每一次取任务取的都是队列头部的任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Request&lt;T&gt; <span class="title">add</span><span class="params">(Request&lt;T&gt; request)</span> </span>&#123;</span><br><span class="line">        request.setRequestQueue(<span class="keyword">this</span>);</span><br><span class="line">        Set var2 = <span class="keyword">this</span>.mCurrentRequests;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>.mCurrentRequests) &#123;</span><br><span class="line">            <span class="keyword">this</span>.mCurrentRequests.add(request);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        request.setSequence(<span class="keyword">this</span>.getSequenceNumber());</span><br><span class="line">        request.addMarker(<span class="string">"add-to-queue"</span>);</span><br><span class="line">        <span class="keyword">if</span>(!request.shouldCache()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.mNetworkQueue.add(request);</span><br><span class="line">            <span class="keyword">return</span> request;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Map var7 = <span class="keyword">this</span>.mWaitingRequests;</span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="keyword">this</span>.mWaitingRequests) &#123;</span><br><span class="line">                String cacheKey = request.getCacheKey();</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>.mWaitingRequests.containsKey(cacheKey)) &#123;</span><br><span class="line">                    Object stagedRequests = (Queue)<span class="keyword">this</span>.mWaitingRequests.get(cacheKey);</span><br><span class="line">                    <span class="keyword">if</span>(stagedRequests == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        stagedRequests = <span class="keyword">new</span> LinkedList();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ((Queue)stagedRequests).add(request);</span><br><span class="line">                    <span class="keyword">this</span>.mWaitingRequests.put(cacheKey, stagedRequests);</span><br><span class="line">                    <span class="keyword">if</span>(VolleyLog.DEBUG) &#123;</span><br><span class="line">                        VolleyLog.v(<span class="string">"Request for cacheKey=%s is in flight, putting on hold."</span>, <span class="keyword">new</span> Object[]&#123;cacheKey&#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.mWaitingRequests.put(cacheKey, (Object)<span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">this</span>.mCacheQueue.add(request);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> request;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSequenceNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.mSequenceGenerator.incrementAndGet();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里需要注意一下，优先级高只是说明它先发出，并不能够确保它一定先返回</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Volley适合的请求为“短，小，快”，也就是说它并不适合大文件的下载操作，这是因为它存在一个内存缓存，100M的文件直接给你缓存到内存中，这样的体验就不是特别好。而如果单纯的把缓存关闭掉的话，就不如使用Retrofit + OKHttp了<br>上面还有一些超时重发请求，反序列化操作未总结，因为觉得这个不算什么吧，因此就此略过，而他们的使用其实也是可以自己再二次封装一下的，这样就可以让原来已经很简洁的代码变得更简洁</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/06/06/principle-gson/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          GSon原理解析
        
      </div>
    </a>
  
  
    <a href="/2016/05/29/classloaders/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">关于Android和Java的ClassLoader相关知识盘点</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="Volley" data-title="Volley总结" data-url="http://imlzq.com/2016/06/04/Volley/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 CytQ
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Volley总结 | Hello ]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/05/14/test2/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/05/14/test2/index/</id>
    <published>2018-02-11T08:42:33.529Z</published>
    <updated>2018-02-11T08:42:33.530Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Hello World | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.
Quick">
<meta property="og:type" content="article">
<meta property="og:title" content="Hello World">
<meta property="og:url" content="http://imlzq.com/2016/05/14/test2/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.
Quick">
<meta property="og:updated_time" content="2016-05-13T23:49:00.268Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hello World">
<meta name="twitter:description" content="Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.
Quick">
  
    <link rel="alternative" href="/atom.xml" title="Hello Mr.Li" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/github.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ITStudieren</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Study, Note and Advance</p>
		
	
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags">分类</a></li>
				        
							<li><a href="/大三，移动开发">关于我</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">大三，移动开发</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">ITStudieren</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/github.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">ITStudieren</h1>
			</hgroup>
			
			<p class="header-subtitle">Study, Note and Advance</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags">分类</a></li>
		        
					<li><a href="/大三，移动开发">关于我</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-test2" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/14/test2/" class="article-date">
  	<time datetime="2016-05-14T06:00:08.180Z" itemprop="datePublished">2016-05-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Hello World
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/05/14/test/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Hello World
        
      </div>
    </a>
  
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="test2" data-title="Hello World" data-url="http://imlzq.com/2016/05/14/test2/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 ITStudieren
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>



</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Hello World | Hel]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/05/14/hello-world/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/05/14/hello-world/index/</id>
    <published>2018-02-11T08:42:33.529Z</published>
    <updated>2018-02-11T08:42:33.529Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Hello World | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.
Quick">
<meta property="og:type" content="article">
<meta property="og:title" content="Hello World">
<meta property="og:url" content="http://imlzq.com/2016/05/14/hello-world/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.
Quick">
<meta property="og:updated_time" content="2016-05-14T04:17:01.648Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hello World">
<meta name="twitter:description" content="Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.
Quick">
  
    <link rel="alternative" href="/atom.xml" title="Hello Mr.Li" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/github.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ITStudieren</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Study, Note and Advance</p>
		
	
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags">分类</a></li>
				        
							<li><a href="/大三，移动开发">关于我</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">大三，移动开发</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">ITStudieren</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/github.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">ITStudieren</h1>
			</hgroup>
			
			<p class="header-subtitle">Study, Note and Advance</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags">分类</a></li>
		        
					<li><a href="/大三，移动开发">关于我</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-hello-world" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/14/hello-world/" class="article-date">
  	<time datetime="2016-05-14T06:00:08.180Z" itemprop="datePublished">2016-05-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Hello World
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/05/14/Hello-my-blog/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Hello my blog
        
      </div>
    </a>
  
  
    <a href="/2016/05/14/test/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Hello World</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="hello-world" data-title="Hello World" data-url="http://imlzq.com/2016/05/14/hello-world/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 ITStudieren
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>



</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Hello World | Hel]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/05/14/test/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/05/14/test/index/</id>
    <published>2018-02-11T08:42:33.529Z</published>
    <updated>2018-02-11T08:42:33.529Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Hello World | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.
Quick">
<meta property="og:type" content="article">
<meta property="og:title" content="Hello World">
<meta property="og:url" content="http://imlzq.com/2016/05/14/test/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.
Quick">
<meta property="og:updated_time" content="2016-05-13T23:48:46.704Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hello World">
<meta name="twitter:description" content="Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.
Quick">
  
    <link rel="alternative" href="/atom.xml" title="Hello Mr.Li" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/github.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ITStudieren</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Study, Note and Advance</p>
		
	
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags">分类</a></li>
				        
							<li><a href="/大三，移动开发">关于我</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">大三，移动开发</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">ITStudieren</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/github.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">ITStudieren</h1>
			</hgroup>
			
			<p class="header-subtitle">Study, Note and Advance</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags">分类</a></li>
		        
					<li><a href="/大三，移动开发">关于我</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-test" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/14/test/" class="article-date">
  	<time datetime="2016-05-14T06:00:08.180Z" itemprop="datePublished">2016-05-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Hello World
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/05/14/hello-world/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Hello World
        
      </div>
    </a>
  
  
    <a href="/2016/05/14/test2/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Hello World</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="test" data-title="Hello World" data-url="http://imlzq.com/2016/05/14/test/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 ITStudieren
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>



</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Hello World | Hel]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/05/14/Hello-my-blog/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/05/14/Hello-my-blog/index/</id>
    <published>2018-02-11T08:42:33.528Z</published>
    <updated>2018-02-11T08:42:33.528Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Hello World | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="欢迎来到我的博客以前都是在csdn上编写博客的，博客地址：http://write.blog.csdn.net/postlist">
<meta property="og:type" content="article">
<meta property="og:title" content="Hello World">
<meta property="og:url" content="http://imlzq.com/2016/05/14/Hello-my-blog/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="欢迎来到我的博客以前都是在csdn上编写博客的，博客地址：http://write.blog.csdn.net/postlist">
<meta property="og:updated_time" content="2016-05-14T09:33:40.750Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hello World">
<meta name="twitter:description" content="欢迎来到我的博客以前都是在csdn上编写博客的，博客地址：http://write.blog.csdn.net/postlist">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/headicon.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ITStudieren</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Study, Note and Advance</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/others/" style="font-size: 10px;">others</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">ITStudieren</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/headicon.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">ITStudieren</h1>
			</hgroup>
			
			<p class="header-subtitle">Study, Note and Advance</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-Hello-my-blog" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/14/Hello-my-blog/" class="article-date">
  	<time datetime="2016-05-14T07:03:20.000Z" itemprop="datePublished">2016-05-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Hello World
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/others/">others</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="欢迎来到我的博客"><a href="#欢迎来到我的博客" class="headerlink" title="欢迎来到我的博客"></a>欢迎来到我的博客</h1><p>以前都是在csdn上编写博客的，博客地址：<a href="http://write.blog.csdn.net/postlist" target="_blank" rel="external">http://write.blog.csdn.net/postlist</a></p>
<a id="more"></a>
<p>但是久了之后老是觉得管理很麻烦，借用别人的平台始终不是一个好方法，于是便趁着有空，买了个域名，借用github page和hexo搭建了这个博客</p>
<p>以后的时候就自己管理了，等必要的时候可能也会使用服务器加网站的方式重构吧，修改theme的时候硬是让我一个搞移动开发的摸索了半天前端的知识，还顺带过了一下js</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/05/14/Hello-my-b2log2/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Hello World
        
      </div>
    </a>
  
  
    <a href="/2016/05/14/Hello-my-blog2/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Hello World</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="Hello-my-blog" data-title="Hello World" data-url="http://imlzq.com/2016/05/14/Hello-my-blog/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 ITStudieren
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Hello World | Hel]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/05/14/Hello-my-blog2/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/05/14/Hello-my-blog2/index/</id>
    <published>2018-02-11T08:42:33.528Z</published>
    <updated>2018-02-11T08:42:33.529Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Hello World | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="欢迎来到我的博客以前都是在csdn上编写博客的，博客地址：http://write.blog.csdn.net/postlist">
<meta property="og:type" content="article">
<meta property="og:title" content="Hello World">
<meta property="og:url" content="http://imlzq.com/2016/05/14/Hello-my-blog2/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="欢迎来到我的博客以前都是在csdn上编写博客的，博客地址：http://write.blog.csdn.net/postlist">
<meta property="og:updated_time" content="2016-05-14T09:33:56.418Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hello World">
<meta name="twitter:description" content="欢迎来到我的博客以前都是在csdn上编写博客的，博客地址：http://write.blog.csdn.net/postlist">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/headicon.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ITStudieren</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Study, Note and Advance</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/others/" style="font-size: 10px;">others</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">ITStudieren</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/headicon.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">ITStudieren</h1>
			</hgroup>
			
			<p class="header-subtitle">Study, Note and Advance</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-Hello-my-blog2" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/14/Hello-my-blog2/" class="article-date">
  	<time datetime="2016-05-14T07:03:20.000Z" itemprop="datePublished">2016-05-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Hello World
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/others/">others</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="欢迎来到我的博客"><a href="#欢迎来到我的博客" class="headerlink" title="欢迎来到我的博客"></a>欢迎来到我的博客</h1><p>以前都是在csdn上编写博客的，博客地址：<a href="http://write.blog.csdn.net/postlist" target="_blank" rel="external">http://write.blog.csdn.net/postlist</a></p>
<a id="more"></a>
<p>但是久了之后老是觉得管理很麻烦，借用别人的平台始终不是一个好方法，于是便趁着有空，买了个域名，借用github page和hexo搭建了这个博客</p>
<p>以后的时候就自己管理了，等必要的时候可能也会使用服务器加网站的方式重构吧，修改theme的时候硬是让我一个搞移动开发的摸索了半天前端的知识，还顺带过了一下js</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/05/14/Hello-my-blog/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Hello World
        
      </div>
    </a>
  
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="Hello-my-blog2" data-title="Hello World" data-url="http://imlzq.com/2016/05/14/Hello-my-blog2/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 ITStudieren
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Hello World | Hel]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/05/14/Hello-my-b2log2/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/05/14/Hello-my-b2log2/index/</id>
    <published>2018-02-11T08:42:33.528Z</published>
    <updated>2018-02-11T08:42:33.528Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Hello World | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="欢迎来到我的博客以前都是在csdn上编写博客的，博客地址：http://write.blog.csdn.net/postlist">
<meta property="og:type" content="article">
<meta property="og:title" content="Hello World">
<meta property="og:url" content="http://imlzq.com/2016/05/14/Hello-my-b2log2/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="欢迎来到我的博客以前都是在csdn上编写博客的，博客地址：http://write.blog.csdn.net/postlist">
<meta property="og:updated_time" content="2016-05-14T09:34:12.818Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hello World">
<meta name="twitter:description" content="欢迎来到我的博客以前都是在csdn上编写博客的，博客地址：http://write.blog.csdn.net/postlist">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/headicon.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ITStudieren</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Study, Note and Advance</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/others/" style="font-size: 10px;">others</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">ITStudieren</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/headicon.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">ITStudieren</h1>
			</hgroup>
			
			<p class="header-subtitle">Study, Note and Advance</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-Hello-my-b2log2" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/14/Hello-my-b2log2/" class="article-date">
  	<time datetime="2016-05-14T07:03:20.000Z" itemprop="datePublished">2016-05-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Hello World
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/others/">others</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="欢迎来到我的博客"><a href="#欢迎来到我的博客" class="headerlink" title="欢迎来到我的博客"></a>欢迎来到我的博客</h1><p>以前都是在csdn上编写博客的，博客地址：<a href="http://write.blog.csdn.net/postlist" target="_blank" rel="external">http://write.blog.csdn.net/postlist</a></p>
<a id="more"></a>
<p>但是久了之后老是觉得管理很麻烦，借用别人的平台始终不是一个好方法，于是便趁着有空，买了个域名，借用github page和hexo搭建了这个博客</p>
<p>以后的时候就自己管理了，等必要的时候可能也会使用服务器加网站的方式重构吧，修改theme的时候硬是让我一个搞移动开发的摸索了半天前端的知识，还顺带过了一下js</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/05/14/Hello-my-blog/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Hello World</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="Hello-my-b2log2" data-title="Hello World" data-url="http://imlzq.com/2016/05/14/Hello-my-b2log2/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 ITStudieren
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Hello World | Hel]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/04/13/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93%E2%80%94%E2%80%94Java%E5%B9%B6%E5%8F%91/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/04/13/个人知识点总结——Java并发/index/</id>
    <published>2018-02-11T08:42:33.527Z</published>
    <updated>2018-02-11T08:42:33.527Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>个人知识点总结——Java并发 | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Java并发实在是一个很深的问题，这里只简单记录一下Java并发的知识点。水太深，如果不花大量的时间感觉完全hold不住，但是目前的精力完全不够，兴趣也不在这">
<meta property="og:type" content="article">
<meta property="og:title" content="个人知识点总结——Java并发">
<meta property="og:url" content="http://imlzq.com/2016/04/13/个人知识点总结——Java并发/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="Java并发实在是一个很深的问题，这里只简单记录一下Java并发的知识点。水太深，如果不花大量的时间感觉完全hold不住，但是目前的精力完全不够，兴趣也不在这">
<meta property="og:updated_time" content="2016-05-14T13:15:58.305Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="个人知识点总结——Java并发">
<meta name="twitter:description" content="Java并发实在是一个很深的问题，这里只简单记录一下Java并发的知识点。水太深，如果不花大量的时间感觉完全hold不住，但是目前的精力完全不够，兴趣也不在这">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
	
  

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">CytQ</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Catch your time</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 14px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Chinese/" style="font-size: 18px;">Chinese</a> <a href="/tags/Design-Pattern/" style="font-size: 16px;">Design Pattern</a> <a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/Others/" style="font-size: 10px;">Others</a> <a href="/tags/Preface/" style="font-size: 10px;">Preface</a> <a href="/tags/Python/" style="font-size: 16px;">Python</a> <a href="/tags/Rxjava/" style="font-size: 14px;">Rxjava</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Study-Note/" style="font-size: 16px;">Study Note</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">CytQ</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">CytQ</h1>
			</hgroup>
			
			<p class="header-subtitle">Catch your time</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-个人知识点总结——Java并发" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/13/个人知识点总结——Java并发/" class="article-date">
  	<time datetime="2016-04-13T09:55:08.000Z" itemprop="datePublished">2016-04-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      个人知识点总结——Java并发
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Java并发实在是一个很深的问题，这里只简单记录一下Java并发的知识点。水太深，如果不花大量的时间感觉完全hold不住，但是目前的精力完全不够，兴趣也不在这</p>
<a id="more"></a>
<p>什么是线程安全性<br>-</p>
<blockquote>
<p>某个类的行为和其规范完全一致<br>当多个线程访问某个类时，不管运行时环境采用何种调度方式或者这些线程将如何交替执行，并且在主调代码中不需要任何额外的同步或协同，这个类都能表现出正确的行为，那么就称这个类是线程安全的</p>
</blockquote>
<h2 id="原子操作-Atomic-Operation"><a href="#原子操作-Atomic-Operation" class="headerlink" title="原子操作(Atomic Operation)"></a>原子操作(Atomic Operation)</h2><p>原子操作是指不会被线程调度机制打断的操作，这种操作一旦开始，就会一直运行到结束，中间不会有任何的上下文切换，它是不可分割的。</p>
<p>举一个常见的例子：a++，这个操作就不是一个原子性的操作，那么在多个线程访问调用的时候，a的最终结果就很有可能不是我们的预期值。因为实际上a++这个操作可以分为已下三步：获取a的值，更新a的值，写回a的值。</p>
<h2 id="缓存一致性"><a href="#缓存一致性" class="headerlink" title="缓存一致性"></a>缓存一致性</h2><p>在共享内存的多处理器体系架构中，每个处理器都拥有自己的缓存，并且定期地与主内存进行协调，在不同的处理器架构中提供了不同级别的缓存一致性。</p>
<p>这个缓存一致性可以通过volatile关键字来加深理解。</p>
<h2 id="Volatile关键字"><a href="#Volatile关键字" class="headerlink" title="Volatile关键字"></a>Volatile关键字</h2><p>Volatile是一种较弱的同步机制，用来确保将变量的更新操作通知到其他线程，当把变量声明为volatile类型后，编译器与运行时都会注意到这个变量是共享的，因此不会将该变量上的操作一起重排序。volatile变量不会被缓存在寄存器或者对其他处理器不可见的地方，因此在读取volatile类型的变量时总会返回最新写入的值。<br>但是有一点是需要注意的，被volatile修饰的变量的的操作也应该是原子性的，不然同样会出先问题。<br>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Volatile <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 非原子性操作，使用volatile不能保证同步，改用Synchronized</span></span><br><span class="line">a++;</span><br></pre></td></tr></table></figure>
<p>而为什么Volatile能够实现这种功能呢？<br>这个要从它的实现原理说起，在x86处理器下通过工具获取JIT编译器生成的汇编指令来看Volatile的写操作实际上做了什么吧。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x01a3de1d</span>: movb $<span class="number">0x0</span>,<span class="number">0x1104800</span>(%esi);</span><br><span class="line"><span class="number">0x01a3de24</span>: lock addl $<span class="number">0x0</span>,(%esp);</span><br></pre></td></tr></table></figure>
<p>有Volatile变量修饰的共享变量进行写操作的时候会多第二行代码，lock指令修饰。<br>而lock指令会做什么事呢？</p>
<ul>
<li>将当前处理器缓存行的数据写回到系统内存</li>
<li>该写回内存的操作会引起在其他CPU里缓存了该内存地址的数据无效</li>
</ul>
<p>在上面介绍缓存一致性的时候提到了，在共享内存的多处理器体系架构中，每个处理器都拥有自己的缓存，并且定期地与主内存进行协调，在不同的处理器架构中提供了不同级别的缓存一致性。<br>那么这个时候也就有了下面的事情：<br>处理器为了提高处理速度，不直接和内存进行通讯，而是先将系统内存的数据读到内部缓存中再进行操作，但操作完成后不确定什么时候会写回到内存，如果对声明了Volatile变量进行些操作，JVM就会向处理器发送一条Lock前缀的指令，将这个变量所在缓存行的数据写回到系统内存。而由于缓存一致性协议，每个处理器会通过嗅探在总线上传播的数据在来检查自己缓存的值是不是国旗了，当处理器发现自己缓存行对应的内存地址被修改，就会将当前处理器的缓存行设置为无效状态。当处理器要对这个数据进行修改操作的时候，就会强制从系统内存中重新读取数据到处理器缓存里。<br>这也就是Volatile实现的原理。</p>
<h2 id="重排序"><a href="#重排序" class="headerlink" title="重排序"></a>重排序</h2><p>刚才上面总结到了重排序的概念，那什么是重排序呢？</p>
<p>简单的理解就是，当程序在执行的时候，如果JVM认为两行代码之间的结果互不影响，那么在执行的过程中可能就会产生一个乱序的结果。<br>例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">3</span>;</span><br><span class="line">b = <span class="number">4</span>;</span><br></pre></td></tr></table></figure></p>
<p>正常情况下我们会觉得a = 3肯定是比b=4先执行的，因为它在b的上面，但是实际上并不是这样，因为b的运行结果并不依赖上一行a的结果，因此JVM就能够对两行代码进行一个重排序，可能a先执行，也可能b先执行</p>
<p><strong>为什么要采用重排序？</strong><br>重排序通常是编译器或运行时环境为了优化程序性能而采取的。它可以分为两类：编译器重排序和运行时重排序。</p>
<p>顺序一致性模型：理想的模型是，各种指令执行的顺序是唯一且有序的，这个顺序就是它们被编写在代码中的顺序，与处理器或其他因素无关</p>
<p>顺序一致性模型的缺点：效率过低</p>
<p>编译器重排序的典型就是通过调整指令顺序，在不改变程序语义的前提下，尽可能的减少寄存器的读取、存储次数、充分服用寄存器的存储值。</p>
<p>假设第一条指令计算一个值赋给变量A并存放在寄存器中，第二条指令与A无关但需要占用寄存器（假设它将占用A所在的那个寄存器），第三条指令使用A的值且与第二条指令无关。那么如果按照顺序一致性模型，A在第一条指令执行过后被放入寄存器，在第二条指令执行时A不再存在，第三条指令执行时A重新被读入寄存器，而这个过程中，A的值没有发生变化。通常编译器都会交换第二和第三条指令的位置，这样第一条指令结束时A存在于寄存器中，接下来可以直接从寄存器中读取A的值，降低了重复读取的开销。</p>
<h2 id="并发时的乱序问题"><a href="#并发时的乱序问题" class="headerlink" title="并发时的乱序问题"></a>并发时的乱序问题</h2><p>上面总结的重排序可以引起乱序，同样的，在并发时对局部变量进行操作也有可能会产生乱序的问题。因为在每个线程中都拥有一个独立的栈，也就是独立的线程空间，当它运行时，会从主内存中读取该变量的值并存放到自己的线程栈中，对变量操作完成后就会把值写回主内存空间。<br>但是这里就有一个问题了，那就是变量的写回操作发生的时间并不能够确定。就算是线程A比线程B先读取数据，仍然有可能线程B先把值写回主内存，最终同样会造成一个得到的结果并不是我们想要的值。</p>
<h2 id="Happens-before（先行发生）"><a href="#Happens-before（先行发生）" class="headerlink" title="Happens-before（先行发生）"></a>Happens-before（先行发生）</h2><p>Java内存模型（JMM）为程序中所有的操作定义了一个偏序关系，称之为Happens-before。如果想要保证执行操作B的线程看到操作A的结果（无论A和B是否在同一个线程中执行），那么在A和B之间必须满足Happens-Before关系。如果两个操作时间缺乏Happens-Before关系，那么JVM可以对它们任意地重排序。</p>
<p>当一个变量被多个线程读取并且至少被一个线程写入时，如果在读写操作之间没有按照Happens-Before来排序，那么就会产生数据竞争的问题。</p>
<p>Happens-Before规则包括：</p>
<ul>
<li><strong>程序顺序规则</strong>：如果程序中操作A在操作B之前，那么在线程中A操作将在B操作之前执行</li>
<li><strong>监视器锁规则</strong>：在监视器锁上的解锁操作必须在同一个监视器锁上的加锁操作之前执行</li>
<li><strong>volatile变量规则</strong>：对volatile变量的写入操作必须在对该变量的读操作之前执行</li>
<li><strong>线程启动规则</strong>：在线程上对Thread.Start的调用必须在该县城中执行任何操作之前执行</li>
<li><strong>线程结束规则</strong>：县城中的任何操作都必须在其他线程检测到该线程已经结束之前执行，或者在Thread.join中成功返回，或者在调用THread.isAlive时返回false</li>
<li><strong>中断规则</strong>：当一个线程在另一个线程上调用interrupt时，必须在被中断线程检测到interrupt调用之前执行</li>
<li><strong>终结器规则</strong>：对象的构造函数必须在启动终结器之前执行</li>
<li><strong>传递性</strong>：操作A在B之前，B在C之前，那么A就必须在C之前执行</li>
</ul>
<p>例如线程A：y=1 -》 lock M -》 x=1 -》unlock M<br>线程B： lock M -》 i=x -》 unlock M -》 j=y</p>
<p>当两个线程使用同一个锁进行同步时，在它们之间的happens-Before关系就是：A的unlock M执行完成之后才能执行B的lock M方法，如果这两个线程是在不同的锁上进行同步的，那么就不能推断它们之间的动作顺序，因为在这两个线程的操作之间并不存在Happens-Before关系</p>
<h2 id="Lock-Synchronized-ReentrantLock（独占锁-悲观锁）"><a href="#Lock-Synchronized-ReentrantLock（独占锁-悲观锁）" class="headerlink" title="Lock / Synchronized / ReentrantLock（独占锁 / 悲观锁）"></a>Lock / Synchronized / ReentrantLock（独占锁 / 悲观锁）</h2><p><strong>Synchronized</strong><br>内置锁，当它用来修饰一个方法或者一个代码块的时候，能够保证在同一时刻最多只有一个线程执行该段代码，另一个线程必须等待当前线程执行完这个代码快以后才能执行该代码块（未执行之前，该线程被阻塞）。同时，它也是一个可重入锁（Lock均可重入）</p>
<p>但是这里有一个很关键的地方：当一个线程访问object的一个synchronized(this)同步代码块时，另一个线程仍然可以访问该object中的非synchronized(this)同步代码块。</p>
<p>之前在单例模式中总结到了双重检查锁定模式，但是由于双重检查锁定模式在一定情况下存在很严重的Bug，就没有在该博客中写出。这里就对双重检查锁定模式进行一个分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</span><br><span class="line">               <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  singleton = <span class="keyword">new</span> Singleton();</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singleton;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>因为在new Singleton()的过程中，实际上是可以分为很多步的，可大致分为三件事情：</p>
<ul>
<li>给Singleton的实例分配内存</li>
<li>调用Singleton的构造函数，初始化字段</li>
<li>将singleton对象指向分配的内存空间（singleton != null）</li>
</ul>
<p>但是，Java编译器是允许处理器乱序执行的，所有有可能让第二步和第三步乱序执行，也就是说如果在第二步被乱序（安排到了最后一步执行），当他还没执行的时候切换到了线程B，这个时候就会因为singleton已经不为null而直接跳出if判断，这样的话在我们以后的代码运行过程中使用的就是一个未经构造函数初始化的一个对象。<strong>【现在好像有在JDK层面有改进因此可以正常使用，具体的不清楚，以后再修改】</strong></p>
<p><strong>Lock</strong></p>
<p>Lock是一个接口，它里面主要包含了下面的几个方法：<br>P.S.源码里的注释太多，这里就不贴了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">Condition <span class="title">newCondition</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>Lock它与内置加锁机制不同，它提供的是一种无条件的、可轮训的、定时的以及可中断的锁获取操作，所有的加锁和解锁的方法都是显式的。</p>
<p>一句话总结：Synchronized算是Lock的简化版本，功能比之较少但是在程序执行完成后会自动释放锁，而Lock必须手动释放锁</p>
<p><strong>ReentrantLock</strong><br>ReentrantLock它实现了Lock接口，并提供了与synchronized相同的互斥性和内存可见性。<br>那为什么还要提供一种机制跟内置锁十分相似的新加锁机制呢？<br>因为内置锁在一定情况下存在局限性，例如无法中断一个正在等待获取锁的进程，或者无法在请求获取一个锁时无限地等待下去，；无法实现非阻塞结构的加锁规则。</p>
<p>而在ReentrantLock中，它可以实现轮询锁、定时锁、中断锁等多种加锁方式，这也让它的应用场景变的更多。</p>
<p>同时在性能上：如果有越多的资源被耗费在锁的管理和调度上，那么应用程序得到的资源就越少。锁的实现方式越好，就需要越少的系统调用和上下文切换，并且在共享内存总线上的内存同步通信量也越少。<br>在Java5中，ReentrantLock的性能比内置锁高了很多，但是在Java6中内置锁采取了一种类似与ReentrantLock中使用的算法来管理内置锁，有效地提高了可伸缩性，因此在Java6中，它们的吞吐量就非常接近了。</p>
<p>在公平性上，ReentrantLock可以创建一个非公平锁（默认）也可以创建一个公平锁。<br>公平锁：线程按照发出请求的顺序来获得锁（先到先得，不准插队）<br>非公平锁：当一个线程请求非公平锁时，如果在发出请求的同时该锁的状态变为可用，那么就跳过队列中所有的等待队列立刻获得锁（也就是允许插队。申请的时候锁为可用状态就直接获取）</p>
<p>而对于公平锁和非公平锁来说，它们的效率也是显而易见的：<br>公平性将由于在挂起线程和恢复线程时存在的开销而极大的降低效率。<br>而非公平性由于是在请求时锁已经为可用状态就直接获取，不需要进行什么额外的操作，因此效率更高。<br>实际上：确保被阻塞的线程能最终获得锁就已经够用了，并且实际开销也小很多。</p>
<p>当在一个激烈竞争的情况下，恢复一个被挂起的线程与这个线程真正开始运行之间存在着严重的延迟，这样的话就影响了效率。而如果我们采用非公平锁（也就是ReentrantLock的默认方式），线程A释放锁时，B被唤醒然后尝试获取锁，与此同时C也请求这个锁，那么C很有可能会在B被完全唤醒之前获得、使用以及释放这个锁。也就有可能会造成B获得锁的时刻并没有推迟，C也更早的获得了锁</p>
<p>那什么时候应该使用公平锁呢？<br>当持有锁的时间相对较长，或者请求锁的平均时间间隔较长，那么就应该使用公平锁。</p>
<p><strong>在Synchronize和ReentrantLock中如何选择</strong><br>上面总结了这么多，好像ReentrantLock的优点比Synchronize好太多，那为什么不直接取消掉Synchronize呢？我们自己该怎么选择呢？</p>
<p>Synchronize很重要的几个优点就是：</p>
<ul>
<li>无需手动释放锁，程序自动完成。如果在使用Lock的过程中忘记在finally中释放锁，那么虽然代码表面上能正式运行，但是实际上已经出了大问题，还有可能伤到其他代码。所以一般仅仅是在做一些内置锁不能完成的需求时才考虑使用ReentrantLock，例如中断锁、轮询锁等等</li>
<li>调试的问题：Synchronized在线程存储中能够给出在哪些调用帧中获得了哪些锁，并能够检测和识别发生死锁的进程。而ReentrantLock它只是一个对象，JVM不知道哪些线程持有这个。</li>
</ul>
<h2 id="非阻塞同步机制（乐观锁）"><a href="#非阻塞同步机制（乐观锁）" class="headerlink" title="非阻塞同步机制（乐观锁）"></a>非阻塞同步机制（乐观锁）</h2><p>加锁机制始终会存在一个挂起唤醒的操作，如果有多个线程同时请求锁，那么JVM就需要借助操作系统的功能，而在挂起和恢复线程等过程中存在着很大的开销，并且通常存在着较长时间的中断。如果在竞争激烈的时候，调度开销与工作开销的比值会非常高。</p>
<p>此外，如果一个线程正在等待锁时，它不能做任何其他事情，同时如果被阻塞线程的优先级较高，而持有锁的线程优先级较低，那么问题更严重，也就是发生了优先级反转。即：高优先级的线程必须等到低优先级的线程释放锁，从而导致它的优先级会降低至低优先级线程的级别。</p>
<p>而最近的很多并发算法研究都侧重于非阻塞同步的机制，例如：Lock-free算法</p>
<h2 id="Lock-free算法（无锁）"><a href="#Lock-free算法（无锁）" class="headerlink" title="Lock-free算法（无锁）"></a>Lock-free算法（无锁）</h2><p>这个算法中主要使用到了一个CAS机制（Compare and swap），它包含了3个值，需要读写的内存位置V，需要进行比较的值A， 要写入的新值B。<br>它的原理就是：</p>
<blockquote>
<p>当且仅当V的值等于A时，CAS才会通过原子方式用新值B来更新V的值，否则不执行任何操作</p>
</blockquote>
<p>而当多个线程常识使用CAS同时更新同一个变量时，只有其中一个线程能更新变量的值，而其他的线程都将失败。但是失败的线程并不会被挂起，而是被告知在这次竞争中失败，并可以尝试再次尝试。由于一个线程在竞争CAS时失败不会阻塞，因此它可以决定是否重新尝试，或者执行一些恢复操作，再或者不执行任何操作，这种灵活性就大大减少了与锁相关的活跃性风险。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>并发的水实在太深，不花精力实在难以hold住，这里简单记录一下Java并发的知识点</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>《Java并发编程实战》</li>
<li><a href="http://ifeve.com/volatile/" target="_blank" rel="external">聊聊并发系列博客</a></li>
<li><a href="http://www.jb51.net/article/49699.htm" target="_blank" rel="external">JAVA中JVM的重排序详细介绍</a> ——也就是Java中为什么要使用重排序</li>
</ul>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/05/29/classloaders/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          关于Android和Java的ClassLoader相关知识盘点
        
      </div>
    </a>
  
  
    <a href="/2016/04/12/杂谈——Android从启动到程序运行发生的事情/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">杂谈——Android从启动到程序运行发生的事情</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="个人知识点总结——Java并发" data-title="个人知识点总结——Java并发" data-url="http://imlzq.com/2016/04/13/个人知识点总结——Java并发/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 CytQ
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>个人知识点总结——Java并发 |]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/04/13/%E5%8E%9F-%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93%E2%80%94%E2%80%94Java%E5%B9%B6%E5%8F%91/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/04/13/原-个人知识点总结——Java并发/index/</id>
    <published>2018-02-11T08:42:33.527Z</published>
    <updated>2018-02-11T08:42:33.528Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>个人知识点总结——Java并发 | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Java并发实在是一个很深的问题，这里只简单记录一下Java并发的知识点。水太深，如果不花大量的时间感觉完全hold不住，但是目前的精力完全不够，兴趣也不在这">
<meta property="og:type" content="article">
<meta property="og:title" content="个人知识点总结——Java并发">
<meta property="og:url" content="http://imlzq.com/2016/04/13/原-个人知识点总结——Java并发/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="Java并发实在是一个很深的问题，这里只简单记录一下Java并发的知识点。水太深，如果不花大量的时间感觉完全hold不住，但是目前的精力完全不够，兴趣也不在这">
<meta property="og:updated_time" content="2016-05-14T11:14:19.346Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="个人知识点总结——Java并发">
<meta name="twitter:description" content="Java并发实在是一个很深的问题，这里只简单记录一下Java并发的知识点。水太深，如果不花大量的时间感觉完全hold不住，但是目前的精力完全不够，兴趣也不在这">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/headicon.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ITStudieren</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Study, Note and Advance</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 16.67px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 16.67px;">Android</a> <a href="/tags/Chinese/" style="font-size: 10px;">Chinese</a> <a href="/tags/Design-Pattern/" style="font-size: 20px;">Design Pattern</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 13.33px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/Python/" style="font-size: 20px;">Python</a> <a href="/tags/Rxjava/" style="font-size: 13.33px;">Rxjava</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Study-Note/" style="font-size: 20px;">Study Note</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">ITStudieren</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/headicon.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">ITStudieren</h1>
			</hgroup>
			
			<p class="header-subtitle">Study, Note and Advance</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-原-个人知识点总结——Java并发" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/13/原-个人知识点总结——Java并发/" class="article-date">
  	<time datetime="2016-04-13T09:55:08.000Z" itemprop="datePublished">2016-04-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      个人知识点总结——Java并发
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Java并发实在是一个很深的问题，这里只简单记录一下Java并发的知识点。水太深，如果不花大量的时间感觉完全hold不住，但是目前的精力完全不够，兴趣也不在这</p>
<a id="more"></a>
<h2 id="什么是线程安全性"><a href="#什么是线程安全性" class="headerlink" title="什么是线程安全性"></a>什么是线程安全性</h2><blockquote>
<p>某个类的行为和其规范完全一致 </p>
<p>  当多个线程访问某个类时，不管运行时环境采用何种调度方式或者这些线程将如何交替执行，并且在主调代码中不需要任何额外的同步或协同，这个类都能表现出正确的行为，那么就称这个类是线程安全的</p>
</blockquote>
<h2 id="原子操作-Atomic-Operation"><a href="#原子操作-Atomic-Operation" class="headerlink" title="原子操作(Atomic Operation)"></a>原子操作(Atomic Operation)</h2><p>原子操作是指不会被线程调度机制打断的操作，这种操作一旦开始，就会一直运行到结束，中间不会有任何的上下文切换，它是不可分割的。</p>
<p>举一个常见的例子：a++，这个操作就不是一个原子性的操作，那么在多个线程访问调用的时候，a的最终结果就很有可能不是我们的预期值。因为实际上a++这个操作可以分为已下三步：获取a的值，更新a的值，写回a的值。</p>
<h2 id="缓存一致性"><a href="#缓存一致性" class="headerlink" title="缓存一致性"></a>缓存一致性</h2><p>在共享内存的多处理器体系架构中，每个处理器都拥有自己的缓存，并且定期地与主内存进行协调，在不同的处理器架构中提供了不同级别的缓存一致性。</p>
<p>这个缓存一致性可以通过volatile关键字来加深理解。</p>
<h2 id="Volatile关键字"><a href="#Volatile关键字" class="headerlink" title="Volatile关键字"></a>Volatile关键字</h2><p>Volatile是一种较弱的同步机制，用来确保将变量的更新操作通知到其他线程，当把变量声明为volatile类型后，编译器与运行时都会注意到这个变量是共享的，因此不会将该变量上的操作一起重排序。volatile变量不会被缓存在寄存器或者对其他处理器不可见的地方，因此在读取volatile类型的变量时总会返回最新写入的值。 </p>
<p>但是有一点是需要注意的，被volatile修饰的变量的的操作也应该是原子性的，不然同样会出先问题。 </p>
<p>例如：</p>
<pre><code>Volatile &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; a = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;;

&lt;span class=&quot;hljs-comment&quot;&gt;// 非原子性操作，使用volatile不能保证同步，改用Synchronized&lt;/span&gt;
a++;`&lt;/pre&gt;

而为什么Volatile能够实现这种功能呢？ 

这个要从它的实现原理说起，在x86处理器下通过工具获取JIT编译器生成的汇编指令来看Volatile的写操作实际上做了什么吧。

&lt;pre class=&quot;prettyprint&quot;&gt;`&lt;span class=&quot;hljs-attribute&quot;&gt;0x01a3de1d&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;movb $0x0,0x1104800(%esi);&lt;/span&gt;
&lt;span class=&quot;hljs-attribute&quot;&gt;0x01a3de24&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;lock addl $0x0,(%esp);&lt;/span&gt;`&lt;/pre&gt;

有Volatile变量修饰的共享变量进行写操作的时候会多第二行代码，lock指令修饰。 

而lock指令会做什么事呢？
</code></pre><ul>
<li>将当前处理器缓存行的数据写回到系统内存</li>
<li><p>该写回内存的操作会引起在其他CPU里缓存了该内存地址的数据无效</p>
<p>在上面介绍缓存一致性的时候提到了，在共享内存的多处理器体系架构中，每个处理器都拥有自己的缓存，并且定期地与主内存进行协调，在不同的处理器架构中提供了不同级别的缓存一致性。 </p>
<p>那么这个时候也就有了下面的事情： </p>
<p>处理器为了提高处理速度，不直接和内存进行通讯，而是先将系统内存的数据读到内部缓存中再进行操作，但操作完成后不确定什么时候会写回到内存，如果对声明了Volatile变量进行些操作，JVM就会向处理器发送一条Lock前缀的指令，将这个变量所在缓存行的数据写回到系统内存。而由于缓存一致性协议，每个处理器会通过嗅探在总线上传播的数据在来检查自己缓存的值是不是国旗了，当处理器发现自己缓存行对应的内存地址被修改，就会将当前处理器的缓存行设置为无效状态。当处理器要对这个数据进行修改操作的时候，就会强制从系统内存中重新读取数据到处理器缓存里。 </p>
<p>这也就是Volatile实现的原理。</p>
<h2 id="重排序"><a href="#重排序" class="headerlink" title="重排序"></a>重排序</h2><p>刚才上面总结到了重排序的概念，那什么是重排序呢？</p>
<p>简单的理解就是，当程序在执行的时候，如果JVM认为两行代码之间的结果互不影响，那么在执行的过程中可能就会产生一个乱序的结果。 </p>
<p>例如：</p>
<pre class="prettyprint">` a = <span class="hljs-number">3</span>; 
 b = <span class="hljs-number">4</span>;`</pre>

<p>正常情况下我们会觉得a = 3肯定是比b=4先执行的，因为它在b的上面，但是实际上并不是这样，因为b的运行结果并不依赖上一行a的结果，因此JVM就能够对两行代码进行一个重排序，可能a先执行，也可能b先执行</p>
<p><strong>为什么要采用重排序？</strong> </p>
<p>重排序通常是编译器或运行时环境为了优化程序性能而采取的。它可以分为两类：编译器重排序和运行时重排序。</p>
<p>顺序一致性模型：理想的模型是，各种指令执行的顺序是唯一且有序的，这个顺序就是它们被编写在代码中的顺序，与处理器或其他因素无关</p>
<p>顺序一致性模型的缺点：效率过低</p>
<p>编译器重排序的典型就是通过调整指令顺序，在不改变程序语义的前提下，尽可能的减少寄存器的读取、存储次数、充分服用寄存器的存储值。</p>
<p>假设第一条指令计算一个值赋给变量A并存放在寄存器中，第二条指令与A无关但需要占用寄存器（假设它将占用A所在的那个寄存器），第三条指令使用A的值且与第二条指令无关。那么如果按照顺序一致性模型，A在第一条指令执行过后被放入寄存器，在第二条指令执行时A不再存在，第三条指令执行时A重新被读入寄存器，而这个过程中，A的值没有发生变化。通常编译器都会交换第二和第三条指令的位置，这样第一条指令结束时A存在于寄存器中，接下来可以直接从寄存器中读取A的值，降低了重复读取的开销。</p>
<h2 id="并发时的乱序问题"><a href="#并发时的乱序问题" class="headerlink" title="并发时的乱序问题"></a>并发时的乱序问题</h2><p>上面总结的重排序可以引起乱序，同样的，在并发时对局部变量进行操作也有可能会产生乱序的问题。因为在每个线程中都拥有一个独立的栈，也就是独立的线程空间，当它运行时，会从主内存中读取该变量的值并存放到自己的线程栈中，对变量操作完成后就会把值写回主内存空间。 </p>
<p>但是这里就有一个问题了，那就是变量的写回操作发生的时间并不能够确定。就算是线程A比线程B先读取数据，仍然有可能线程B先把值写回主内存，最终同样会造成一个得到的结果并不是我们想要的值。</p>
<h2 id="Happens-before（先行发生）"><a href="#Happens-before（先行发生）" class="headerlink" title="Happens-before（先行发生）"></a>Happens-before（先行发生）</h2><p>Java内存模型（JMM）为程序中所有的操作定义了一个偏序关系，称之为Happens-before。如果想要保证执行操作B的线程看到操作A的结果（无论A和B是否在同一个线程中执行），那么在A和B之间必须满足Happens-Before关系。如果两个操作时间缺乏Happens-Before关系，那么JVM可以对它们任意地重排序。</p>
<p>当一个变量被多个线程读取并且至少被一个线程写入时，如果在读写操作之间没有按照Happens-Before来排序，那么就会产生数据竞争的问题。</p>
<p>Happens-Before规则包括：</p>
</li>
<li><p><strong>程序顺序规则</strong>：如果程序中操作A在操作B之前，那么在线程中A操作将在B操作之前执行</p>
</li>
<li><strong>监视器锁规则</strong>：在监视器锁上的解锁操作必须在同一个监视器锁上的加锁操作之前执行</li>
<li><strong>volatile变量规则</strong>：对volatile变量的写入操作必须在对该变量的读操作之前执行</li>
<li><strong>线程启动规则</strong>：在线程上对Thread.Start的调用必须在该县城中执行任何操作之前执行</li>
<li><strong>线程结束规则</strong>：县城中的任何操作都必须在其他线程检测到该线程已经结束之前执行，或者在Thread.join中成功返回，或者在调用THread.isAlive时返回false</li>
<li><strong>中断规则</strong>：当一个线程在另一个线程上调用interrupt时，必须在被中断线程检测到interrupt调用之前执行</li>
<li><strong>终结器规则</strong>：对象的构造函数必须在启动终结器之前执行</li>
<li><p><strong>传递性</strong>：操作A在B之前，B在C之前，那么A就必须在C之前执行</p>
<p>例如线程A：y=1 -》 lock M -》 x=1 -》unlock M </p>
<p>线程B： lock M -》 i=x -》 unlock M -》 j=y</p>
<p>当两个线程使用同一个锁进行同步时，在它们之间的happens-Before关系就是：A的unlock M执行完成之后才能执行B的lock M方法，如果这两个线程是在不同的锁上进行同步的，那么就不能推断它们之间的动作顺序，因为在这两个线程的操作之间并不存在Happens-Before关系</p>
<h2 id="Lock-Synchronized-ReentrantLock（独占锁-悲观锁）"><a href="#Lock-Synchronized-ReentrantLock（独占锁-悲观锁）" class="headerlink" title="Lock / Synchronized / ReentrantLock（独占锁 / 悲观锁）"></a>Lock / Synchronized / ReentrantLock（独占锁 / 悲观锁）</h2><p><strong>Synchronized</strong> </p>
<p>内置锁，当它用来修饰一个方法或者一个代码块的时候，能够保证在同一时刻最多只有一个线程执行该段代码，另一个线程必须等待当前线程执行完这个代码快以后才能执行该代码块（未执行之前，该线程被阻塞）。同时，它也是一个可重入锁（Lock均可重入）</p>
<p>但是这里有一个很关键的地方：当一个线程访问object的一个synchronized(this)同步代码块时，另一个线程仍然可以访问该object中的非synchronized(this)同步代码块。</p>
<p>之前在单例模式中总结到了双重检查锁定模式，但是由于双重检查锁定模式在一定情况下存在很严重的Bug，就没有在该博客中写出。这里就对双重检查锁定模式进行一个分析</p>
<pre class="prettyprint">`<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title">getInstance</span>() {  
        <span class="hljs-keyword">if</span> (singleton == <span class="hljs-keyword">null</span>) {    
            <span class="hljs-keyword">synchronized</span> (Singleton.class) {    
               <span class="hljs-keyword">if</span> (singleton == <span class="hljs-keyword">null</span>) {    
                  singleton = <span class="hljs-keyword">new</span> Singleton();   
               }    
            }    
        }    
        <span class="hljs-keyword">return</span> singleton;   
    } `</pre>

<p>因为在new Singleton()的过程中，实际上是可以分为很多步的，可大致分为三件事情：</p>
</li>
<li><p>给Singleton的实例分配内存</p>
</li>
<li>调用Singleton的构造函数，初始化字段</li>
<li><p>将singleton对象指向分配的内存空间（singleton != null）</p>
<p>但是，Java编译器是允许处理器乱序执行的，所有有可能让第二步和第三步乱序执行，也就是说如果在第二步被乱序（安排到了最后一步执行），当他还没执行的时候切换到了线程B，这个时候就会因为singleton已经不为null而直接跳出if判断，这样的话在我们以后的代码运行过程中使用的就是一个未经构造函数初始化的一个对象。<strong>【现在好像有在JDK层面有改进因此可以正常使用，具体的不清楚，以后再修改】</strong></p>
<p><strong>Lock</strong></p>
<p>Lock是一个接口，它里面主要包含了下面的几个方法： </p>
<p>P.S.源码里的注释太多，这里就不贴了</p>
<p><pre class="prettyprint">`<span class="hljs-keyword">void</span> lock();<br><span class="hljs-keyword">void</span> lockInterruptibly();<br><span class="hljs-keyword">boolean</span> tryLock();<br><span class="hljs-keyword">boolean</span> tryLock(<span class="hljs-keyword">long</span> time, TimeUnit unit);<br><span class="hljs-keyword">void</span> unlock();<br>Condition newCondition();</pre></p>
</li>
</ul>
<p>Lock它与内置加锁机制不同，它提供的是一种无条件的、可轮训的、定时的以及可中断的锁获取操作，所有的加锁和解锁的方法都是显式的。</p>
<p>一句话总结：Synchronized算是Lock的简化版本，功能比之较少但是在程序执行完成后会自动释放锁，而Lock必须手动释放锁</p>
<p><strong>ReentrantLock</strong> </p>
<p>ReentrantLock它实现了Lock接口，并提供了与synchronized相同的互斥性和内存可见性。 </p>
<p>那为什么还要提供一种机制跟内置锁十分相似的新加锁机制呢？ </p>
<p>因为内置锁在一定情况下存在局限性，例如无法中断一个正在等待获取锁的进程，或者无法在请求获取一个锁时无限地等待下去，；无法实现非阻塞结构的加锁规则。</p>
<p>而在ReentrantLock中，它可以实现轮询锁、定时锁、中断锁等多种加锁方式，这也让它的应用场景变的更多。</p>
<p>同时在性能上：如果有越多的资源被耗费在锁的管理和调度上，那么应用程序得到的资源就越少。锁的实现方式越好，就需要越少的系统调用和上下文切换，并且在共享内存总线上的内存同步通信量也越少。 </p>
<p>在Java5中，ReentrantLock的性能比内置锁高了很多，但是在Java6中内置锁采取了一种类似与ReentrantLock中使用的算法来管理内置锁，有效地提高了可伸缩性，因此在Java6中，它们的吞吐量就非常接近了。</p>
<p>在公平性上，ReentrantLock可以创建一个非公平锁（默认）也可以创建一个公平锁。 </p>
<p>公平锁：线程按照发出请求的顺序来获得锁（先到先得，不准插队） </p>
<p>非公平锁：当一个线程请求非公平锁时，如果在发出请求的同时该锁的状态变为可用，那么就跳过队列中所有的等待队列立刻获得锁（也就是允许插队。申请的时候锁为可用状态就直接获取）</p>
<p>而对于公平锁和非公平锁来说，它们的效率也是显而易见的： </p>
<p>公平性将由于在挂起线程和恢复线程时存在的开销而极大的降低效率。 </p>
<p>而非公平性由于是在请求时锁已经为可用状态就直接获取，不需要进行什么额外的操作，因此效率更高。 </p>
<p>实际上：确保被阻塞的线程能最终获得锁就已经够用了，并且实际开销也小很多。</p>
<p>当在一个激烈竞争的情况下，恢复一个被挂起的线程与这个线程真正开始运行之间存在着严重的延迟，这样的话就影响了效率。而如果我们采用非公平锁（也就是ReentrantLock的默认方式），线程A释放锁时，B被唤醒然后尝试获取锁，与此同时C也请求这个锁，那么C很有可能会在B被完全唤醒之前获得、使用以及释放这个锁。也就有可能会造成B获得锁的时刻并没有推迟，C也更早的获得了锁</p>
<p>那什么时候应该使用公平锁呢？ </p>
<p>当持有锁的时间相对较长，或者请求锁的平均时间间隔较长，那么就应该使用公平锁。</p>
<p><strong>在Synchronize和ReentrantLock中如何选择</strong> </p>
<p>上面总结了这么多，好像ReentrantLock的优点比Synchronize好太多，那为什么不直接取消掉Synchronize呢？我们自己该怎么选择呢？</p>
<p>Synchronize很重要的几个优点就是：</p>
<ul>
<li>无需手动释放锁，程序自动完成。如果在使用Lock的过程中忘记在finally中释放锁，那么虽然代码表面上能正式运行，但是实际上已经出了大问题，还有可能伤到其他代码。所以一般仅仅是在做一些内置锁不能完成的需求时才考虑使用ReentrantLock，例如中断锁、轮询锁等等</li>
<li>调试的问题：Synchronized在线程存储中能够给出在哪些调用帧中获得了哪些锁，并能够检测和识别发生死锁的进程。而ReentrantLock它只是一个对象，JVM不知道哪些线程持有这个。</li>
</ul>
<h2 id="非阻塞同步机制（乐观锁）"><a href="#非阻塞同步机制（乐观锁）" class="headerlink" title="非阻塞同步机制（乐观锁）"></a>非阻塞同步机制（乐观锁）</h2><p>加锁机制始终会存在一个挂起唤醒的操作，如果有多个线程同时请求锁，那么JVM就需要借助操作系统的功能，而在挂起和恢复线程等过程中存在着很大的开销，并且通常存在着较长时间的中断。如果在竞争激烈的时候，调度开销与工作开销的比值会非常高。</p>
<p>此外，如果一个线程正在等待锁时，它不能做任何其他事情，同时如果被阻塞线程的优先级较高，而持有锁的线程优先级较低，那么问题更严重，也就是发生了优先级反转。即：高优先级的线程必须等到低优先级的线程释放锁，从而导致它的优先级会降低至低优先级线程的级别。</p>
<p>而最近的很多并发算法研究都侧重于非阻塞同步的机制，例如：Lock-free算法</p>
<h2 id="Lock-free算法（无锁）"><a href="#Lock-free算法（无锁）" class="headerlink" title="Lock-free算法（无锁）"></a>Lock-free算法（无锁）</h2><p>这个算法中主要使用到了一个CAS机制（Compare and swap），它包含了3个值，需要读写的内存位置V，需要进行比较的值A， 要写入的新值B。 </p>
<p>它的原理就是：</p>
<blockquote>
<p>当且仅当V的值等于A时，CAS才会通过原子方式用新值B来更新V的值，否则不执行任何操作</p>
</blockquote>
<p>而当多个线程常识使用CAS同时更新同一个变量时，只有其中一个线程能更新变量的值，而其他的线程都将失败。但是失败的线程并不会被挂起，而是被告知在这次竞争中失败，并可以尝试再次尝试。由于一个线程在竞争CAS时失败不会阻塞，因此它可以决定是否重新尝试，或者执行一些恢复操作，再或者不执行任何操作，这种灵活性就大大减少了与锁相关的活跃性风险。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>并发的水实在太深，不花精力实在难以hold住，这里简单记录一下Java并发的知识点</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>《Java并发编程实战》</li>
<li><a href="http://ifeve.com/volatile/" target="_blank" rel="external">聊聊并发系列博客</a></li>
<li><a href="http://www.jb51.net/article/49699.htm" target="_blank" rel="external">JAVA中JVM的重排序详细介绍</a> ——也就是Java中为什么要使用重排序<pre><code>&lt;div&gt;
    作者：JonsTank2013 发表于2016/4/13 17:55:08 [原文链接](http://blog.csdn.net/jonstank2013/article/details/51145184)
&lt;/div&gt;
&lt;div&gt;
阅读：2753 评论：0 [查看评论](http://blog.csdn.net/jonstank2013/article/details/51145184#comments)
&lt;/div&gt;
</code></pre></li>
</ul>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/04/12/原-杂谈——Android从启动到程序运行发生的事情/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">杂谈——Android从启动到程序运行发生的事情</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="原-个人知识点总结——Java并发" data-title="个人知识点总结——Java并发" data-url="http://imlzq.com/2016/04/13/原-个人知识点总结——Java并发/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 ITStudieren
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>个人知识点总结——Java并发 |]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/04/12/%E6%9D%82%E8%B0%88%E2%80%94%E2%80%94Android%E4%BB%8E%E5%90%AF%E5%8A%A8%E5%88%B0%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA%8B%E6%83%85/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/04/12/杂谈——Android从启动到程序运行发生的事情/index/</id>
    <published>2018-02-11T08:42:33.526Z</published>
    <updated>2018-02-11T08:42:33.527Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>杂谈——Android从启动到程序运行发生的事情 | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="转载请注明出处博客地址：imlzq.com作者：李中权
前言好久没有写博客了，瞬间感觉好多学了的东西不进行一个自我的总结与消化总归变不成自己的。通过博客可能还可以找到一些当初在学习的时候没有想到的问题。想了半天，从大二上学期自学Android以来还没有对Android从启动到程序运行期间进行一个完整的归纳，刚好最近又学到了一些新东西，那就以这篇博客为媒介，总结一下从Android启动到程序运行期间">
<meta property="og:type" content="article">
<meta property="og:title" content="杂谈——Android从启动到程序运行发生的事情">
<meta property="og:url" content="http://imlzq.com/2016/04/12/杂谈——Android从启动到程序运行发生的事情/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="转载请注明出处博客地址：imlzq.com作者：李中权
前言好久没有写博客了，瞬间感觉好多学了的东西不进行一个自我的总结与消化总归变不成自己的。通过博客可能还可以找到一些当初在学习的时候没有想到的问题。想了半天，从大二上学期自学Android以来还没有对Android从启动到程序运行期间进行一个完整的归纳，刚好最近又学到了一些新东西，那就以这篇博客为媒介，总结一下从Android启动到程序运行期间">
<meta property="og:image" content="http://gityuan.com/images/boot/android-arch1.png">
<meta property="og:image" content="http://img.blog.csdn.net/20150604144532934">
<meta property="og:updated_time" content="2016-05-14T13:20:23.757Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="杂谈——Android从启动到程序运行发生的事情">
<meta name="twitter:description" content="转载请注明出处博客地址：imlzq.com作者：李中权
前言好久没有写博客了，瞬间感觉好多学了的东西不进行一个自我的总结与消化总归变不成自己的。通过博客可能还可以找到一些当初在学习的时候没有想到的问题。想了半天，从大二上学期自学Android以来还没有对Android从启动到程序运行期间进行一个完整的归纳，刚好最近又学到了一些新东西，那就以这篇博客为媒介，总结一下从Android启动到程序运行期间">
<meta name="twitter:image" content="http://gityuan.com/images/boot/android-arch1.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
	
  

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">CytQ</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Catch your time</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 14px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Chinese/" style="font-size: 18px;">Chinese</a> <a href="/tags/Design-Pattern/" style="font-size: 16px;">Design Pattern</a> <a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 12px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/Others/" style="font-size: 10px;">Others</a> <a href="/tags/Preface/" style="font-size: 10px;">Preface</a> <a href="/tags/Python/" style="font-size: 16px;">Python</a> <a href="/tags/Rxjava/" style="font-size: 14px;">Rxjava</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Study-Note/" style="font-size: 16px;">Study Note</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">CytQ</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/headicon.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">CytQ</h1>
			</hgroup>
			
			<p class="header-subtitle">Catch your time</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-杂谈——Android从启动到程序运行发生的事情" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/12/杂谈——Android从启动到程序运行发生的事情/" class="article-date">
  	<time datetime="2016-04-11T16:10:06.000Z" itemprop="datePublished">2016-04-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      杂谈——Android从启动到程序运行发生的事情
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>转载请注明出处<br>博客地址：imlzq.com<br>作者：李中权</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>好久没有写博客了，瞬间感觉好多学了的东西不进行一个自我的总结与消化总归变不成自己的。通过博客可能还可以找到一些当初在学习的时候没有想到的问题。想了半天，从大二上学期自学Android以来还没有对Android从启动到程序运行期间进行一个完整的归纳，刚好最近又学到了一些新东西，那就以这篇博客为媒介，总结一下从Android启动到程序运行期间发生的所有事吧。包括什么ClassLoader, JVM,IPC, 消息处理机制要是总结到了就顺带BB一下。但是这里就不包含很多细节了，比如为什么PMS内部为什么要这么构造，好处是什么，如果我来设计的话我会怎么设计啊这种暂时就不总结了，因为我觉得以我现在的水平还有学习精力来说把这些细节都一个个的弄清楚有点没抓住重点。现阶段还是先能够了解整个流程，有个大局观才是最重要的。至于以后如果有需要或者是有精力的时候再一个个的突破。</p>
<p><strong>发现本文的错误或者遗漏后会立刻更改</strong></p>
<a id="more"></a>
<h2 id="正式开始"><a href="#正式开始" class="headerlink" title="正式开始"></a>正式开始</h2><p>首先，我们知道，Android是基于Linux的一个操作系统，它可以分为五层，下面是它的层次架构图，可以记一下，因为后面应该会总结到SystemServer这些Application Framework层的东西<br><img src="http://gityuan.com/images/boot/android-arch1.png" alt=""><br>Android的五层架构从上到下依次是应用层，应用框架层，库层，运行时层以及Linux内核层。</p>
<p>而在Linux中，它的启动可以归为一下几个流程：<br>Boot Loader-》初始化内核-》。。。。。。<br>当初始化内核之后，就会启动一个相当重要的祖先进程，也就是init进程，在Linux中所有的进程都是由init进程直接或间接fork出来的。</p>
<p>而对于Android来说，前面的流程都是一样的，而当init进程创建之后，会fork出一个Zygote进程，这个进程是所有Java进程的父进程。我们知道，Linux是基于C的，而Android是基于Java的（当然底层也是C）。所以这里就会fork出一个Zygote Java进程用来fork出其他的进程。<strong>【断点1】</strong></p>
<p>总结到了这里就提一下之后会谈到的几个非常重要的对象以及一个很重要的概念。</p>
<ul>
<li>ActivityManagerServices（AMS）：它是一个服务端对象，负责所有的Activity的生命周期，<strong>ActivityThread会通过Binder与之交互，而AMS与Zygote之间进行交互则是通过Socket通信（IPC通信在之后会总结到）</strong></li>
<li>ActivityThread：它也就是我们俗称的UI线程/主线程，它里面存在一个main()方法，这也是APP的真正入口，当APP启动时，就会启动ActivityThread中的main方法，它会初始化一些对象，然后开启<strong>消息循环队列（之后总结）</strong>，之后就会Looper.loop死循环，如果有消息就执行，没有就等着，也就是事件驱动模型（edt）的原理。</li>
<li>ApplicationThread：它实现了IBinder接口，是Activity整个框架中客户端和服务端AMS之间通信的接口，同时也是ActivityThread的内部类。这样就有效的把ActivityThread和AMS绑定在一起了。</li>
<li>Instrumentation：这个东西我把它理解为ActivityThread的一个工具类，也算是一个劳动者吧，对于生命周期的所有操作例如onCreate最终都是直接由它来执行的。</li>
</ul>
<p><strong>Android系统中的客户端和服务器的概念</strong><br>在Android系统中其实也存在着服务器和客户端的概念，服务器端指的就是所有App共用的系统服务，比如上面的AMS，PackageManagerService等等，这些系统服务是被所有的App共用的，当某个App想要实现某个操作的时候，就会通知这些系统服务。</p>
<h2 id="继续断点1"><a href="#继续断点1" class="headerlink" title="继续断点1"></a>继续断点1</h2><p>当Zygote被初始化的时候，会fork出System Server进程，这个进程在整个的Android进程中是非常重要的一个，地位和Zygote等同，它是属于Application Framework层的，Android中的所有服务，例如AMS, WindowsManager, PackageManagerService等等都是由这个SystemServer fork出来的。所以它的地位可见一斑。</p>
<p>而当System Server进程开启的时候，就会初始化AMS，同时，会加载本地系统的服务库，创建系统上下文，创建ActivityThread及开启各种服务等等。而在这之后，就会开启系统的Launcher程序，完成系统界面的加载与显示。<strong>【断点2】</strong></p>
<h2 id="Context总结"><a href="#Context总结" class="headerlink" title="Context总结"></a>Context总结</h2><p>Context是一个抽象类，下面是它的注释信息，摘自源码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Interface to global information about an application environment.  This is</span><br><span class="line"> * an abstract class whose implementation is provided by</span><br><span class="line"> * the Android system.  It</span><br><span class="line"> * allows access to application-specific resources and classes, as well as</span><br><span class="line"> * up-calls for application-level operations such as launching activities,</span><br><span class="line"> * broadcasting and receiving intents, etc.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br></pre></td></tr></table></figure>
<p>从上面的这段话可以简单理解一下，Context是一个关于应用程序环境的全局变量接口，通过它可以允许去获得资源或者类，例如启动Activity,广播，intent等等。</p>
<p>我的理解：Context的具体实现是Application, Activity,Service，通过Context能够有权限去做一些事情，其实我觉得就是一个运行环境的问题。</p>
<p><strong>需要注意的地方</strong><br>Android开发中由于很多地方都包含了Context的使用，因此就必须要注意到内存泄露或者是一些可能会引起的问题。</p>
<p>例如在Toast中，它的Context就最好设置为Application Context，因为如果Toast在显示东西的时候Activity关闭了，但是由于Toast仍然持有Activity的引用，那么这个Activity就不会被回收掉，也就造成了内存泄露。</p>
<h2 id="Toast的相关总结"><a href="#Toast的相关总结" class="headerlink" title="Toast的相关总结"></a>Toast的相关总结</h2><p>上面举例的时候举到了Toast，其实Toast也是很有意思的一个东西，它的show方法其实并不是显示一个东西这么简单。<br>Toast实际上是一个队列，会通过show方法把新的任务加入到队列当中去，列队中只要存在消息就会弹出来使用，而队列的长度据说默认是40个（这是网上搜出来的，我在源码中没找到对应的设置，感觉也没啥必要就没找了）。<br>所以这里就要注意一下show这个操作了，它并不是显示内容，而是把内容入队列。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">     * Show the view for the specified duration.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mNextView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"setView must have been called"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        INotificationManager service = getService();</span><br><span class="line">        String pkg = mContext.getOpPackageName();</span><br><span class="line">        TN tn = mTN;</span><br><span class="line">        tn.mNextView = mNextView;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            service.enqueueToast(pkg, tn, mDuration);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="comment">// Empty</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Handler的内存泄露"><a href="#Handler的内存泄露" class="headerlink" title="Handler的内存泄露"></a>Handler的内存泄露</h2><p>对于Handler来说，如果我们直接在AndroidStudio中创建一个非静态内部类Handler，那么Handler这一大片的区域会被AS标记为黄色，这个应该很多人都遇到过吧。实际上是因为这样设置会造成内存泄露，因为每一个非静态内部类都会持有一个外部类的引用，那么这里也就产生了一个内存泄露的可能点，如果当Activity被销毁时没有与Handler解除，那么Handler仍然会持有对该Activity的引用，那么就造成了内存泄露。</p>
<p><strong>解决方案</strong><br>使用static修饰Handler，这样也就成了一个静态内部类，那么就不会持有对外部类的引用了。而这个时候就可以在Handler中创建一个WeakReference（弱引用）来持有外部的对象。只要外部解除了与该引用的绑定，那么垃圾回收器就会在发现该弱引用的时候立刻回收掉它。</p>
<h2 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h2><p>关于垃圾回收的相关总结看我之前的博客，传送门：<a href="http://blog.csdn.net/jonstank2013/article/details/50922958" target="_blank" rel="external">JVM原理及底层探索</a></p>
<h2 id="四种引用方式"><a href="#四种引用方式" class="headerlink" title="四种引用方式"></a>四种引用方式</h2><p>上面扯到了弱引用，就再BB一下四种引用方式吧。</p>
<ul>
<li>强引用：垃圾回收器打死都不会回收掉一个强引用的，那怕是出现OOM也不会回收掉强引用，所有new出来的都是强引用。</li>
<li>软引用：垃圾回收器会在内存不足的情况下回收掉软引用，如果内存充足的话不会理它</li>
<li>弱引用：它跟软引用类似，但是它更脆弱，只要垃圾回收器一发现它，就会立刻回收掉它。比如一个对象持有一个强引用和弱引用，当强引用被取消时，那么只要GC发现了它，就会立刻回收掉。只是GC发现它的这个过程是不确定的，有可能不会马上发生，所以它可能还会多活一会，中间存在一个优先级。</li>
<li>虚引用：它跟上面3种方式都不同。我对虚引用的理解就是如果一个对象持有虚引用，那么就可以在被GC回收前进行一些设定好的工作等等。因为虚引用有个机制，因为虚引用必须和引用队列联合使用，当垃圾回收器准备回收一个对象时，如果发现它还有虚引用，就回在回收对象的内存前，把这个虚引用加入到与之关联的引用队列中。而程序如果判断到引用队列中已经加入了虚引用，那么就可以了解到被引用的对象马上就要被垃圾回收了，这个时候就可以做些被回收之前的事情啦。</li>
</ul>
<h2 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h2><p>类加载器按层次从顶层到下依次为Boorsrtap ClassLoader（启动类加载器）,Extension ClassLoader（拓展类加载器），ApplicationClassLoader（应用程序类加载器）</p>
<p>判断两个类是否是同一个类就是看它们是否是由同一个类加载器加载而来。</p>
<p>这里就需要介绍一下双亲委派模式了：<br>双亲委派模式的意思就是：除了启动类加载器之外，其余的加载器都需要指定一个父类的加载器，当需要加载的时候会先让父类去试着加载，如果父类无法加载也就是找不到这个类的话就会让子类去加载</p>
<p>好处：防止内存中出现多份同样的字节码</p>
<p>比如类A和类B都要加载system类，如果不是委托的话，类A就会加载一份，B也会加载一份，那么就会出现两份SYstem字节码<br>如果使用委托机制，会递归的向父类查找，也就是首选用Bootstrap尝试加载，如果找不到再向下，如果A用这个已经加载了的话会直接返回内存中的system而不需要重新加载。那么就只会存在一份</p>
<h2 id="延迟加载的应用：单例模式"><a href="#延迟加载的应用：单例模式" class="headerlink" title="延迟加载的应用：单例模式"></a>延迟加载的应用：单例模式</h2><p>对于Java来说，类是需要使用到时才会加载，这里也就出现了一个延迟加载的效果。而在延迟加载的时候，会默认保持同步。这也就产生了一种单例模式的方式，具体的看我之前的博客：<a href="http://blog.csdn.net/jonstank2013/article/details/50903830" target="_blank" rel="external">设计模式_单例模式</a></p>
<p>我觉得在android所有的创建单例模式方法中里延迟加载方式是最好吧，虽然枚举比延迟加载更好，effiective java中也很推荐，但是并不怎么适用于Android，Android里枚举的消耗是static的两倍，延迟加载的话只要我们在使用延迟加载方式时做好反序列化的返回值readResolve()准备就好了。</p>
<h2 id="继续断点2"><a href="#继续断点2" class="headerlink" title="继续断点2"></a>继续断点2</h2><p>上面BB了太多其他的，现在有点缓不过来，下次自己看自己博客的时候会不会都被自己的思路带得乱七八糟的。</p>
<p>上面的时候我们就已经完成了整个Android系统的开机以及初始化。接下来就可以B一下从点击APP图标开始到APP内部程序运行起来的流程了。</p>
<p>当我们点击屏幕时，触摸屏的两层电极会连接在一起，也就产生了一个电压（具体的我忘了，书上有，图找不到了），当产生电压的时候，就可以通过对应的驱动把当前按压点的XY坐标传给上层，这里也就是操作系统。操作系统在获取到XY值的时候，就会对按压点的范围进行一个判断，如果确定按压点处于一个APP图标或者是Button等等的范围中时，操作系统也就会认为用户当前已经点击了这个东西，启动对应的监听。</p>
<p>而当系统判断我们点击的是APP图标时，该App就由Launcher开始启动了<strong>【断点3】</strong></p>
<h2 id="Launcher"><a href="#Launcher" class="headerlink" title="Launcher"></a>Launcher</h2><p>Launcher是一个继承自Activity，同时实现了点击事件，长按事件等等的一个应用程序。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Launcher</span> <span class="keyword">extends</span> <span class="title">Activity</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span>,<span class="title">OnLongClickListener</span>, <span class="title">LauncherModel</span>.<span class="title">Callbacks</span>,<span class="title">View</span>.<span class="title">OnTouchListener</span></span></span><br></pre></td></tr></table></figure>
<p>当我们点击一个APP的图标时，会调用Launcher内部的startActivitySafely()方法，而这个方法则会进行两件事，一个是启动目标activity，另一个功能就是捕获异常ActivityNotFoundException，也就是常见的“找不到activity,是否已经在androidmenifest文件中注册？”。而在startActivity方法中，经过一系列的转换最终会调用到startActivityForResult这个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">           startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// Note we want to go through this call for compatibility with</span></span><br><span class="line">           <span class="comment">// applications that may have overridden the method.</span></span><br><span class="line">           startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>所以实际上，我对整个Android的界面是这样理解的：<br>当系统完成初始化以及各种服务的创建之后，就会启动Launcher这个应用程序（它也是继承自Activity的，包含自己对应的xml布局文件），然后再把各种图标按照一个正常APP布局的方式放在上面，当我们点击APP图标时，也就相当于在Launcher这个APP应用程序中通过startActivity（在底层最后会转为startActivityForResult）来启动这个APP。简单的讲，我觉得就是一个主要的APP（Launcher）里面启动了其他的功能APP，例如QQ、微信这些。<strong>【个人理解，如果以后发现不对再修改】</strong></p>
<h2 id="Android中点击事件的处理"><a href="#Android中点击事件的处理" class="headerlink" title="Android中点击事件的处理"></a>Android中点击事件的处理</h2><p>当我们手指按下时，Android是如何处理点击事件的呢？如何确定是让哪一个控件来处理呢？<br>简单一句话：层层传递-冒泡的方式处理<br>举个例子：现在公司来了个小项目，老板一看分配给经理做，经理一看分配给小组长，小组长一看好简单，分配给组员。如果在这个传递过程中（也就是还为分配到最底部时），某一层觉得我来负责这个比较好的话就会拦截掉这个消息，然后把它处理了，下面的就收不到有消息的这个通知。如果一直到了底层的话，组员如果能完成，就完成它。如果不能完成，那么就报告给组长，说组长我做不来，边学边做要影响进度。组长一看我也做不来，就给经理，经理一看我也不会，就给老板。这样也就一层层的传递了。<br>总结一下就是消息从上到下依次传递，如果在传递的过程中被拦截了就停止下传。如果没有被拦截，就一直传递到底部，如果底部不能够消耗该消息，那么就又一层层的返回来，返给上层，直到被消耗或者是到达最顶层。</p>
<p>在Android中，存在三个重要的方法：</p>
<ul>
<li>dispathTouchEvent(MotionEvent ev)</li>
<li>onInterceptTouchEvent(MotionEvent ev)</li>
<li>onTouchEvent(MotionEvent ev)</li>
</ul>
<p>第一个方法负责事件的分发，它的返回值就是表示是否消耗当前事件。<br>第二个方法是用于判断是否拦截该消息，如果当前View拦截了某个时间，那么在同一个事件序列中，此方法不会被再次调用。返回结果表示是否拦截当前事件<br>第三个方法就是处理事件。返回结果表示是否消耗当前事件，如果不小号，则在同一时间序列中，当前View无法再次接收到事件。</p>
<p>对于一个根ViewGroup来说，点击事件产生后，首先会传递给它，调用它的dispath方法。如果这个ViewGroup的onIntercept方法返回true就表示它要拦截当前事件，false就表示不拦截，这个时候事件就会继续传递给子元素，接着调用子元素的dispath方法，直到被处理。</p>
<h2 id="滑动冲突"><a href="#滑动冲突" class="headerlink" title="滑动冲突"></a>滑动冲突</h2><p>顺带总结一下滑动冲突的解决吧<br>View的滑动冲突一般可以分为三种：</p>
<ul>
<li>外部滑动和内部滑动方向不一致</li>
<li>外部滑动方向和内部滑动方向一致</li>
<li>嵌套上面两种情况</li>
</ul>
<p>比如说一个常见的，外部一个ListView，里面一个ScrollView。这个时候该怎么解决呢？其实这里想到了ViewPager，它里面实际上是解决了滑动冲突的，可以借鉴一下它的。</p>
<p><strong>滑动处理规则</strong><br>一般来说，我们可以根据用户手指滑动的方向以及角度来判断用户是要朝着哪个方向去滑动。而很多时候还可以根据项目的需求来指定一套合适的滑动方案。</p>
<p><strong>外部拦截法</strong><br>这种方法就是指所有的点击时间都经过父容器的拦截处理，如果父容器需要此时间就拦截，如果不需要此事件就不拦截。通过重写父容器的onInterceptTouchEvent方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">	intercepted = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line"><span class="keyword">if</span>(父类容器需要) &#123;</span><br><span class="line">	intercepted = <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	intercepted = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">	intercepted = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> intercepted;</span><br></pre></td></tr></table></figure>
<p>这里有一点需要注意，ACTION_DOWN事件父类容器就必须返回false，因为如果父类容器拦截了的话，后面的Move等所有事件都会直接由父类容器处理，就无法传给子元素了。UP事件也要返回false，因为它本身来说没有太多的意义，但是对于子元素就不同了，如果拦截了，那么子元素的onClick事件就无法触发。</p>
<p><strong>内部拦截法</strong><br>这种方法指的是父容器不拦截任何时间，所有的事件都传递给子元素，如果子元素需要此事件就直接消耗掉，否则就交给父容器进行处理。它需要配合requestDisallowInterceptTouchEvent方法才能正常工作。我们需要重写子元素的dispatch方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">	parent.requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">MotionEvent.ACTION_MOVE:</span><br><span class="line">	<span class="keyword">if</span>(父容器需要此类点击事件) &#123;</span><br><span class="line">	parent.requestDisallowInterceptTouchEvent(<span class="keyword">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(event);</span><br></pre></td></tr></table></figure>
<p>这种方法的话父类容器需要默认拦截除了ACTION_DOWN以外的其他时间，这样当子元素调用request方法的时候父元素才能继续拦截所需的事件。</p>
<p><strong>其他的</strong><br>如果觉得上面两个方式太复杂，看晕了，其实也可以自己根据项目的实际需要来指定自己的策略实现。例如根据你手指按的点的位置来判断你当前触碰的是哪个控件，以此来猜测用户是否是要对这个控件进行操作。如果点击的是空白的地方，就操作外部控件即可。</p>
<p><strong>【等有时间了就把ViewPager的处理总结一下，挺重要的】</strong></p>
<h2 id="继续断点3"><a href="#继续断点3" class="headerlink" title="继续断点3"></a>继续断点3</h2><ul>
<li>当我们点击桌面的APP图标时，Launcher进程会采用Binder的方式向AMS发出startActivity请求</li>
<li>AMS在接收到请求之后，就会通过Socket向Zygote进程发送创建进程的请求</li>
<li>Zygote进程会fork出新的子进程（APP进程）</li>
<li>之后APP进程会再向AMS发起一次请求，AMS收到之后经过一系列的准备工作再回传请求。</li>
<li>APP进程收到AMS返回的请求后，会利用Handler向主线程发送LAUNCH_ACTIVITY消息</li>
<li>主线程在收到消息之后，就创建目标Activity，并回调onCreate()/onStart()/onResume()等方法，UI渲染结束后便可以看到App主界面<br><strong>【断点4】</strong></li>
</ul>
<h2 id="Handler-Looper-Message-Queue-ThreadLocal机制"><a href="#Handler-Looper-Message-Queue-ThreadLocal机制" class="headerlink" title="Handler/Looper/Message Queue/ThreadLocal机制"></a>Handler/Looper/Message Queue/ThreadLocal机制</h2><p>Android的消息机制主要是指Handler的运行机制，Handler的运行需要底层的MessageQueue和Looper的支撑</p>
<p>虽然MessageQueue叫做消息队列，但是实际上它内部的存储结构是单链表的方式。由于Message只是一个消息的存储单元，它不能去处理消息，这个时候Looper就弥补了这个功能，Looper会以无限循环的形式去查找是否有新消息，如果有的话就处理消息，否则就一直等待（机制等会介绍）。而对于Looper来说，存在着另外的一个很重要的概念，就是ThreadLocal。</p>
<h2 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h2><p>ThreadLocal它并不是一个线程，而是一个可以在每个线程中存储数据的数据存储类，通过它可以在指定的线程中存储数据，数据存储之后，只有在指定线程中可以获取到存储的数据，对于其他线程来说则无法获取到该线程的数据。<br>举个例子，多个线程通过同一个ThreadLocal获取到的东西是不一样的，就算有的时候出现的结果是一样的（偶然性，两个线程里分别存了两份相同的东西），但他们获取的本质是不同的。</p>
<p>那为什么有这种区别呢？为什么要这样设计呢？<br>先来研究一下为什么会出现这个结果。<br>在ThreadLocal中存在着两个很重要的方法，get和set方法，一个读取一个设置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">    * Returns the value of this variable for the current thread. If an entry</span><br><span class="line">    * doesn't yet exist for this variable on this thread, this method will</span><br><span class="line">    * create an entry, populating the value with the result of</span><br><span class="line">    * &#123;<span class="doctag">@link</span> #initialValue()&#125;.</span><br><span class="line">    *</span><br><span class="line">    * <span class="doctag">@return</span> the current value of the variable for the calling thread.</span><br><span class="line">    */</span></span><br><span class="line">   <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// Optimized for the fast path.</span></span><br><span class="line">       Thread currentThread = Thread.currentThread();</span><br><span class="line">       Values values = values(currentThread);</span><br><span class="line">       <span class="keyword">if</span> (values != <span class="keyword">null</span>) &#123;</span><br><span class="line">           Object[] table = values.table;</span><br><span class="line">           <span class="keyword">int</span> index = hash &amp; values.mask;</span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">this</span>.reference == table[index]) &#123;</span><br><span class="line">               <span class="keyword">return</span> (T) table[index + <span class="number">1</span>];</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           values = initializeValues(currentThread);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> (T) values.getAfterMiss(<span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">    * Sets the value of this variable for the current thread. If set to</span><br><span class="line">    * &#123;<span class="doctag">@code</span> null&#125;, the value will be set to null and the underlying entry will</span><br><span class="line">    * still be present.</span><br><span class="line">    *</span><br><span class="line">    * <span class="doctag">@param</span> value the new value of the variable for the caller thread.</span><br><span class="line">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">       Thread currentThread = Thread.currentThread();</span><br><span class="line">       Values values = values(currentThread);</span><br><span class="line">       <span class="keyword">if</span> (values == <span class="keyword">null</span>) &#123;</span><br><span class="line">           values = initializeValues(currentThread);</span><br><span class="line">       &#125;</span><br><span class="line">       values.put(<span class="keyword">this</span>, value);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>摘自源码<br>首先研究它的get方法吧，从注释上可以看出，get方法会返回一个当前线程的变量值，如果数组不存在就会创建一个新的。<br>这里有几个很重要的词，就是“当前线程”和“数组”。<br>这里提到的数组对于每个线程来说都是不同的，values.table，而values是通过当前线程获取到的一个Values对象，因此这个数组是每个线程唯一的，不能共用，而下面的几句话也更直接了，获取一个索引，再返回通过这个索引找到数组中对应的值。这也就解释了为什么多个线程通过同一个ThreadLocal返回的是不同的东西。</p>
<p>那这里为什么要这么设置呢？翻了一下书，搜了一下资料：</p>
<ul>
<li>ThreadLocal在日常开发中使用到的地方较少，但是在某些特殊的场景下，通过ThreadLocal可以轻松实现一些看起来很复杂的功能。一般来说，当某些数据是以线程为作用域并且不同线程具有不同的数据副本的时候，就可以考虑使用ThreadLocal。例如在Handler和Looper中。对于Handler来说，它需要获取当前线程的Looper，很显然Looper的作用域就是线程并且不同的线程具有不同的Looper，这个时候通过ThreadLocal就可以轻松的实现Looper在线程中的存取。如果不采用ThreadLocal，那么系统就必须提供一个全局的哈希表供Handler查找指定的Looper，这样就比较麻烦了，还需要一个管理类。</li>
<li>ThreadLocal的另一个使用场景是复杂逻辑下的对象传递，比如监听器的传递，有些时候一个线程中的任务过于复杂，就可能表现为函数调用栈比较深以及代码入口的多样性，这种情况下，我们又需要监听器能够贯穿整个线程的执行过程。这个时候就可以使用到ThreadLocal，通过ThreadLocal可以让监听器作为线程内的全局对象存在，在线程内通过get方法就可以获取到监听器。如果不采用的话，可以使用参数传递，但是这种方式在设计上不是特别好，当调用栈很深的时候，通过参数来传递监听器这个设计太糟糕。而另外一种方式就是使用static静态变量的方式，但是这种方式存在一定的局限性，拓展性并不是特别的强。比如有10个线程在执行，就需要提供10个监听器对象。</li>
</ul>
<h2 id="消息机制"><a href="#消息机制" class="headerlink" title="消息机制"></a>消息机制</h2><p>上面提到了Handler/Looper/Message Queue，它们实际上是一个整体，只不过我们在开发中接触更多的是Handler而已，Handler的主要作用是将一个任务切换到某个指定的线程中去执行，而Android之所以提供这个机制是因为Android规定UI只能在主线程中进程，如果在子线程中访问UI就会抛出异常。</p>
<p><strong>为什么Android不允许在子线程访问UI</strong><br>其实这一点不仅仅是对于Android,对于其他的所有图形界面现在都采用的是单线程模式。<br>因为对于一个多线程来说，如果子线程更改了UI，那么它的相关操作就必须对其他子线程可见，也就是Java并发中很重要的一个概念，线程可见性，Happen-before原则<strong>【下篇博客总结一下自己对Java并发的理解吧，挺重要的，总结完后再把传送门贴过来】</strong>而一般来说，对于这种并发访问，一般都是采用加锁的机制，但是加锁的机制存在很明显的问题：让UI访问间的逻辑变得复杂，同时效率也会降低。甚至有的时候还会造成死锁的情况，这个时候就麻烦了。<br>而至于究竟能不能够实现这种UI界面的多线程呢？SUN公司的某个大牛（忘了是谁，很久之前看的，好像是前副总裁）说：“行肯定是没问题，但是非常考技术，因为必须要考虑到很多种情况，这个时候就需要技术专家来设计。而这种设计出来的东西对于广大普通程序员来说又是异常头疼的，就算是实现了多线程，普通人用起来也是怨声载道的。所以建议还是单线程”。</p>
<h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><p>顺带着BB一下死锁。</p>
<p><strong>死锁的四个必要条件</strong></p>
<ol>
<li>互斥条件：资源不能被共享，只能被同一个进程使用</li>
<li>请求与保持条件：已经得到资源的进程可以申请新的资源</li>
<li>非剥夺条件：已经分配的资源不能从相应的进程中被强制剥夺</li>
<li>循环等待条件：系统中若干进程组成环路，该环路中每个进程都在等待相邻进程占用的资源</li>
</ol>
<p>举个常见的死锁例子：进程A中包含资源A,进程B中包含资源B，A的下一步需要资源B，B的下一步需要资源A，所以它们就互相等待对方占有的资源释放，所以也就产生了一个循环等待死锁。</p>
<p><strong>处理死锁的方法</strong></p>
<ol>
<li>忽略该问题，也就是鸵鸟算法。当发生了什么问题时，不管他，直接跳过，无视它。</li>
<li>检测死锁并恢复</li>
<li>资源进行动态分配</li>
<li>破除上面的四种死锁条件之一</li>
</ol>
<h2 id="继续消息机制"><a href="#继续消息机制" class="headerlink" title="继续消息机制"></a>继续消息机制</h2><p>MessageQueue主要包含两个操作：插入和读取，读取操作本身会伴随着删除操作，插入和读取对应的方法分别为enqueueMessage和next，其中enqueueMessage的作用是往消息队列中插入一条消息，而next的作用是从消息队列中取出一条消息并将其从消息队列中移除。这也就是为什么使用的是一个单链表的数据结构来维护消息列表，因为它在插入和删除上比较有优势（把下一个连接的点切换一下就完成了）。</p>
<p>而对于MessageQueue的插入操作来说，没什么可以看的，也就这样吧，主要需要注意的是它的读取方法next。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// Return here if the message loop has already quit and been disposed.</span></span><br><span class="line">       <span class="comment">// This can happen if the application tries to restart a looper after quit</span></span><br><span class="line">       <span class="comment">// which is not supported.</span></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">long</span> ptr = mPtr;</span><br><span class="line">       <span class="keyword">if</span> (ptr == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">int</span> pendingIdleHandlerCount = -<span class="number">1</span>; <span class="comment">// -1 only during first iteration</span></span><br><span class="line">       <span class="keyword">int</span> nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">           <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</span><br><span class="line">               Binder.flushPendingCommands();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">               <span class="comment">// Try to retrieve the next message.  Return if found.</span></span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">               Message prevMsg = <span class="keyword">null</span>;</span><br><span class="line">               Message msg = mMessages;</span><br><span class="line">               <span class="keyword">if</span> (msg != <span class="keyword">null</span> &amp;&amp; msg.target == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span></span><br><span class="line">                   do &#123;</span><br><span class="line">                       prevMsg = msg;</span><br><span class="line">                       msg = msg.next;</span><br><span class="line">                   &#125; <span class="keyword">while</span> (msg != <span class="keyword">null</span> &amp;&amp; !msg.isAsynchronous());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (now &lt; msg.when) &#123;</span><br><span class="line">                       <span class="comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span></span><br><span class="line">                       nextPollTimeoutMillis = (<span class="keyword">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="comment">// Got a message.</span></span><br><span class="line">                       mBlocked = <span class="keyword">false</span>;</span><br><span class="line">                       <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                           prevMsg.next = msg.next;</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           mMessages = msg.next;</span><br><span class="line">                       &#125;</span><br><span class="line">                       msg.next = <span class="keyword">null</span>;</span><br><span class="line">                       <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Returning message: "</span> + msg);</span><br><span class="line">                       msg.markInUse();</span><br><span class="line">                       <span class="keyword">return</span> msg;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// No more messages.</span></span><br><span class="line">                   nextPollTimeoutMillis = -<span class="number">1</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// Process the quit message now that all pending messages have been handled.</span></span><br><span class="line">               <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">                   dispose();</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// If first time idle, then get the number of idlers to run.</span></span><br><span class="line">               <span class="comment">// Idle handles only run if the queue is empty or if the first message</span></span><br><span class="line">               <span class="comment">// in the queue (possibly a barrier) is due to be handled in the future.</span></span><br><span class="line">               <span class="keyword">if</span> (pendingIdleHandlerCount &lt; <span class="number">0</span></span><br><span class="line">                       &amp;&amp; (mMessages == <span class="keyword">null</span> || now &lt; mMessages.when)) &#123;</span><br><span class="line">                   pendingIdleHandlerCount = mIdleHandlers.size();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="comment">// No idle handlers to run.  Loop and wait some more.</span></span><br><span class="line">                   mBlocked = <span class="keyword">true</span>;</span><br><span class="line">                   <span class="keyword">continue</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (mPendingIdleHandlers == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   mPendingIdleHandlers = <span class="keyword">new</span> IdleHandler[Math.max(pendingIdleHandlerCount, <span class="number">4</span>)];</span><br><span class="line">               &#125;</span><br><span class="line">               mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Run the idle handlers.</span></span><br><span class="line">           <span class="comment">// We only ever reach this code block during the first iteration.</span></span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;</span><br><span class="line">               <span class="keyword">final</span> IdleHandler idler = mPendingIdleHandlers[i];</span><br><span class="line">               mPendingIdleHandlers[i] = <span class="keyword">null</span>; <span class="comment">// release the reference to the handler</span></span><br><span class="line"></span><br><span class="line">               <span class="keyword">boolean</span> keep = <span class="keyword">false</span>;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   keep = idler.queueIdle();</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                   Log.wtf(TAG, <span class="string">"IdleHandler threw exception"</span>, t);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (!keep) &#123;</span><br><span class="line">                   <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                       mIdleHandlers.remove(idler);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Reset the idle handler count to 0 so we do not run them again.</span></span><br><span class="line">           pendingIdleHandlerCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// While calling an idle handler, a new message could have been delivered</span></span><br><span class="line">           <span class="comment">// so go back and look again for a pending message without waiting.</span></span><br><span class="line">           nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>源码有点长，总结一下就是：<br>next方法它是一个死循环，如果消息队列中没有消息，那么next方法就会一直阻塞在这里，当有新的消息来的时候，next方法就会返回这条信息并将其从单链表中移除。</p>
<p>而这个时候勒Looper就等着的，它也是一直循环循环，不停地从MessageQueue中查看是否有新消息，如果有新消息就会立刻处理，否则就会一直阻塞在那里。而对于Looper来说，它是只能创建一个的，这个要归功与它的prepare方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Initialize the current thread as a looper.</span><br><span class="line">     * This gives you a chance to create handlers that then reference</span><br><span class="line">     * this looper, before actually starting the loop. Be sure to call</span><br><span class="line">     * &#123;<span class="doctag">@link</span> #loop()&#125; after calling this method, and end it by calling</span><br><span class="line">     * &#123;<span class="doctag">@link</span> #quit()&#125;.</span><br><span class="line">     */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       prepare(<span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>从这里我们就可以看出该prepare方法会首先检测是否已经存在looper了，如果不存在，就创建一个新的；如果存在，就抛出异常。<br>而之后使用Looper.loop()就可以开启消息循环了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">   * Run the message queue in this thread. Be sure to call</span><br><span class="line">   * &#123;<span class="doctag">@link</span> #quit()&#125; to end the loop.</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> Looper me = myLooper();</span><br><span class="line">      <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">final</span> MessageQueue queue = me.mQueue;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Make sure the identity of this thread is that of the local process,</span></span><br><span class="line">      <span class="comment">// and keep track of what that identity token actually is.</span></span><br><span class="line">      Binder.clearCallingIdentity();</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">          Message msg = queue.next(); <span class="comment">// might block</span></span><br><span class="line">          <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line">          Printer logging = me.mLogging;</span><br><span class="line">          <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">              logging.println(<span class="string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="string">" "</span> +</span><br><span class="line">                      msg.callback + <span class="string">": "</span> + msg.what);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          msg.target.dispatchMessage(msg);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">              logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="string">" "</span> + msg.callback);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Make sure that during the course of dispatching the</span></span><br><span class="line">          <span class="comment">// identity of the thread wasn't corrupted.</span></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</span><br><span class="line">          <span class="keyword">if</span> (ident != newIdent) &#123;</span><br><span class="line">              Log.wtf(TAG, <span class="string">"Thread identity changed from 0x"</span></span><br><span class="line">                      + Long.toHexString(ident) + <span class="string">" to 0x"</span></span><br><span class="line">                      + Long.toHexString(newIdent) + <span class="string">" while dispatching to "</span></span><br><span class="line">                      + msg.target.getClass().getName() + <span class="string">" "</span></span><br><span class="line">                      + msg.callback + <span class="string">" what="</span> + msg.what);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          msg.recycleUnchecked();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>从这里面我们可以看到它也是个死循环，会不停的调用queue.next()方法来获取信息，如果没有，就return,如果有就处理。</p>
<p><strong>注意</strong><br>当然了，这里有一个很重要的点，一般可能会忘，那就是在子线程中如果手动为其创建了Looper，那么在所有的事情完成以后应该调用quit方法来终止消息循环，否则这个子线程就会一直处于等待状态，而如果退出Looper之后，这个线程就会立刻终止，所以建议不需要使用的时候终止Looper。</p>
<p><strong>Handler</strong><br>上面总结了Looper和MessageQueue，这里就对Handler进行一个总结吧。它的工作主要包含消息的发送和接受过程，消息的发送可以通过post的一系列方法以及send的一系列方法来实现，post的一系列方法最终是通过send的一系列方法来实现的。<br>实际上它发送消息的过程仅仅是向消息队列中插入了一条消息，MessageQueue的next方法就会返回这条消息给Looper，Looper在收到消息之后就会开始处理了。最后由Looper交给Handler处理（handleMessage()方法）。</p>
<h2 id="IPC通信"><a href="#IPC通信" class="headerlink" title="IPC通信"></a>IPC通信</h2><p>上面总结完了Android的消息处理机制，那么就顺带总结一下IPC通信吧，毕竟上面提到过那么多次Binder和Socket。</p>
<p>资料：<a href="https://www.zhihu.com/question/39440766#answer-31119460" target="_blank" rel="external">为什么Android要采用Binder作为IPC机制？</a><br>知乎上面的回答相当的好，这个博主对系统底层也是颇有钻研，学习。</p>
<p>这里就结合上面的知乎回答以及加上《Linux程序设计》还有一本Linux内核剖析（书名忘了但是讲得真的非常好），掺杂一些个人的理解。</p>
<p><strong>进程的定义</strong><br>UNIX标准把进程定义为：“一个其中运行着一个或多个进程的地址控件和这些线程所需要的系统资源”。目前，可以简单的把进程看做正在运行的程序。</p>
<p>进程都会被分配一个唯一的数字编号，我们成为PID（也就是进程标识符），它通常是一个取值范围从2到32768的正整数。当进程被启动时，系统将按顺序选择下一个未被使用的数字作为PID，当数字已经回绕一圈时，新的PID重新从2开始，数字1一般是为init保留的。在进程中，存在一个自己的栈空间，用于保存函数中的局部变量和控制函数的调用与返回。进程还有自己的环境空间，包含专门为这个进程建立的环境变量，同时还必须要维护自己的程序计数器，这个计数器用来记录它执行到的位置，即在执行线程中的位置。<br>在Linux中可以通过system函数来启动一个进程</p>
<p><strong>守护进程</strong><br>这里就需要提到一个守护进程了，这个在所有的底层中经常都会被提到。<br>在linux或者unix操作系统中在系统引导的时候会开启很多服务，这些服务就叫做守护进程。为了增加灵活性，root可以选择系统开启的模式，这些模式叫做运行级别，每一种运行级别以一定的方式配置系统。 守护进程是脱离于终端并且在后台运行的进程。守护进程脱离于终端是为了避免进程在执行过程中的信息在任何终端上显示并且进程也不会被任何终端所产生的终端信息所打断。<br>守护进程常常在系统引导装入时启动，在系统关闭时终止。如果想要某个进程不因为用户或终端或其他的变化而受到影响，那么就必须把这个进程变成一个守护进程</p>
<p><strong>防止手机服务后台被杀死</strong><br>是不是在手机的设置界面看当前正在运行的服务时会发现有的APP不止存在一个服务？有的APP后台存在两个，有的存在三个？有的流氓软件也会这么设置，这样的话就可以一直运行在后台，用户你关也关不了（倒不是说所有这么设置的都是流氓软件，因为有的软件需要保持一个长期的后台在线，这是由功能决定的）。</p>
<p>这里有两种方法（可能还有更多，这里只总结我了解的）：</p>
<ul>
<li>第一种方法就是利用android中service的特性来设置，防止手机服务后台被杀死。通过更改onStartCommand方法的返回值，将service设置为粘性service，那么当service被kill的时候就会将服务的状态返回到最开始启动的状态，也就是运行的状态，所以这个时候也就会再次重新运行。但是需要注意一点，这个时候的intent值就为空了，获取的话需要注意一下这一点。</li>
<li>第二种就是fork出一个C的进程，因为在Linux中，子类进程在父类被杀死销毁的时候不会随之杀死，它会被init进程领养。所以也就可以使用这一个方法，利用主进程fork出一个C进程在后台运行，一旦检测到服务被杀死（检测的方式多种，可使用观察者模式，广播，轮询等等），就重启服务即可</li>
</ul>
<p><strong>IPC通信</strong><br>上面总结了进程的相关基础，这里就开始总结一下进程间通信（IPC<br>）的问题了。<br>现在Linux现有的所有IPC方式：</p>
<ol>
<li>管道：在创建时分配一个page大小的内存，缓存区大小有限</li>
<li>消息队列：信息复制两次，额外的cpu消耗，不适合频繁或信息量大的通信</li>
<li>共享内存：无需复制，共享缓冲区直接附加到进程虚拟地址控件，速度是在所有IPC通信中最快的。但是进程间的同步问题操作系统无法实现，必须由各进程利用同步工具解决。</li>
<li>Socket：作为更通用的接口，传输效率低，主要用于不通机器或跨网络的通信</li>
<li>信号量：常作为一种锁机制。</li>
<li>信号：不适用于信息交换，更适用于进程件中断控制，例如kill process</li>
</ol>
<p>到了这里，就有了问题，为什么在Linux已经存在这么多优良的IPC方案时，Android还要采取一种新的Binder机制呢？<br><strong>猜测</strong>：我觉得Android采用这种新的方式（当然也大面积的同时使用Linux的IPC通信方式），最多两个原因：</p>
<ol>
<li>推广时手机厂商自定义ROM底层的保密性或者公司之间的关系。</li>
<li>在某些情况下更适合手机这种低配置，对效率要求极高，用户体验极其重要的设备</li>
</ol>
<p><strong>资料</strong></p>
<p>对于Binder来说，存在着以下的优势：</p>
<ul>
<li><strong>性能角度</strong>：Binder的数据拷贝只需要一次，而管道、消息队列、Socket都需要2次，而共享内存是一次都不需要拷贝，因此Binder的性能仅次于共享内存</li>
<li><strong>稳定性来说</strong>：Binder是基于C/S架构的，也就是Client和Server组成的架构，Client端有什么需求，直接发送给Server端去完成，架构清晰，分工明确。而共享内存的实现方式复杂，需要充分考虑访问临界资源的并发同步问题，否则可能会出现死锁等问题。从稳定性来说，Binder的架构优于共享内存。</li>
<li><strong>从安全的角度</strong>：Linux的传统IPC方式的接收方无法获得对方进程可靠的UID（用户身份证明）/PID（进程身份证明），从而无法鉴别对方身份，而Android是一个对安全性能要求特别高的操作系统，在系统层面需要对每一个APP的权限进行管控或者监视，对于普通用户来说，绝对不希望从App商店下载偷窥隐射数据、后台造成手机耗电等问题。传统的Linux IPC无任何保护措施，完全由上层协议来确保。而在Android中，操作系统为每个安装好的应用程序分配了自己的UID，通过这个UID可以鉴别进程身份。同时Android系统对外只暴露Client端，Client端将任务发送给Server端，Server端会根据权限控制策略判断UID/PID是否满足访问权限。也就是说Binder机制对于通信双方的身份是内核进行校验支持的。例如Socket方式只需要指导地址就可以连接，他们的安全机制需要上层协议来假设</li>
<li><strong>从语言角度</strong>：Linux是基于C的，而Android是基于Java的，而Binder是符合面向对象思想的。它的实体位于一个进程中，而它的引用遍布与系统的各个进程之中，它是一个跨进程引用的对象，模糊了进程边界，淡化了进程通信的过程，整个系统仿佛运行于同一个面向对象的程序之中。</li>
<li><strong>从公司角度</strong>：Linux内核是开源的，GPL协议保护，受它保护的Linux Kernel是运行在内核控件，对于上层的任何类库、服务等只要进行系统调用，调用到底层Kernel，那么也必须遵循GPL协议。而对于Android来说，Google巧妙地将GPL协议控制在内核控件，将用户控件的协议采用Apache-2.0协议（允许基于Android的开发商不向社区反馈源码）。</li>
</ul>
<h2 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h2><p>刚才谈到Binder的时候提了一下效率的问题，那这里就不得不讲到反射了。</p>
<p>反射它允许一个类在运行过程中获得任意类的任意方法，这个是Java语言的一个很重要的特性。它方便了程序员的编写，但是降低了效率。</p>
<p>实际上，对于只要不是特别大的项目（非Android），反射对于效率的影响微乎其微，而与之对比的开发成本来说就更划算了。<br>但是，Android是一个用于手机的，它的硬件设施有限，我们必须要考虑到它的这个因素，用户体验是最重要的。以前看到过国外的一项统计。在一个APP中的Splash中使用了反射，结果运行时间增加了一秒，这个已经算是很严重的效率影响了。</p>
<p><strong>为什么反射影响效率呢</strong><br>这里就需要提到一个东西，JIT编译器。JIT编译器它可以把字节码文件转换为机器码，这个是可以直接让处理器使用的，经过它处理的字节码效率提升非常大，但是它有一个缺点，就是把字节码转换成机器码的过程很慢，有的时候甚至还超过了不转换的代码效率（转换之后存在一个复用的问题，对于转换了的机器码，使用的次数越多就越值的）。因此，在JVM虚拟机中，也就产生了一个机制，把常用的、使用频率高的字节码通过JIT编译器转换，而频率低的就不管它。而反射的话则是直接越过了JIT编译器，不管是常用的还是非常用的字节码一律没有经过JIT编译器的转化，所以效率就会低。<br>而在Android里面，5.0之前使用的是Davlik虚拟机，它就是上面的机制，而在Android5.0之后Google使用了一个全新的ART虚拟机全面代替Davlik虚拟机。<br>ART虚拟机会在程序安装时直接把所有的字节码全部转化为机器码，虽然这样会导致安装时间边长，但是程序运行的效率提升非常大。<br><strong>【疑问：那在Android5.0之后的系统上，反射会不会没影响了？由于现在做项目的时候更多考虑的是向下兼容，单独考虑5.0的情况还没有，等以后有需求或者是有机会的时候再深入了解一下，以后更新】</strong></p>
<h2 id="继续断点4"><a href="#继续断点4" class="headerlink" title="继续断点4"></a>继续断点4</h2><p>刚才总结了Android的消息处理机制和IPC通信，那么我们主线程的消息处理机制是什么时候开始的呢？因为我们知道在主线程中我们是不需要手动调用Looper.prepare()和Looper.loop()的。</p>
<p>Android的主线程就是ActivityThread，主线程的入口方法是main方法，在main方法中系统会通过Looper.prepareMainLooper()来创建主线程的Looper以及MessageQueue，并通过Looper.loop来开启消息循环，所以这一步实际上是系统已经为我们做了，我们就不再需要自己来做。<br>ActivityThread通过AppplicationThread和AMS进行进程件通信，AMS以进程间通信的方式完成ActivityThread的请求后会回调ApplicationThread中的Binder方法，然后ApplicationThread会向Handler发送消息，Handler收到消息后会将ApplicationThread中的逻辑切换到主线程中去执行，这个过程就是主线程的消息循环模型。</p>
<p>上面总结到了APP开始运行，依次调用onCreate/onStart/onResume等方法，那么在onCreate方法中我们经常使用的setContentView和findViewById做了什么事呢？</p>
<p>Activity界面显示<br>-<br>首先，就考虑到第一个问题，也就是setContentView这个东西做了什么事，这里就要对你当前继承的Activity分类了，如果是继承的Activity，那么setContentView源码是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Set the activity content from a layout resource.  The resource will be</span><br><span class="line"> * inflated, adding all top-level views to the activity.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> layoutResID Resource ID to be inflated.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@see</span> #setContentView(android.view.View)</span><br><span class="line"> * <span class="doctag">@see</span> #setContentView(android.view.View, android.view.ViewGroup.LayoutParams)</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(@LayoutRes <span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">    getWindow().setContentView(layoutResID);</span><br><span class="line">    initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Set the activity content to an explicit view.  This view is placed</span><br><span class="line"> * directly into the activity's view hierarchy.  It can itself be a complex</span><br><span class="line"> * view hierarchy.  When calling this method, the layout parameters of the</span><br><span class="line"> * specified view are ignored.  Both the width and the height of the view are</span><br><span class="line"> * set by default to &#123;<span class="doctag">@link</span> ViewGroup.LayoutParams#MATCH_PARENT&#125;. To use</span><br><span class="line"> * your own layout parameters, invoke</span><br><span class="line"> * &#123;<span class="doctag">@link</span> #setContentView(android.view.View, android.view.ViewGroup.LayoutParams)&#125;</span><br><span class="line"> * instead.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> view The desired content to display.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@see</span> #setContentView(int)</span><br><span class="line"> * <span class="doctag">@see</span> #setContentView(android.view.View, android.view.ViewGroup.LayoutParams)</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    getWindow().setContentView(view);</span><br><span class="line">    initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Set the activity content to an explicit view.  This view is placed</span><br><span class="line"> * directly into the activity's view hierarchy.  It can itself be a complex</span><br><span class="line"> * view hierarchy.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> view The desired content to display.</span><br><span class="line"> * <span class="doctag">@param</span> params Layout parameters for the view.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@see</span> #setContentView(android.view.View)</span><br><span class="line"> * <span class="doctag">@see</span> #setContentView(int)</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">    getWindow().setContentView(view, params);</span><br><span class="line">    initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面存在着3个重载函数，而不管你调用哪一个，最后都会调用到initWindowDecorActionBar()这个方法。<br>而对于新的一个AppcompatActivity，这个Activity里面包含了一些新特性，现在我做的项目里基本都是使用AppcompatActivity代替掉原来的Activity，当然也并不是一定的，还是要根据项目的实际情况来选择。<br>在AppcompatActivity中，setContentView是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(@LayoutRes <span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">       getDelegate().setContentView(layoutResID);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">       getDelegate().setContentView(view);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">       getDelegate().setContentView(view, params);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>一样的3个重载函数，只是里面没有了上面的那个init方法，取而代之的是一个getDelegate().setContentView，这个delegate从字面上可以了解到它是一个委托的对象，源码是这样的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">    * <span class="doctag">@return</span> The &#123;<span class="doctag">@link</span> AppCompatDelegate&#125; being used by this Activity.</span><br><span class="line">    */</span></span><br><span class="line">   <span class="meta">@NonNull</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> AppCompatDelegate <span class="title">getDelegate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mDelegate == <span class="keyword">null</span>) &#123;</span><br><span class="line">           mDelegate = AppCompatDelegate.create(<span class="keyword">this</span>, <span class="keyword">this</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> mDelegate;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>而在AppCompatDelegate.Create方法中，则会返回一个很有意思的东西：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">     * Create a &#123;<span class="doctag">@link</span> android.support.v7.app.AppCompatDelegate&#125; to use with &#123;<span class="doctag">@code</span> activity&#125;.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> callback An optional callback for AppCompat specific events</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppCompatDelegate <span class="title">create</span><span class="params">(Activity activity, AppCompatCallback callback)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> create(activity, activity.getWindow(), callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> AppCompatDelegate <span class="title">create</span><span class="params">(Context context, Window window,</span><br><span class="line">            AppCompatCallback callback)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> sdk = Build.VERSION.SDK_INT;</span><br><span class="line">        <span class="keyword">if</span> (sdk &gt;= <span class="number">23</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AppCompatDelegateImplV23(context, window, callback);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sdk &gt;= <span class="number">14</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AppCompatDelegateImplV14(context, window, callback);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sdk &gt;= <span class="number">11</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AppCompatDelegateImplV11(context, window, callback);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AppCompatDelegateImplV7(context, window, callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里会根据SDK的等级来返回不同的东西，这样的话就不深究了，底层的话我撇了一下，应该原理和Activity是一样的，可能存在一些区别。这里就用Activity来谈谈它的setContentView方法做了什么事。</p>
<p>在setContentView上面有段注释：</p>
<blockquote>
<p>Set the activity content from a layout resource.  The resource will be inflated, adding all top-level views to the activity.</p>
</blockquote>
<p>这里就介绍了它的功能，它会按照一个布局资源去设置Activity的内容，而这个布局资源将会被引入然后添加所有顶级的Views到这个Activity当中。<br>这是个啥意思勒。<br>下面从网上扒了一张图：<br><img src="http://img.blog.csdn.net/20150604144532934" alt="dsa"><br>这里是整个Activity的层级，最外面一层是我们的Activity，它包含里面的所有东西。<br>再上一层是一个PhoneWindow，这个PhoneWindow是由Window类派生出来的，每一个PhoneWindow中都含有一个DecorView对象，Window是一个抽象类。<br>再上面一层就是一个DecorView，我理解这个DecorView就是一个ViewGroup，就是装View的。<br>而在DecoreView中，最上面的View就是我们的TitleActionBar，下面就是我们要设置的content。所以在上面的initWindowDecorActionBar就能猜到是什么意思了吧。</p>
<p>而在initWindowDecorActionBar方法中，有一段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">    * Creates a new ActionBar, locates the inflated ActionBarView,</span><br><span class="line">    * initializes the ActionBar with the view, and sets mActionBar.</span><br><span class="line">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initWindowDecorActionBar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       Window window = getWindow();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Initializing the window decor can change window feature flags.</span></span><br><span class="line">       <span class="comment">// Make sure that we have the correct set before performing the test below.</span></span><br><span class="line">       window.getDecorView();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (isChild() || !window.hasFeature(Window.FEATURE_ACTION_BAR) || mActionBar != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       mActionBar = <span class="keyword">new</span> WindowDecorActionBar(<span class="keyword">this</span>);</span><br><span class="line">       mActionBar.setDefaultDisplayHomeAsUpEnabled(mEnableDefaultActionBarUp);</span><br><span class="line"></span><br><span class="line">       mWindow.setDefaultIcon(mActivityInfo.getIconResource());</span><br><span class="line">       mWindow.setDefaultLogo(mActivityInfo.getLogoResource());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>注意上面的window.getDecoreView（）方法的注释，该方法会设置一些window的标志位，而当这个方法执行完之后，就再也不能更改了，这也就是为什么很多第三方SDK设置window的标志位时一定要求要在setContentView方法前调用。</p>
<h2 id="findViewById"><a href="#findViewById" class="headerlink" title="findViewById"></a>findViewById</h2><p>我们通过一个findViewById方法可以实现对象的绑定，那它底层究竟是怎么实现的呢？</p>
<p>findViewById根据继承的Activity类型的不同也存在着区别，老规矩，还是以Activity的来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">     * Finds a view that was identified by the id attribute from the XML that</span><br><span class="line">     * was processed in &#123;<span class="doctag">@link</span> #onCreate&#125;.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> The view if found or null otherwise.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">findViewById</span><span class="params">(@IdRes <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getWindow().findViewById(id);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>从源码来看，findViewById也是经过了一层层的调用，它的功能如同它上面的注释一样，通过一个view的id属性查找view，这里也可以看到一个熟悉的getWindow方法，说明findViewById()实际上Activity把它也是交给了自己的window来做<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">    * Finds a view that was identified by the id attribute from the XML that</span><br><span class="line">    * was processed in &#123;<span class="doctag">@link</span> android.app.Activity#onCreate&#125;.  This will</span><br><span class="line">    * implicitly call &#123;<span class="doctag">@link</span> #getDecorView&#125; for you, with all of the</span><br><span class="line">    * associated side-effects.</span><br><span class="line">    *</span><br><span class="line">    * <span class="doctag">@return</span> The view if found or null otherwise.</span><br><span class="line">    */</span></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> View <span class="title">findViewById</span><span class="params">(@IdRes <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> getDecorView().findViewById(id);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>而在这里面，又调用了getDecorView的findViewById（）方法，这也相当于是一个层层传递的过程，因为DecorView我理解为就是一个ViewGroup，而当运行getDecorView().findViewById()方法时，就会运行View里面的findViewById方法。它会使用这个被给予的id匹配子View的Id，如果匹配，就返回这个View，完成View的绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">     * Look for a child view with the given id.  If this view has the given</span><br><span class="line">     * id, return this view.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> id The id to search for.</span><br><span class="line">     * <span class="doctag">@return</span> The view that has the given id in the hierarchy or null</span><br><span class="line">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> View <span class="title">findViewById</span><span class="params">(@IdRes <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> findViewTraversal(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">     * &#123;<span class="doctag">@hide</span>&#125;</span><br><span class="line">     * <span class="doctag">@param</span> id the id of the view to be found</span><br><span class="line">     * <span class="doctag">@return</span> the view of the specified id, null if cannot be found</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> View <span class="title">findViewTraversal</span><span class="params">(@IdRes <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (id == mID) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>最后总结一下（Activity中），findViewById的过程是这样的：<br>Activity -&gt; Window -&gt; DecorView -&gt; View </p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.zhihu.com/question/39440766#answer-31119460" target="_blank" rel="external">为什么Android要采用Binder作为IPC机制？</a></li>
<li><a href="http://blog.csdn.net/zhaokaiqiang1992/article/details/49428287" target="_blank" rel="external">【凯子哥带你学Framework】Activity启动过程全解析</a></li>
<li><a href="http://gityuan.com/" target="_blank" rel="external">Gityuan</a></li>
<li>《Android开发艺术探索》</li>
<li>《Linux程序设计》</li>
<li>《Linux内核剖析》</li>
</ul>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/04/13/个人知识点总结——Java并发/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          个人知识点总结——Java并发
        
      </div>
    </a>
  
  
    <a href="/2016/04/09/ArrayList/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">【异同】 Android与JDK中的ArrayList</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="杂谈——Android从启动到程序运行发生的事情" data-title="杂谈——Android从启动到程序运行发生的事情" data-url="http://imlzq.com/2016/04/12/杂谈——Android从启动到程序运行发生的事情/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 CytQ
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>杂谈——Android从启动到程序]]>
    </summary>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://imlzq.com/2018/02/11/2016/04/12/%E5%8E%9F-%E6%9D%82%E8%B0%88%E2%80%94%E2%80%94Android%E4%BB%8E%E5%90%AF%E5%8A%A8%E5%88%B0%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA%8B%E6%83%85/index/"/>
    <id>http://imlzq.com/2018/02/11/2016/04/12/原-杂谈——Android从启动到程序运行发生的事情/index/</id>
    <published>2018-02-11T08:42:33.525Z</published>
    <updated>2018-02-11T08:42:33.526Z</updated>
    <content type="html"><![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>杂谈——Android从启动到程序运行发生的事情 | Hello Mr.Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="转载请注明出处 
博客地址：http://imlzq.com/2016/04/12/%E5%8E%9F-%E6%9D%82%E8%B0%88%E2%80%94%E2%80%94Android%E4%BB%8E%E5%90%AF%E5%8A%A8%E5%88%B0%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA">
<meta property="og:type" content="article">
<meta property="og:title" content="杂谈——Android从启动到程序运行发生的事情">
<meta property="og:url" content="http://imlzq.com/2016/04/12/原-杂谈——Android从启动到程序运行发生的事情/index.html">
<meta property="og:site_name" content="Hello Mr.Li">
<meta property="og:description" content="转载请注明出处 
博客地址：http://imlzq.com/2016/04/12/%E5%8E%9F-%E6%9D%82%E8%B0%88%E2%80%94%E2%80%94Android%E4%BB%8E%E5%90%AF%E5%8A%A8%E5%88%B0%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA">
<meta property="og:image" content="http://gityuan.com/images/boot/android-arch1.png">
<meta property="og:image" content="http://img.blog.csdn.net/20150604144532934">
<meta property="og:updated_time" content="2016-05-14T11:21:30.745Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="杂谈——Android从启动到程序运行发生的事情">
<meta name="twitter:description" content="转载请注明出处 
博客地址：http://imlzq.com/2016/04/12/%E5%8E%9F-%E6%9D%82%E8%B0%88%E2%80%94%E2%80%94Android%E4%BB%8E%E5%90%AF%E5%8A%A8%E5%88%B0%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA">
<meta name="twitter:image" content="http://gityuan.com/images/boot/android-arch1.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/headicon.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ITStudieren</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Study, Note and Advance</p>
		
	
		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Articles</a></li>
				        
							<li><a href="/tags">Tags</a></li>
				        
							<li><a href="/aboutme">About me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
					        
								<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorithm/" style="font-size: 16.67px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 16.67px;">Android</a> <a href="/tags/Chinese/" style="font-size: 10px;">Chinese</a> <a href="/tags/Design-Pattern/" style="font-size: 20px;">Design Pattern</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 13.33px;">Java</a> <a href="/tags/Jvm/" style="font-size: 10px;">Jvm</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/Python/" style="font-size: 20px;">Python</a> <a href="/tags/Rxjava/" style="font-size: 13.33px;">Rxjava</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Study-Note/" style="font-size: 20px;">Study Note</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">ITStudieren</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/headicon.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">ITStudieren</h1>
			</hgroup>
			
			<p class="header-subtitle">Study, Note and Advance</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Articles</a></li>
		        
					<li><a href="/tags">Tags</a></li>
		        
					<li><a href="/aboutme">About me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itstudieren" title="github">github</a>
			        
						<a class="mail" target="_blank" href="/JonsTank2013@gmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-原-杂谈——Android从启动到程序运行发生的事情" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/12/原-杂谈——Android从启动到程序运行发生的事情/" class="article-date">
  	<time datetime="2016-04-11T16:10:06.000Z" itemprop="datePublished">2016-04-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      杂谈——Android从启动到程序运行发生的事情
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>转载请注明出处 </p>
<p>博客地址：<a href="http://imlzq.com/2016/04/12/%E5%8E%9F-%E6%9D%82%E8%B0%88%E2%80%94%E2%80%94Android%E4%BB%8E%E5%90%AF%E5%8A%A8%E5%88%B0%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA%8B%E6%83%85/">http://imlzq.com/2016/04/12/%E5%8E%9F-%E6%9D%82%E8%B0%88%E2%80%94%E2%80%94Android%E4%BB%8E%E5%90%AF%E5%8A%A8%E5%88%B0%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA%8B%E6%83%85/</a> </p>
<p>作者：李中权</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>好久没有写博客了，瞬间感觉好多学了的东西不进行一个自我的总结与消化总归变不成自己的。通过博客可能还可以找到一些当初在学习的时候没有想到的问题。想了半天，从大二上学期自学Android以来还没有对Android从启动到程序运行期间进行一个完整的归纳，刚好最近又学到了一些新东西，那就以这篇博客为媒介，总结一下从Android启动到程序运行期间发生的所有事吧。包括什么ClassLoader, JVM,IPC, 消息处理机制要是总结到了就顺带BB一下。但是这里就不包含很多细节了，比如为什么PMS内部为什么要这么构造，好处是什么，如果我来设计的话我会怎么设计啊这种暂时就不总结了，因为我觉得以我现在的水平还有学习精力来说把这些细节都一个个的弄清楚有点没抓住重点。现阶段还是先能够了解整个流程，有个大局观才是最重要的。至于以后如果有需要或者是有精力的时候再一个个的突破。</p>
<p><strong>发现本文的错误或者遗漏后会立刻更改</strong></p>
<a id="more"></a>
<h2 id="正式开始"><a href="#正式开始" class="headerlink" title="正式开始"></a>正式开始</h2><p>首先，我们知道，Android是基于Linux的一个操作系统，它可以分为五层，下面是它的层次架构图，可以记一下，因为后面应该会总结到SystemServer这些Application Framework层的东西 </p>
<p><img src="http://gityuan.com/images/boot/android-arch1.png" alt=""> </p>
<p>Android的五层架构从上到下依次是应用层，应用框架层，库层，运行时层以及Linux内核层。</p>
<p>而在Linux中，它的启动可以归为一下几个流程： </p>
<p>Boot Loader-》初始化内核-》。。。。。。 </p>
<p>当初始化内核之后，就会启动一个相当重要的祖先进程，也就是init进程，在Linux中所有的进程都是由init进程直接或间接fork出来的。</p>
<p>而对于Android来说，前面的流程都是一样的，而当init进程创建之后，会fork出一个Zygote进程，这个进程是所有Java进程的父进程。我们知道，Linux是基于C的，而Android是基于Java的（当然底层也是C）。所以这里就会fork出一个Zygote Java进程用来fork出其他的进程。<strong>【断点1】</strong></p>
<p>总结到了这里就提一下之后会谈到的几个非常重要的对象以及一个很重要的概念。</p>
<ul>
<li>ActivityManagerServices（AMS）：它是一个服务端对象，负责所有的Activity的生命周期，<strong>ActivityThread会通过Binder与之交互，而AMS与Zygote之间进行交互则是通过Socket通信（IPC通信在之后会总结到）</strong></li>
<li>ActivityThread：它也就是我们俗称的UI线程/主线程，它里面存在一个main()方法，这也是APP的真正入口，当APP启动时，就会启动ActivityThread中的main方法，它会初始化一些对象，然后开启<strong>消息循环队列（之后总结）</strong>，之后就会Looper.loop死循环，如果有消息就执行，没有就等着，也就是事件驱动模型（edt）的原理。</li>
<li>ApplicationThread：它实现了IBinder接口，是Activity整个框架中客户端和服务端AMS之间通信的接口，同时也是ActivityThread的内部类。这样就有效的把ActivityThread和AMS绑定在一起了。</li>
<li>Instrumentation：这个东西我把它理解为ActivityThread的一个工具类，也算是一个劳动者吧，对于生命周期的所有操作例如onCreate最终都是直接由它来执行的。</li>
</ul>
<p><strong>Android系统中的客户端和服务器的概念</strong> </p>
<p>在Android系统中其实也存在着服务器和客户端的概念，服务器端指的就是所有App共用的系统服务，比如上面的AMS，PackageManagerService等等，这些系统服务是被所有的App共用的，当某个App想要实现某个操作的时候，就会通知这些系统服务。</p>
<h2 id="继续断点1"><a href="#继续断点1" class="headerlink" title="继续断点1"></a>继续断点1</h2><p>当Zygote被初始化的时候，会fork出System Server进程，这个进程在整个的Android进程中是非常重要的一个，地位和Zygote等同，它是属于Application Framework层的，Android中的所有服务，例如AMS, WindowsManager, PackageManagerService等等都是由这个SystemServer fork出来的。所以它的地位可见一斑。</p>
<p>而当System Server进程开启的时候，就会初始化AMS，同时，会加载本地系统的服务库，创建系统上下文，创建ActivityThread及开启各种服务等等。而在这之后，就会开启系统的Launcher程序，完成系统界面的加载与显示。<strong>【断点2】</strong></p>
<h2 id="Context总结"><a href="#Context总结" class="headerlink" title="Context总结"></a>Context总结</h2><p>Context是一个抽象类，下面是它的注释信息，摘自源码。</p>
<pre><code>&lt;span class=&quot;hljs-javadoc&quot;&gt;/**
 * Interface to global information about an application environment.  This is
 * an abstract class whose implementation is provided by
 * the Android system.  It
 * allows access to application-specific resources and classes, as well as
 * up-calls for application-level operations such as launching activities,
 * broadcasting and receiving intents, etc.
 */&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;hljs-class&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;Context&lt;/span&gt; {&lt;/span&gt;`&lt;/pre&gt;

从上面的这段话可以简单理解一下，Context是一个关于应用程序环境的全局变量接口，通过它可以允许去获得资源或者类，例如启动Activity,广播，intent等等。

我的理解：Context的具体实现是Application, Activity,Service，通过Context能够有权限去做一些事情，其实我觉得就是一个运行环境的问题。

**需要注意的地方** 

Android开发中由于很多地方都包含了Context的使用，因此就必须要注意到内存泄露或者是一些可能会引起的问题。

例如在Toast中，它的Context就最好设置为Application Context，因为如果Toast在显示东西的时候Activity关闭了，但是由于Toast仍然持有Activity的引用，那么这个Activity就不会被回收掉，也就造成了内存泄露。

## Toast的相关总结

上面举例的时候举到了Toast，其实Toast也是很有意思的一个东西，它的show方法其实并不是显示一个东西这么简单。 

Toast实际上是一个队列，会通过show方法把新的任务加入到队列当中去，列队中只要存在消息就会弹出来使用，而队列的长度据说默认是40个（这是网上搜出来的，我在源码中没找到对应的设置，感觉也没啥必要就没找了）。 

所以这里就要注意一下show这个操作了，它并不是显示内容，而是把内容入队列。

&lt;pre class=&quot;prettyprint&quot;&gt;`&lt;span class=&quot;hljs-javadoc&quot;&gt;/**
     * Show the view for the specified duration.
     */&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;show&lt;/span&gt;() {
        &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (mNextView == &lt;span class=&quot;hljs-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;hljs-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;hljs-string&quot;&gt;&quot;setView must have been called&quot;&lt;/span&gt;);
        }

        INotificationManager service = getService();
        String pkg = mContext.getOpPackageName();
        TN tn = mTN;
        tn.mNextView = mNextView;

        &lt;span class=&quot;hljs-keyword&quot;&gt;try&lt;/span&gt; {
            service.enqueueToast(pkg, tn, mDuration);
        } &lt;span class=&quot;hljs-keyword&quot;&gt;catch&lt;/span&gt; (RemoteException e) {
            &lt;span class=&quot;hljs-comment&quot;&gt;// Empty&lt;/span&gt;
        }
    }`&lt;/pre&gt;

## Handler的内存泄露

对于Handler来说，如果我们直接在AndroidStudio中创建一个非静态内部类Handler，那么Handler这一大片的区域会被AS标记为黄色，这个应该很多人都遇到过吧。实际上是因为这样设置会造成内存泄露，因为每一个非静态内部类都会持有一个外部类的引用，那么这里也就产生了一个内存泄露的可能点，如果当Activity被销毁时没有与Handler解除，那么Handler仍然会持有对该Activity的引用，那么就造成了内存泄露。

**解决方案** 

使用static修饰Handler，这样也就成了一个静态内部类，那么就不会持有对外部类的引用了。而这个时候就可以在Handler中创建一个WeakReference（弱引用）来持有外部的对象。只要外部解除了与该引用的绑定，那么垃圾回收器就会在发现该弱引用的时候立刻回收掉它。

## 垃圾回收

关于垃圾回收的相关总结看我之前的博客，传送门：[JVM原理及底层探索](http://blog.csdn.net/jonstank2013/article/details/50922958)

## 四种引用方式

上面扯到了弱引用，就再BB一下四种引用方式吧。
</code></pre><ul>
<li>强引用：垃圾回收器打死都不会回收掉一个强引用的，那怕是出现OOM也不会回收掉强引用，所有new出来的都是强引用。</li>
<li>软引用：垃圾回收器会在内存不足的情况下回收掉软引用，如果内存充足的话不会理它</li>
<li>弱引用：它跟软引用类似，但是它更脆弱，只要垃圾回收器一发现它，就会立刻回收掉它。比如一个对象持有一个强引用和弱引用，当强引用被取消时，那么只要GC发现了它，就会立刻回收掉。只是GC发现它的这个过程是不确定的，有可能不会马上发生，所以它可能还会多活一会，中间存在一个优先级。</li>
<li><p>虚引用：它跟上面3种方式都不同。我对虚引用的理解就是如果一个对象持有虚引用，那么就可以在被GC回收前进行一些设定好的工作等等。因为虚引用有个机制，因为虚引用必须和引用队列联合使用，当垃圾回收器准备回收一个对象时，如果发现它还有虚引用，就回在回收对象的内存前，把这个虚引用加入到与之关联的引用队列中。而程序如果判断到引用队列中已经加入了虚引用，那么就可以了解到被引用的对象马上就要被垃圾回收了，这个时候就可以做些被回收之前的事情啦。</p>
<h2 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h2><p>类加载器按层次从顶层到下依次为Boorsrtap ClassLoader（启动类加载器）,Extension ClassLoader（拓展类加载器），ApplicationClassLoader（应用程序类加载器）</p>
<p>判断两个类是否是同一个类就是看它们是否是由同一个类加载器加载而来。</p>
<p>这里就需要介绍一下双亲委派模式了： </p>
<p>双亲委派模式的意思就是：除了启动类加载器之外，其余的加载器都需要指定一个父类的加载器，当需要加载的时候会先让父类去试着加载，如果父类无法加载也就是找不到这个类的话就会让子类去加载</p>
<p>好处：防止内存中出现多份同样的字节码</p>
<p>比如类A和类B都要加载system类，如果不是委托的话，类A就会加载一份，B也会加载一份，那么就会出现两份SYstem字节码 </p>
<p>如果使用委托机制，会递归的向父类查找，也就是首选用Bootstrap尝试加载，如果找不到再向下，如果A用这个已经加载了的话会直接返回内存中的system而不需要重新加载。那么就只会存在一份</p>
<h2 id="延迟加载的应用：单例模式"><a href="#延迟加载的应用：单例模式" class="headerlink" title="延迟加载的应用：单例模式"></a>延迟加载的应用：单例模式</h2><p>对于Java来说，类是需要使用到时才会加载，这里也就出现了一个延迟加载的效果。而在延迟加载的时候，会默认保持同步。这也就产生了一种单例模式的方式，具体的看我之前的博客：<a href="http://blog.csdn.net/jonstank2013/article/details/50903830" target="_blank" rel="external">设计模式_单例模式</a></p>
<p>我觉得在android所有的创建单例模式方法中里延迟加载方式是最好吧，虽然枚举比延迟加载更好，effiective java中也很推荐，但是并不怎么适用于Android，Android里枚举的消耗是static的两倍，延迟加载的话只要我们在使用延迟加载方式时做好反序列化的返回值readResolve()准备就好了。</p>
<h2 id="继续断点2"><a href="#继续断点2" class="headerlink" title="继续断点2"></a>继续断点2</h2><p>上面BB了太多其他的，现在有点缓不过来，下次自己看自己博客的时候会不会都被自己的思路带得乱七八糟的。</p>
<p>上面的时候我们就已经完成了整个Android系统的开机以及初始化。接下来就可以B一下从点击APP图标开始到APP内部程序运行起来的流程了。</p>
<p>当我们点击屏幕时，触摸屏的两层电极会连接在一起，也就产生了一个电压（具体的我忘了，书上有，图找不到了），当产生电压的时候，就可以通过对应的驱动把当前按压点的XY坐标传给上层，这里也就是操作系统。操作系统在获取到XY值的时候，就会对按压点的范围进行一个判断，如果确定按压点处于一个APP图标或者是Button等等的范围中时，操作系统也就会认为用户当前已经点击了这个东西，启动对应的监听。</p>
<p>而当系统判断我们点击的是APP图标时，该App就由Launcher开始启动了<strong>【断点3】</strong></p>
<h2 id="Launcher"><a href="#Launcher" class="headerlink" title="Launcher"></a>Launcher</h2><p>Launcher是一个继承自Activity，同时实现了点击事件，长按事件等等的一个应用程序。</p>
<pre class="prettyprint">`<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Launcher</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Activity</span>
        <span class="hljs-keyword">implements</span> <span class="hljs-title">View</span>.<span class="hljs-title">OnClickListener</span>,<span class="hljs-title">OnLongClickListener</span>, <span class="hljs-title">LauncherModel</span>.<span class="hljs-title">Callbacks</span>,<span class="hljs-title">View</span>.<span class="hljs-title">OnTouchListener</span></span>`</pre>

<p>当我们点击一个APP的图标时，会调用Launcher内部的startActivitySafely()方法，而这个方法则会进行两件事，一个是启动目标activity，另一个功能就是捕获异常ActivityNotFoundException，也就是常见的“找不到activity,是否已经在androidmenifest文件中注册？”。而在startActivity方法中，经过一系列的转换最终会调用到startActivityForResult这个方法。</p>
<pre class="prettyprint">`    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startActivity</span>(Intent intent, @Nullable Bundle options) {
        <span class="hljs-keyword">if</span> (options != <span class="hljs-keyword">null</span>) {
            startActivityForResult(intent, -<span class="hljs-number">1</span>, options);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// Note we want to go through this call for compatibility with</span>
            <span class="hljs-comment">// applications that may have overridden the method.</span>
            startActivityForResult(intent, -<span class="hljs-number">1</span>);
        }
    }`</pre>

<p>所以实际上，我对整个Android的界面是这样理解的： </p>
<p>当系统完成初始化以及各种服务的创建之后，就会启动Launcher这个应用程序（它也是继承自Activity的，包含自己对应的xml布局文件），然后再把各种图标按照一个正常APP布局的方式放在上面，当我们点击APP图标时，也就相当于在Launcher这个APP应用程序中通过startActivity（在底层最后会转为startActivityForResult）来启动这个APP。简单的讲，我觉得就是一个主要的APP（Launcher）里面启动了其他的功能APP，例如QQ、微信这些。<strong>【个人理解，如果以后发现不对再修改】</strong></p>
<h2 id="Android中点击事件的处理"><a href="#Android中点击事件的处理" class="headerlink" title="Android中点击事件的处理"></a>Android中点击事件的处理</h2><p>当我们手指按下时，Android是如何处理点击事件的呢？如何确定是让哪一个控件来处理呢？ </p>
<p>简单一句话：层层传递-冒泡的方式处理 </p>
<p>举个例子：现在公司来了个小项目，老板一看分配给经理做，经理一看分配给小组长，小组长一看好简单，分配给组员。如果在这个传递过程中（也就是还为分配到最底部时），某一层觉得我来负责这个比较好的话就会拦截掉这个消息，然后把它处理了，下面的就收不到有消息的这个通知。如果一直到了底层的话，组员如果能完成，就完成它。如果不能完成，那么就报告给组长，说组长我做不来，边学边做要影响进度。组长一看我也做不来，就给经理，经理一看我也不会，就给老板。这样也就一层层的传递了。 </p>
<p>总结一下就是消息从上到下依次传递，如果在传递的过程中被拦截了就停止下传。如果没有被拦截，就一直传递到底部，如果底部不能够消耗该消息，那么就又一层层的返回来，返给上层，直到被消耗或者是到达最顶层。</p>
<p>在Android中，存在三个重要的方法：</p>
</li>
<li><p>dispathTouchEvent(MotionEvent ev)</p>
</li>
<li>onInterceptTouchEvent(MotionEvent ev)</li>
<li><p>onTouchEvent(MotionEvent ev)</p>
<p>第一个方法负责事件的分发，它的返回值就是表示是否消耗当前事件。 </p>
<p>第二个方法是用于判断是否拦截该消息，如果当前View拦截了某个时间，那么在同一个事件序列中，此方法不会被再次调用。返回结果表示是否拦截当前事件 </p>
<p>第三个方法就是处理事件。返回结果表示是否消耗当前事件，如果不小号，则在同一时间序列中，当前View无法再次接收到事件。</p>
<p>对于一个根ViewGroup来说，点击事件产生后，首先会传递给它，调用它的dispath方法。如果这个ViewGroup的onIntercept方法返回true就表示它要拦截当前事件，false就表示不拦截，这个时候事件就会继续传递给子元素，接着调用子元素的dispath方法，直到被处理。</p>
<h2 id="滑动冲突"><a href="#滑动冲突" class="headerlink" title="滑动冲突"></a>滑动冲突</h2><p>顺带总结一下滑动冲突的解决吧 </p>
<p>View的滑动冲突一般可以分为三种：</p>
</li>
<li><p>外部滑动和内部滑动方向不一致</p>
</li>
<li>外部滑动方向和内部滑动方向一致</li>
<li><p>嵌套上面两种情况</p>
<p>比如说一个常见的，外部一个ListView，里面一个ScrollView。这个时候该怎么解决呢？其实这里想到了ViewPager，它里面实际上是解决了滑动冲突的，可以借鉴一下它的。</p>
<p><strong>滑动处理规则</strong> </p>
<p>一般来说，我们可以根据用户手指滑动的方向以及角度来判断用户是要朝着哪个方向去滑动。而很多时候还可以根据项目的需求来指定一套合适的滑动方案。</p>
<p><strong>外部拦截法</strong> </p>
<p>这种方法就是指所有的点击时间都经过父容器的拦截处理，如果父容器需要此时间就拦截，如果不需要此事件就不拦截。通过重写父容器的onInterceptTouchEvent方法：</p>
<pre class="prettyprint">`<span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
    intercepted = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">break</span>;

<span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
<span class="hljs-keyword">if</span>(父类容器需要) {
    intercepted = <span class="hljs-literal">true</span>;
} <span class="hljs-keyword">else</span> {
    intercepted = <span class="hljs-literal">false</span>;
}
<span class="hljs-keyword">break</span>;

<span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
    intercepted = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">break</span>;

<span class="hljs-keyword">return</span> intercepted;`</pre>

<p>这里有一点需要注意，ACTION_DOWN事件父类容器就必须返回false，因为如果父类容器拦截了的话，后面的Move等所有事件都会直接由父类容器处理，就无法传给子元素了。UP事件也要返回false，因为它本身来说没有太多的意义，但是对于子元素就不同了，如果拦截了，那么子元素的onClick事件就无法触发。</p>
<p><strong>内部拦截法</strong> </p>
<p>这种方法指的是父容器不拦截任何时间，所有的事件都传递给子元素，如果子元素需要此事件就直接消耗掉，否则就交给父容器进行处理。它需要配合requestDisallowInterceptTouchEvent方法才能正常工作。我们需要重写子元素的dispatch方法</p>
<pre class="prettyprint">`<span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
    <span class="hljs-keyword">parent</span>.requestDisallowInterceptTouchEvent(<span class="hljs-keyword">true</span>);
<span class="hljs-keyword">break</span>;

MotionEvent.ACTION_MOVE:
    <span class="hljs-keyword">if</span>(父容器需要此类点击事件) {
    <span class="hljs-keyword">parent</span>.requestDisallowInterceptTouchEvent(<span class="hljs-keyword">false</span>);
    }
<span class="hljs-keyword">break</span>;

<span class="hljs-keyword">return</span> super.dispatchTouchEvent(event);`</pre>

<p>这种方法的话父类容器需要默认拦截除了ACTION_DOWN以外的其他时间，这样当子元素调用request方法的时候父元素才能继续拦截所需的事件。</p>
<p><strong>其他的</strong> </p>
<p>如果觉得上面两个方式太复杂，看晕了，其实也可以自己根据项目的实际需要来指定自己的策略实现。例如根据你手指按的点的位置来判断你当前触碰的是哪个控件，以此来猜测用户是否是要对这个控件进行操作。如果点击的是空白的地方，就操作外部控件即可。</p>
<p><strong>【等有时间了就把ViewPager的处理总结一下，挺重要的】</strong></p>
<h2 id="继续断点3"><a href="#继续断点3" class="headerlink" title="继续断点3"></a>继续断点3</h2></li>
<li><p>当我们点击桌面的APP图标时，Launcher进程会采用Binder的方式向AMS发出startActivity请求</p>
</li>
<li>AMS在接收到请求之后，就会通过Socket向Zygote进程发送创建进程的请求</li>
<li>Zygote进程会fork出新的子进程（APP进程）</li>
<li>之后APP进程会再向AMS发起一次请求，AMS收到之后经过一系列的准备工作再回传请求。</li>
<li>APP进程收到AMS返回的请求后，会利用Handler向主线程发送LAUNCH_ACTIVITY消息</li>
<li><p>主线程在收到消息之后，就创建目标Activity，并回调onCreate()/onStart()/onResume()等方法，UI渲染结束后便可以看到App主界面    <strong>【断点4】</strong></p>
<h2 id="Handler-Looper-Message-Queue-ThreadLocal机制"><a href="#Handler-Looper-Message-Queue-ThreadLocal机制" class="headerlink" title="Handler/Looper/Message Queue/ThreadLocal机制"></a>Handler/Looper/Message Queue/ThreadLocal机制</h2><p>Android的消息机制主要是指Handler的运行机制，Handler的运行需要底层的MessageQueue和Looper的支撑</p>
<p>虽然MessageQueue叫做消息队列，但是实际上它内部的存储结构是单链表的方式。由于Message只是一个消息的存储单元，它不能去处理消息，这个时候Looper就弥补了这个功能，Looper会以无限循环的形式去查找是否有新消息，如果有的话就处理消息，否则就一直等待（机制等会介绍）。而对于Looper来说，存在着另外的一个很重要的概念，就是ThreadLocal。</p>
<h2 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h2><p>ThreadLocal它并不是一个线程，而是一个可以在每个线程中存储数据的数据存储类，通过它可以在指定的线程中存储数据，数据存储之后，只有在指定线程中可以获取到存储的数据，对于其他线程来说则无法获取到该线程的数据。 </p>
<p>举个例子，多个线程通过同一个ThreadLocal获取到的东西是不一样的，就算有的时候出现的结果是一样的（偶然性，两个线程里分别存了两份相同的东西），但他们获取的本质是不同的。</p>
<p>那为什么有这种区别呢？为什么要这样设计呢？ </p>
<p>先来研究一下为什么会出现这个结果。 </p>
<p>在ThreadLocal中存在着两个很重要的方法，get和set方法，一个读取一个设置。</p>
<pre class="prettyprint">` <span class="hljs-javadoc">/**
     * Returns the value of this variable for the current thread. If an entry
     * doesn't yet exist for this variable on this thread, this method will
     * create an entry, populating the value with the result of
     * {@link #initialValue()}.
     *
     *<span class="hljs-javadoctag"> @return</span> the current value of the variable for the calling thread.
     */</span>
    <span class="hljs-annotation">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
    <span class="hljs-keyword">public</span> T <span class="hljs-title">get</span>() {
        <span class="hljs-comment">// Optimized for the fast path.</span>
        Thread currentThread = Thread.currentThread();
        Values values = values(currentThread);
        <span class="hljs-keyword">if</span> (values != <span class="hljs-keyword">null</span>) {
            Object[] table = values.table;
            <span class="hljs-keyword">int</span> index = hash &amp; values.mask;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.reference == table[index]) {
                <span class="hljs-keyword">return</span> (T) table[index + <span class="hljs-number">1</span>];
            }
        } <span class="hljs-keyword">else</span> {
            values = initializeValues(currentThread);
        }

        <span class="hljs-keyword">return</span> (T) values.getAfterMiss(<span class="hljs-keyword">this</span>);
    }

 <span class="hljs-javadoc">/**
     * Sets the value of this variable for the current thread. If set to
     * {@code null}, the value will be set to null and the underlying entry will
     * still be present.
     *
     *<span class="hljs-javadoctag"> @param</span> value the new value of the variable for the caller thread.
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">set</span>(T value) {
        Thread currentThread = Thread.currentThread();
        Values values = values(currentThread);
        <span class="hljs-keyword">if</span> (values == <span class="hljs-keyword">null</span>) {
            values = initializeValues(currentThread);
        }
        values.put(<span class="hljs-keyword">this</span>, value);
    }`</pre>

<p>摘自源码 </p>
<p>首先研究它的get方法吧，从注释上可以看出，get方法会返回一个当前线程的变量值，如果数组不存在就会创建一个新的。 </p>
<p>这里有几个很重要的词，就是“当前线程”和“数组”。 </p>
<p>这里提到的数组对于每个线程来说都是不同的，values.table，而values是通过当前线程获取到的一个Values对象，因此这个数组是每个线程唯一的，不能共用，而下面的几句话也更直接了，获取一个索引，再返回通过这个索引找到数组中对应的值。这也就解释了为什么多个线程通过同一个ThreadLocal返回的是不同的东西。</p>
<p>那这里为什么要这么设置呢？翻了一下书，搜了一下资料：</p>
</li>
<li><p>ThreadLocal在日常开发中使用到的地方较少，但是在某些特殊的场景下，通过ThreadLocal可以轻松实现一些看起来很复杂的功能。一般来说，当某些数据是以线程为作用域并且不同线程具有不同的数据副本的时候，就可以考虑使用ThreadLocal。例如在Handler和Looper中。对于Handler来说，它需要获取当前线程的Looper，很显然Looper的作用域就是线程并且不同的线程具有不同的Looper，这个时候通过ThreadLocal就可以轻松的实现Looper在线程中的存取。如果不采用ThreadLocal，那么系统就必须提供一个全局的哈希表供Handler查找指定的Looper，这样就比较麻烦了，还需要一个管理类。</p>
</li>
<li><p>ThreadLocal的另一个使用场景是复杂逻辑下的对象传递，比如监听器的传递，有些时候一个线程中的任务过于复杂，就可能表现为函数调用栈比较深以及代码入口的多样性，这种情况下，我们又需要监听器能够贯穿整个线程的执行过程。这个时候就可以使用到ThreadLocal，通过ThreadLocal可以让监听器作为线程内的全局对象存在，在线程内通过get方法就可以获取到监听器。如果不采用的话，可以使用参数传递，但是这种方式在设计上不是特别好，当调用栈很深的时候，通过参数来传递监听器这个设计太糟糕。而另外一种方式就是使用static静态变量的方式，但是这种方式存在一定的局限性，拓展性并不是特别的强。比如有10个线程在执行，就需要提供10个监听器对象。</p>
<h2 id="消息机制"><a href="#消息机制" class="headerlink" title="消息机制"></a>消息机制</h2><p>上面提到了Handler/Looper/Message Queue，它们实际上是一个整体，只不过我们在开发中接触更多的是Handler而已，Handler的主要作用是将一个任务切换到某个指定的线程中去执行，而Android之所以提供这个机制是因为Android规定UI只能在主线程中进程，如果在子线程中访问UI就会抛出异常。</p>
<p><strong>为什么Android不允许在子线程访问UI</strong> </p>
<p>其实这一点不仅仅是对于Android,对于其他的所有图形界面现在都采用的是单线程模式。 </p>
<p>因为对于一个多线程来说，如果子线程更改了UI，那么它的相关操作就必须对其他子线程可见，也就是Java并发中很重要的一个概念，线程可见性，Happen-before原则<strong>【下篇博客总结一下自己对Java并发的理解吧，挺重要的，总结完后再把传送门贴过来】</strong>而一般来说，对于这种并发访问，一般都是采用加锁的机制，但是加锁的机制存在很明显的问题：让UI访问间的逻辑变得复杂，同时效率也会降低。甚至有的时候还会造成死锁的情况，这个时候就麻烦了。 </p>
<p>而至于究竟能不能够实现这种UI界面的多线程呢？SUN公司的某个大牛（忘了是谁，很久之前看的，好像是前副总裁）说：“行肯定是没问题，但是非常考技术，因为必须要考虑到很多种情况，这个时候就需要技术专家来设计。而这种设计出来的东西对于广大普通程序员来说又是异常头疼的，就算是实现了多线程，普通人用起来也是怨声载道的。所以建议还是单线程”。</p>
<h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><p>顺带着BB一下死锁。</p>
<p><strong>死锁的四个必要条件</strong></p>
</li>
</ul>
<ol>
<li>互斥条件：资源不能被共享，只能被同一个进程使用</li>
<li>请求与保持条件：已经得到资源的进程可以申请新的资源</li>
<li>非剥夺条件：已经分配的资源不能从相应的进程中被强制剥夺</li>
<li><p>循环等待条件：系统中若干进程组成环路，该环路中每个进程都在等待相邻进程占用的资源</p>
<p>举个常见的死锁例子：进程A中包含资源A,进程B中包含资源B，A的下一步需要资源B，B的下一步需要资源A，所以它们就互相等待对方占有的资源释放，所以也就产生了一个循环等待死锁。</p>
<p><strong>处理死锁的方法</strong></p>
</li>
<li><p>忽略该问题，也就是鸵鸟算法。当发生了什么问题时，不管他，直接跳过，无视它。</p>
</li>
<li>检测死锁并恢复</li>
<li>资源进行动态分配</li>
<li><p>破除上面的四种死锁条件之一</p>
<h2 id="继续消息机制"><a href="#继续消息机制" class="headerlink" title="继续消息机制"></a>继续消息机制</h2><p>MessageQueue主要包含两个操作：插入和读取，读取操作本身会伴随着删除操作，插入和读取对应的方法分别为enqueueMessage和next，其中enqueueMessage的作用是往消息队列中插入一条消息，而next的作用是从消息队列中取出一条消息并将其从消息队列中移除。这也就是为什么使用的是一个单链表的数据结构来维护消息列表，因为它在插入和删除上比较有优势（把下一个连接的点切换一下就完成了）。</p>
<p>而对于MessageQueue的插入操作来说，没什么可以看的，也就这样吧，主要需要注意的是它的读取方法next。</p>
<pre class="prettyprint">` Message next() {
        <span class="hljs-regexp">//</span> Return here <span class="hljs-keyword">if</span> the message <span class="hljs-keyword">loop</span> has already quit <span class="hljs-keyword">and</span> been disposed.
        <span class="hljs-regexp">//</span> This can happen <span class="hljs-keyword">if</span> the application tries to restart a looper after quit
        <span class="hljs-regexp">//</span> which <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> supported.
        final long ptr = mPtr;
        <span class="hljs-keyword">if</span> (ptr == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        int pendingIdleHandlerCount = -<span class="hljs-number">1</span>; <span class="hljs-regexp">//</span> -<span class="hljs-number">1</span> only during first iteration
        int nextPollTimeoutMillis = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (;;) {
            <span class="hljs-keyword">if</span> (nextPollTimeoutMillis != <span class="hljs-number">0</span>) {
                Binder.flushPendingCommands();
            }

            nativePollOnce(ptr, nextPollTimeoutMillis);

            synchronized (<span class="hljs-keyword">this</span>) {
                <span class="hljs-regexp">//</span> Try to retrieve the next message.  Return <span class="hljs-keyword">if</span> found.
                final long now = SystemClock.uptimeMillis();
                Message prevMsg = <span class="hljs-literal">null</span>;
                Message msg = mMessages;
                <span class="hljs-keyword">if</span> (msg != <span class="hljs-literal">null</span> &amp;&amp; msg.target == <span class="hljs-literal">null</span>) {
                    <span class="hljs-regexp">//</span> Stalled <span class="hljs-keyword">by</span> a barrier.  Find the next asynchronous message <span class="hljs-keyword">in</span> the queue.
                    <span class="hljs-keyword">do</span> {
                        prevMsg = msg;
                        msg = msg.next;
                    } <span class="hljs-keyword">while</span> (msg != <span class="hljs-literal">null</span> &amp;&amp; !msg.isAsynchronous());
                }
                <span class="hljs-keyword">if</span> (msg != <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">if</span> (now &lt; msg.<span class="hljs-keyword">when</span>) {
                        <span class="hljs-regexp">//</span> Next message <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> ready.  Set a timeout to wake up <span class="hljs-keyword">when</span> it <span class="hljs-keyword">is</span> ready.
                        nextPollTimeoutMillis = (int) Math.min(msg.<span class="hljs-keyword">when</span> - now, Integer.MAX_VALUE);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-regexp">//</span> Got a message.
                        mBlocked = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">if</span> (prevMsg != <span class="hljs-literal">null</span>) {
                            prevMsg.next = msg.next;
                        } <span class="hljs-keyword">else</span> {
                            mMessages = msg.next;
                        }
                        msg.next = <span class="hljs-literal">null</span>;
                        <span class="hljs-keyword">if</span> (DEBUG) Log.v(TAG, <span class="hljs-string">"Returning message: "</span> + msg);
                        msg.markInUse();
                        <span class="hljs-keyword">return</span> msg;
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-regexp">//</span> No more messages.
                    nextPollTimeoutMillis = -<span class="hljs-number">1</span>;
                }

                <span class="hljs-regexp">//</span> Process the quit message now that all pending messages have been handled.
                <span class="hljs-keyword">if</span> (mQuitting) {
                    dispose();
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
                }

                <span class="hljs-regexp">//</span> If first time idle, <span class="hljs-keyword">then</span> get the number <span class="hljs-keyword">of</span> idlers to run.
                <span class="hljs-regexp">//</span> Idle handles only run <span class="hljs-keyword">if</span> the queue <span class="hljs-keyword">is</span> empty <span class="hljs-keyword">or</span> <span class="hljs-keyword">if</span> the first message
                <span class="hljs-regexp">//</span> <span class="hljs-keyword">in</span> the queue (possibly a barrier) <span class="hljs-keyword">is</span> due to be handled <span class="hljs-keyword">in</span> the future.
                <span class="hljs-keyword">if</span> (pendingIdleHandlerCount &lt; <span class="hljs-number">0</span>
                        &amp;&amp; (mMessages == <span class="hljs-literal">null</span> || now &lt; mMessages.<span class="hljs-keyword">when</span>)) {
                    pendingIdleHandlerCount = mIdleHandlers.size();
                }
                <span class="hljs-keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-regexp">//</span> No idle handlers to run.  Loop <span class="hljs-keyword">and</span> wait some more.
                    mBlocked = <span class="hljs-literal">true</span>;
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">if</span> (mPendingIdleHandlers == <span class="hljs-literal">null</span>) {
                    mPendingIdleHandlers = <span class="hljs-keyword">new</span> IdleHandler[Math.max(pendingIdleHandlerCount, <span class="hljs-number">4</span>)];
                }
                mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);
            }

            <span class="hljs-regexp">//</span> Run the idle handlers.
            <span class="hljs-regexp">//</span> We only ever reach <span class="hljs-keyword">this</span> code block during the first iteration.
            <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; pendingIdleHandlerCount; i++) {
                final IdleHandler idler = mPendingIdleHandlers[i];
                mPendingIdleHandlers[i] = <span class="hljs-literal">null</span>; <span class="hljs-regexp">//</span> release the reference to the handler

                boolean keep = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">try</span> {
                    keep = idler.queueIdle();
                } <span class="hljs-keyword">catch</span> (Throwable t) {
                    Log.wtf(TAG, <span class="hljs-string">"IdleHandler threw exception"</span>, t);
                }

                <span class="hljs-keyword">if</span> (!keep) {
                    synchronized (<span class="hljs-keyword">this</span>) {
                        mIdleHandlers.remove(idler);
                    }
                }
            }

            <span class="hljs-regexp">//</span> Reset the idle handler count to <span class="hljs-number">0</span> so we <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> run them again.
            pendingIdleHandlerCount = <span class="hljs-number">0</span>;

            <span class="hljs-regexp">//</span> While calling an idle handler, a <span class="hljs-keyword">new</span> message could have been delivered
            <span class="hljs-regexp">//</span> so go back <span class="hljs-keyword">and</span> look again <span class="hljs-keyword">for</span> a pending message without waiting.
            nextPollTimeoutMillis = <span class="hljs-number">0</span>;
        }
    }`</pre>

<p>源码有点长，总结一下就是： </p>
<p>next方法它是一个死循环，如果消息队列中没有消息，那么next方法就会一直阻塞在这里，当有新的消息来的时候，next方法就会返回这条信息并将其从单链表中移除。</p>
<p>而这个时候勒Looper就等着的，它也是一直循环循环，不停地从MessageQueue中查看是否有新消息，如果有新消息就会立刻处理，否则就会一直阻塞在那里。而对于Looper来说，它是只能创建一个的，这个要归功与它的prepare方法。</p>
<pre class="prettyprint">` <span class="hljs-javadoc">/** Initialize the current thread as a looper.
      * This gives you a chance to create handlers that then reference
      * this looper, before actually starting the loop. Be sure to call
      * {@link #loop()} after calling this method, and end it by calling
      * {@link #quit()}.
      */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepare</span>() {
        prepare(<span class="hljs-keyword">true</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepare</span>(<span class="hljs-keyword">boolean</span> quitAllowed) {
        <span class="hljs-keyword">if</span> (sThreadLocal.get() != <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"Only one Looper may be created per thread"</span>);
        }
        sThreadLocal.set(<span class="hljs-keyword">new</span> Looper(quitAllowed));
    }`</pre>

<p>从这里我们就可以看出该prepare方法会首先检测是否已经存在looper了，如果不存在，就创建一个新的；如果存在，就抛出异常。 </p>
<p>而之后使用Looper.loop()就可以开启消息循环了。</p>
<pre class="prettyprint">`  <span class="hljs-javadoc">/**
     * Run the message queue in this thread. Be sure to call
     * {@link #quit()} to end the loop.
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">loop</span>() {
        <span class="hljs-keyword">final</span> Looper me = myLooper();
        <span class="hljs-keyword">if</span> (me == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);
        }
        <span class="hljs-keyword">final</span> MessageQueue queue = me.mQueue;

        <span class="hljs-comment">// Make sure the identity of this thread is that of the local process,</span>
        <span class="hljs-comment">// and keep track of what that identity token actually is.</span>
        Binder.clearCallingIdentity();
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> ident = Binder.clearCallingIdentity();

        <span class="hljs-keyword">for</span> (;;) {
            Message msg = queue.next(); <span class="hljs-comment">// might block</span>
            <span class="hljs-keyword">if</span> (msg == <span class="hljs-keyword">null</span>) {
                <span class="hljs-comment">// No message indicates that the message queue is quitting.</span>
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// This must be in a local variable, in case a UI event sets the logger</span>
            Printer logging = me.mLogging;
            <span class="hljs-keyword">if</span> (logging != <span class="hljs-keyword">null</span>) {
                logging.println(<span class="hljs-string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="hljs-string">" "</span> +
                        msg.callback + <span class="hljs-string">": "</span> + msg.what);
            }

            msg.target.dispatchMessage(msg);

            <span class="hljs-keyword">if</span> (logging != <span class="hljs-keyword">null</span>) {
                logging.println(<span class="hljs-string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="hljs-string">" "</span> + msg.callback);
            }

            <span class="hljs-comment">// Make sure that during the course of dispatching the</span>
            <span class="hljs-comment">// identity of the thread wasn't corrupted.</span>
            <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> newIdent = Binder.clearCallingIdentity();
            <span class="hljs-keyword">if</span> (ident != newIdent) {
                Log.wtf(TAG, <span class="hljs-string">"Thread identity changed from 0x"</span>
                        + Long.toHexString(ident) + <span class="hljs-string">" to 0x"</span>
                        + Long.toHexString(newIdent) + <span class="hljs-string">" while dispatching to "</span>
                        + msg.target.getClass().getName() + <span class="hljs-string">" "</span>
                        + msg.callback + <span class="hljs-string">" what="</span> + msg.what);
            }

            msg.recycleUnchecked();
        }
    }`</pre>

<p>从这里面我们可以看到它也是个死循环，会不停的调用queue.next()方法来获取信息，如果没有，就return,如果有就处理。</p>
<p><strong>注意</strong> </p>
<p>当然了，这里有一个很重要的点，一般可能会忘，那就是在子线程中如果手动为其创建了Looper，那么在所有的事情完成以后应该调用quit方法来终止消息循环，否则这个子线程就会一直处于等待状态，而如果退出Looper之后，这个线程就会立刻终止，所以建议不需要使用的时候终止Looper。</p>
<p><strong>Handler</strong> </p>
<p>上面总结了Looper和MessageQueue，这里就对Handler进行一个总结吧。它的工作主要包含消息的发送和接受过程，消息的发送可以通过post的一系列方法以及send的一系列方法来实现，post的一系列方法最终是通过send的一系列方法来实现的。 </p>
<p>实际上它发送消息的过程仅仅是向消息队列中插入了一条消息，MessageQueue的next方法就会返回这条消息给Looper，Looper在收到消息之后就会开始处理了。最后由Looper交给Handler处理（handleMessage()方法）。</p>
<h2 id="IPC通信"><a href="#IPC通信" class="headerlink" title="IPC通信"></a>IPC通信</h2><p>上面总结完了Android的消息处理机制，那么就顺带总结一下IPC通信吧，毕竟上面提到过那么多次Binder和Socket。</p>
<p>资料：<a href="https://www.zhihu.com/question/39440766#answer-31119460" target="_blank" rel="external">为什么Android要采用Binder作为IPC机制？</a> </p>
<p>知乎上面的回答相当的好，这个博主对系统底层也是颇有钻研，学习。</p>
<p>这里就结合上面的知乎回答以及加上《Linux程序设计》还有一本Linux内核剖析（书名忘了但是讲得真的非常好），掺杂一些个人的理解。</p>
<p><strong>进程的定义</strong> </p>
<p>UNIX标准把进程定义为：“一个其中运行着一个或多个进程的地址控件和这些线程所需要的系统资源”。目前，可以简单的把进程看做正在运行的程序。</p>
<p>进程都会被分配一个唯一的数字编号，我们成为PID（也就是进程标识符），它通常是一个取值范围从2到32768的正整数。当进程被启动时，系统将按顺序选择下一个未被使用的数字作为PID，当数字已经回绕一圈时，新的PID重新从2开始，数字1一般是为init保留的。在进程中，存在一个自己的栈空间，用于保存函数中的局部变量和控制函数的调用与返回。进程还有自己的环境空间，包含专门为这个进程建立的环境变量，同时还必须要维护自己的程序计数器，这个计数器用来记录它执行到的位置，即在执行线程中的位置。 </p>
<p>在Linux中可以通过system函数来启动一个进程</p>
<p><strong>守护进程</strong> </p>
<p>这里就需要提到一个守护进程了，这个在所有的底层中经常都会被提到。 </p>
<p>在linux或者unix操作系统中在系统引导的时候会开启很多服务，这些服务就叫做守护进程。为了增加灵活性，root可以选择系统开启的模式，这些模式叫做运行级别，每一种运行级别以一定的方式配置系统。 守护进程是脱离于终端并且在后台运行的进程。守护进程脱离于终端是为了避免进程在执行过程中的信息在任何终端上显示并且进程也不会被任何终端所产生的终端信息所打断。 </p>
<p>守护进程常常在系统引导装入时启动，在系统关闭时终止。如果想要某个进程不因为用户或终端或其他的变化而受到影响，那么就必须把这个进程变成一个守护进程</p>
<p><strong>防止手机服务后台被杀死</strong> </p>
<p>是不是在手机的设置界面看当前正在运行的服务时会发现有的APP不止存在一个服务？有的APP后台存在两个，有的存在三个？有的流氓软件也会这么设置，这样的话就可以一直运行在后台，用户你关也关不了（倒不是说所有这么设置的都是流氓软件，因为有的软件需要保持一个长期的后台在线，这是由功能决定的）。</p>
<p>这里有两种方法（可能还有更多，这里只总结我了解的）：</p>
</li>
</ol>
<ul>
<li>第一种方法就是利用android中service的特性来设置，防止手机服务后台被杀死。通过更改onStartCommand方法的返回值，将service设置为粘性service，那么当service被kill的时候就会将服务的状态返回到最开始启动的状态，也就是运行的状态，所以这个时候也就会再次重新运行。但是需要注意一点，这个时候的intent值就为空了，获取的话需要注意一下这一点。</li>
<li><p>第二种就是fork出一个C的进程，因为在Linux中，子类进程在父类被杀死销毁的时候不会随之杀死，它会被init进程领养。所以也就可以使用这一个方法，利用主进程fork出一个C进程在后台运行，一旦检测到服务被杀死（检测的方式多种，可使用观察者模式，广播，轮询等等），就重启服务即可</p>
<p><strong>IPC通信</strong> </p>
<p>上面总结了进程的相关基础，这里就开始总结一下进程间通信（IPC </p>
<p>）的问题了。 </p>
<p>现在Linux现有的所有IPC方式：</p>
</li>
</ul>
<ol>
<li>管道：在创建时分配一个page大小的内存，缓存区大小有限</li>
<li>消息队列：信息复制两次，额外的cpu消耗，不适合频繁或信息量大的通信</li>
<li>共享内存：无需复制，共享缓冲区直接附加到进程虚拟地址控件，速度是在所有IPC通信中最快的。但是进程间的同步问题操作系统无法实现，必须由各进程利用同步工具解决。</li>
<li>Socket：作为更通用的接口，传输效率低，主要用于不通机器或跨网络的通信</li>
<li>信号量：常作为一种锁机制。</li>
<li><p>信号：不适用于信息交换，更适用于进程件中断控制，例如kill process</p>
<p>到了这里，就有了问题，为什么在Linux已经存在这么多优良的IPC方案时，Android还要采取一种新的Binder机制呢？ </p>
<p><strong>猜测</strong>：我觉得Android采用这种新的方式（当然也大面积的同时使用Linux的IPC通信方式），最多两个原因：</p>
</li>
<li><p>推广时手机厂商自定义ROM底层的保密性或者公司之间的关系。</p>
</li>
<li><p>在某些情况下更适合手机这种低配置，对效率要求极高，用户体验极其重要的设备</p>
<p><strong>资料</strong></p>
<p>对于Binder来说，存在着以下的优势：</p>
</li>
</ol>
<ul>
<li><strong>性能角度</strong>：Binder的数据拷贝只需要一次，而管道、消息队列、Socket都需要2次，而共享内存是一次都不需要拷贝，因此Binder的性能仅次于共享内存</li>
<li><strong>稳定性来说</strong>：Binder是基于C/S架构的，也就是Client和Server组成的架构，Client端有什么需求，直接发送给Server端去完成，架构清晰，分工明确。而共享内存的实现方式复杂，需要充分考虑访问临界资源的并发同步问题，否则可能会出现死锁等问题。从稳定性来说，Binder的架构优于共享内存。</li>
<li><strong>从安全的角度</strong>：Linux的传统IPC方式的接收方无法获得对方进程可靠的UID（用户身份证明）/PID（进程身份证明），从而无法鉴别对方身份，而Android是一个对安全性能要求特别高的操作系统，在系统层面需要对每一个APP的权限进行管控或者监视，对于普通用户来说，绝对不希望从App商店下载偷窥隐射数据、后台造成手机耗电等问题。传统的Linux IPC无任何保护措施，完全由上层协议来确保。而在Android中，操作系统为每个安装好的应用程序分配了自己的UID，通过这个UID可以鉴别进程身份。同时Android系统对外只暴露Client端，Client端将任务发送给Server端，Server端会根据权限控制策略判断UID/PID是否满足访问权限。也就是说Binder机制对于通信双方的身份是内核进行校验支持的。例如Socket方式只需要指导地址就可以连接，他们的安全机制需要上层协议来假设</li>
<li><strong>从语言角度</strong>：Linux是基于C的，而Android是基于Java的，而Binder是符合面向对象思想的。它的实体位于一个进程中，而它的引用遍布与系统的各个进程之中，它是一个跨进程引用的对象，模糊了进程边界，淡化了进程通信的过程，整个系统仿佛运行于同一个面向对象的程序之中。</li>
<li><p><strong>从公司角度</strong>：Linux内核是开源的，GPL协议保护，受它保护的Linux Kernel是运行在内核控件，对于上层的任何类库、服务等只要进行系统调用，调用到底层Kernel，那么也必须遵循GPL协议。而对于Android来说，Google巧妙地将GPL协议控制在内核控件，将用户控件的协议采用Apache-2.0协议（允许基于Android的开发商不向社区反馈源码）。</p>
<h2 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h2><p>刚才谈到Binder的时候提了一下效率的问题，那这里就不得不讲到反射了。</p>
<p>反射它允许一个类在运行过程中获得任意类的任意方法，这个是Java语言的一个很重要的特性。它方便了程序员的编写，但是降低了效率。</p>
<p>实际上，对于只要不是特别大的项目（非Android），反射对于效率的影响微乎其微，而与之对比的开发成本来说就更划算了。 </p>
<p>但是，Android是一个用于手机的，它的硬件设施有限，我们必须要考虑到它的这个因素，用户体验是最重要的。以前看到过国外的一项统计。在一个APP中的Splash中使用了反射，结果运行时间增加了一秒，这个已经算是很严重的效率影响了。</p>
<p><strong>为什么反射影响效率呢</strong> </p>
<p>这里就需要提到一个东西，JIT编译器。JIT编译器它可以把字节码文件转换为机器码，这个是可以直接让处理器使用的，经过它处理的字节码效率提升非常大，但是它有一个缺点，就是把字节码转换成机器码的过程很慢，有的时候甚至还超过了不转换的代码效率（转换之后存在一个复用的问题，对于转换了的机器码，使用的次数越多就越值的）。因此，在JVM虚拟机中，也就产生了一个机制，把常用的、使用频率高的字节码通过JIT编译器转换，而频率低的就不管它。而反射的话则是直接越过了JIT编译器，不管是常用的还是非常用的字节码一律没有经过JIT编译器的转化，所以效率就会低。 </p>
<p>而在Android里面，5.0之前使用的是Davlik虚拟机，它就是上面的机制，而在Android5.0之后Google使用了一个全新的ART虚拟机全面代替Davlik虚拟机。 </p>
<p>ART虚拟机会在程序安装时直接把所有的字节码全部转化为机器码，虽然这样会导致安装时间边长，但是程序运行的效率提升非常大。 </p>
<p><strong>【疑问：那在Android5.0之后的系统上，反射会不会没影响了？由于现在做项目的时候更多考虑的是向下兼容，单独考虑5.0的情况还没有，等以后有需求或者是有机会的时候再深入了解一下，以后更新】</strong></p>
<h2 id="继续断点4"><a href="#继续断点4" class="headerlink" title="继续断点4"></a>继续断点4</h2><p>刚才总结了Android的消息处理机制和IPC通信，那么我们主线程的消息处理机制是什么时候开始的呢？因为我们知道在主线程中我们是不需要手动调用Looper.prepare()和Looper.loop()的。</p>
<p>Android的主线程就是ActivityThread，主线程的入口方法是main方法，在main方法中系统会通过Looper.prepareMainLooper()来创建主线程的Looper以及MessageQueue，并通过Looper.loop来开启消息循环，所以这一步实际上是系统已经为我们做了，我们就不再需要自己来做。 </p>
<p>ActivityThread通过AppplicationThread和AMS进行进程件通信，AMS以进程间通信的方式完成ActivityThread的请求后会回调ApplicationThread中的Binder方法，然后ApplicationThread会向Handler发送消息，Handler收到消息后会将ApplicationThread中的逻辑切换到主线程中去执行，这个过程就是主线程的消息循环模型。</p>
<p>上面总结到了APP开始运行，依次调用onCreate/onStart/onResume等方法，那么在onCreate方法中我们经常使用的setContentView和findViewById做了什么事呢？</p>
<h2 id="Activity界面显示"><a href="#Activity界面显示" class="headerlink" title="Activity界面显示"></a>Activity界面显示</h2><p>首先，就考虑到第一个问题，也就是setContentView这个东西做了什么事，这里就要对你当前继承的Activity分类了，如果是继承的Activity，那么setContentView源码是这样的：</p>
<pre class="prettyprint">`
    <span class="hljs-javadoc">/**
     * Set the activity content from a layout resource.  The resource will be
     * inflated, adding all top-level views to the activity.
     *
     *<span class="hljs-javadoctag"> @param</span> layoutResID Resource ID to be inflated.
     *
     *<span class="hljs-javadoctag"> @see</span> #setContentView(android.view.View)
     *<span class="hljs-javadoctag"> @see</span> #setContentView(android.view.View, android.view.ViewGroup.LayoutParams)
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setContentView</span>(@LayoutRes <span class="hljs-keyword">int</span> layoutResID) {
        getWindow().setContentView(layoutResID);
        initWindowDecorActionBar();
    }

    <span class="hljs-javadoc">/**
     * Set the activity content to an explicit view.  This view is placed
     * directly into the activity's view hierarchy.  It can itself be a complex
     * view hierarchy.  When calling this method, the layout parameters of the
     * specified view are ignored.  Both the width and the height of the view are
     * set by default to {@link ViewGroup.LayoutParams#MATCH_PARENT}. To use
     * your own layout parameters, invoke
     * {@link #setContentView(android.view.View, android.view.ViewGroup.LayoutParams)}
     * instead.
     *
     *<span class="hljs-javadoctag"> @param</span> view The desired content to display.
     *
     *<span class="hljs-javadoctag"> @see</span> #setContentView(int)
     *<span class="hljs-javadoctag"> @see</span> #setContentView(android.view.View, android.view.ViewGroup.LayoutParams)
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setContentView</span>(View view) {
        getWindow().setContentView(view);
        initWindowDecorActionBar();
    }

    <span class="hljs-javadoc">/**
     * Set the activity content to an explicit view.  This view is placed
     * directly into the activity's view hierarchy.  It can itself be a complex
     * view hierarchy.
     *
     *<span class="hljs-javadoctag"> @param</span> view The desired content to display.
     *<span class="hljs-javadoctag"> @param</span> params Layout parameters for the view.
     *
     *<span class="hljs-javadoctag"> @see</span> #setContentView(android.view.View)
     *<span class="hljs-javadoctag"> @see</span> #setContentView(int)
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setContentView</span>(View view, ViewGroup.LayoutParams params) {
        getWindow().setContentView(view, params);
        initWindowDecorActionBar();
    }`</pre>

<p>这里面存在着3个重载函数，而不管你调用哪一个，最后都会调用到initWindowDecorActionBar()这个方法。 </p>
<p>而对于新的一个AppcompatActivity，这个Activity里面包含了一些新特性，现在我做的项目里基本都是使用AppcompatActivity代替掉原来的Activity，当然也并不是一定的，还是要根据项目的实际情况来选择。 </p>
<p>在AppcompatActivity中，setContentView是这样的：</p>
<pre class="prettyprint">` <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setContentView</span>(@LayoutRes <span class="hljs-keyword">int</span> layoutResID) {
        getDelegate().setContentView(layoutResID);
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setContentView</span>(View view) {
        getDelegate().setContentView(view);
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setContentView</span>(View view, ViewGroup.LayoutParams params) {
        getDelegate().setContentView(view, params);
    }`</pre>

<p>一样的3个重载函数，只是里面没有了上面的那个init方法，取而代之的是一个getDelegate().setContentView，这个delegate从字面上可以了解到它是一个委托的对象，源码是这样的：</p>
<pre class="prettyprint">` <span class="hljs-javadoc">/**
     *<span class="hljs-javadoctag"> @return</span> The {@link AppCompatDelegate} being used by this Activity.
     */</span>
    <span class="hljs-annotation">@NonNull</span>
    <span class="hljs-keyword">public</span> AppCompatDelegate <span class="hljs-title">getDelegate</span>() {
        <span class="hljs-keyword">if</span> (mDelegate == <span class="hljs-keyword">null</span>) {
            mDelegate = AppCompatDelegate.create(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>);
        }
        <span class="hljs-keyword">return</span> mDelegate;
    }`</pre>

<p>而在AppCompatDelegate.Create方法中，则会返回一个很有意思的东西：</p>
<pre class="prettyprint">`<span class="hljs-javadoc">/**
     * Create a {@link android.support.v7.app.AppCompatDelegate} to use with {@code activity}.
     *
     *<span class="hljs-javadoctag"> @param</span> callback An optional callback for AppCompat specific events
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AppCompatDelegate <span class="hljs-title">create</span>(Activity activity, AppCompatCallback callback) {
        <span class="hljs-keyword">return</span> create(activity, activity.getWindow(), callback);
    }

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AppCompatDelegate <span class="hljs-title">create</span>(Context context, Window window,
            AppCompatCallback callback) {
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> sdk = Build.VERSION.SDK_INT;
        <span class="hljs-keyword">if</span> (sdk &gt;= <span class="hljs-number">23</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AppCompatDelegateImplV23(context, window, callback);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sdk &gt;= <span class="hljs-number">14</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AppCompatDelegateImplV14(context, window, callback);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sdk &gt;= <span class="hljs-number">11</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AppCompatDelegateImplV11(context, window, callback);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AppCompatDelegateImplV7(context, window, callback);
        }
    }`</pre>

<p>这里会根据SDK的等级来返回不同的东西，这样的话就不深究了，底层的话我撇了一下，应该原理和Activity是一样的，可能存在一些区别。这里就用Activity来谈谈它的setContentView方法做了什么事。</p>
<p>在setContentView上面有段注释：</p>
<blockquote>
<p>Set the activity content from a layout resource.  The resource will be inflated, adding all top-level views to the activity.</p>
</blockquote>
<p>这里就介绍了它的功能，它会按照一个布局资源去设置Activity的内容，而这个布局资源将会被引入然后添加所有顶级的Views到这个Activity当中。 </p>
<p>这是个啥意思勒。 </p>
<p>下面从网上扒了一张图： </p>
<p><img src="http://img.blog.csdn.net/20150604144532934" alt="这里写图片描述"> </p>
<p>这里是整个Activity的层级，最外面一层是我们的Activity，它包含里面的所有东西。 </p>
<p>再上一层是一个PhoneWindow，这个PhoneWindow是由Window类派生出来的，每一个PhoneWindow中都含有一个DecorView对象，Window是一个抽象类。 </p>
<p>再上面一层就是一个DecorView，我理解这个DecorView就是一个ViewGroup，就是装View的。 </p>
<p>而在DecoreView中，最上面的View就是我们的TitleActionBar，下面就是我们要设置的content。所以在上面的initWindowDecorActionBar就能猜到是什么意思了吧。</p>
<p>而在initWindowDecorActionBar方法中，有一段代码：</p>
<pre class="prettyprint">` <span class="hljs-javadoc">/**
     * Creates a new ActionBar, locates the inflated ActionBarView,
     * initializes the ActionBar with the view, and sets mActionBar.
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initWindowDecorActionBar</span>() {
        Window window = getWindow();

        <span class="hljs-comment">// Initializing the window decor can change window feature flags.</span>
        <span class="hljs-comment">// Make sure that we have the correct set before performing the test below.</span>
        window.getDecorView();

        <span class="hljs-keyword">if</span> (isChild() || !window.hasFeature(Window.FEATURE_ACTION_BAR) || mActionBar != <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">return</span>;
        }

        mActionBar = <span class="hljs-keyword">new</span> WindowDecorActionBar(<span class="hljs-keyword">this</span>);
        mActionBar.setDefaultDisplayHomeAsUpEnabled(mEnableDefaultActionBarUp);

        mWindow.setDefaultIcon(mActivityInfo.getIconResource());
        mWindow.setDefaultLogo(mActivityInfo.getLogoResource());
    }`</pre>

<p>注意上面的window.getDecoreView（）方法的注释，该方法会设置一些window的标志位，而当这个方法执行完之后，就再也不能更改了，这也就是为什么很多第三方SDK设置window的标志位时一定要求要在setContentView方法前调用。</p>
<h2 id="findViewById"><a href="#findViewById" class="headerlink" title="findViewById"></a>findViewById</h2><p>我们通过一个findViewById方法可以实现对象的绑定，那它底层究竟是怎么实现的呢？</p>
<p>findViewById根据继承的Activity类型的不同也存在着区别，老规矩，还是以Activity的来。</p>
<pre class="prettyprint">`<span class="hljs-javadoc">/**
     * Finds a view that was identified by the id attribute from the XML that
     * was processed in {@link #onCreate}.
     *
     *<span class="hljs-javadoctag"> @return</span> The view if found or null otherwise.
     */</span>
    <span class="hljs-annotation">@Nullable</span>
    <span class="hljs-keyword">public</span> View <span class="hljs-title">findViewById</span>(@IdRes <span class="hljs-keyword">int</span> id) {
        <span class="hljs-keyword">return</span> getWindow().findViewById(id);
    }`</pre>

<p>从源码来看，findViewById也是经过了一层层的调用，它的功能如同它上面的注释一样，通过一个view的id属性查找view，这里也可以看到一个熟悉的getWindow方法，说明findViewById()实际上Activity把它也是交给了自己的window来做</p>
<pre class="prettyprint">` <span class="hljs-javadoc">/**
     * Finds a view that was identified by the id attribute from the XML that
     * was processed in {@link android.app.Activity#onCreate}.  This will
     * implicitly call {@link #getDecorView} for you, with all of the
     * associated side-effects.
     *
     *<span class="hljs-javadoctag"> @return</span> The view if found or null otherwise.
     */</span>
    <span class="hljs-annotation">@Nullable</span>
    <span class="hljs-keyword">public</span> View <span class="hljs-title">findViewById</span>(@IdRes <span class="hljs-keyword">int</span> id) {
        <span class="hljs-keyword">return</span> getDecorView().findViewById(id);
    }`</pre>

<p>而在这里面，又调用了getDecorView的findViewById（）方法，这也相当于是一个层层传递的过程，因为DecorView我理解为就是一个ViewGroup，而当运行getDecorView().findViewById()方法时，就会运行View里面的findViewById方法。它会使用这个被给予的id匹配子View的Id，如果匹配，就返回这个View，完成View的绑定</p>
<p><pre class="prettyprint">`<span class="hljs-javadoc">/**</span></pre></p>
<pre><code> * Look for a child view with the given id.  If this view has the given
 * id, return this view.
 *
 *&lt;span class=&quot;hljs-javadoctag&quot;&gt; @param&lt;/span&gt; id The id to search for.
 *&lt;span class=&quot;hljs-javadoctag&quot;&gt; @return&lt;/span&gt; The view that has the given id in the hierarchy or null
 */&lt;/span&gt;
&lt;span class=&quot;hljs-annotation&quot;&gt;@Nullable&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; View &lt;span class=&quot;hljs-title&quot;&gt;findViewById&lt;/span&gt;(@IdRes &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; id) {
    &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (id &amp;lt; &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;) {
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;null&lt;/span&gt;;
    }
    &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; findViewTraversal(id);
}

&lt;span class=&quot;hljs-javadoc&quot;&gt;/**
 * {@hide}
 *&lt;span class=&quot;hljs-javadoctag&quot;&gt; @param&lt;/span&gt; id the id of the view to be found
 *&lt;span class=&quot;hljs-javadoctag&quot;&gt; @return&lt;/span&gt; the view of the specified id, null if cannot be found
 */&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;protected&lt;/span&gt; View &lt;span class=&quot;hljs-title&quot;&gt;findViewTraversal&lt;/span&gt;(@IdRes &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; id) {
    &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (id == mID) {
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;this&lt;/span&gt;;
    }
    &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;null&lt;/span&gt;;
}
</code></pre></li>
</ul>
<p>最后总结一下（Activity中），findViewById的过程是这样的： </p>
<p>Activity -&gt; Window -&gt; DecorView -&gt; View </p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.zhihu.com/question/39440766#answer-31119460" target="_blank" rel="external">为什么Android要采用Binder作为IPC机制？</a></li>
<li><a href="http://blog.csdn.net/zhaokaiqiang1992/article/details/49428287" target="_blank" rel="external">【凯子哥带你学Framework】Activity启动过程全解析</a></li>
<li><a href="http://gityuan.com/" target="_blank" rel="external">Gityuan</a></li>
<li>《Android开发艺术探索》</li>
<li>《Linux程序设计》</li>
<li>《Linux内核剖析》<pre><code>&lt;div&gt;
    作者：JonsTank2013 发表于2016/4/12 0:10:06 [原文链接](http://blog.csdn.net/jonstank2013/article/details/51118563)
&lt;/div&gt;
&lt;div&gt;
阅读：17713 评论：19 [查看评论](http://blog.csdn.net/jonstank2013/article/details/51118563#comments)
&lt;/div&gt;
</code></pre></li>
</ul>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/04/13/原-个人知识点总结——Java并发/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          个人知识点总结——Java并发
        
      </div>
    </a>
  
  
    <a href="/2016/03/25/原-Rxjava原理探索：切换线程，变换/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Rxjava原理探索：切换线程，变换</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_cqq">QQ好友</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_douban">豆瓣</a>

<a href="http://www.jiathis.com/share?uid=2099928" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2099928" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<div class="ds-thread" data-thread-key="原-杂谈——Android从启动到程序运行发生的事情" data-title="杂谈——Android从启动到程序运行发生的事情" data-url="http://imlzq.com/2016/04/12/原-杂谈——Android从启动到程序运行发生的事情/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"imlzq"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
		<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
		<span id="busuanzi_container_page_pv">
  			本文阅读量<span id="busuanzi_value_page_pv"></span>次
  		</span>
    		&copy; 2016 ITStudieren
    	</div>
    </div>
  </div>
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>
]]></content>
    <summary type="html">
    <![CDATA[<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>杂谈——Android从启动到程序]]>
    </summary>
    
  </entry>
  
</feed>
